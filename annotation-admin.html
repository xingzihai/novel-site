<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>æ‰¹æ³¨ç®¡ç† - æˆ‘çš„ä¹¦æ¶</title>
  <link rel="stylesheet" href="/style.css">
  <style>
    body { background: var(--bg); min-height: 100vh; }
    .anno-admin { max-width: 1000px; margin: 0 auto; padding: 20px; }
    .anno-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
    .anno-header h1 { font-size: 1.5rem; margin: 0; }
    .anno-header a { color: var(--accent); text-decoration: none; }
    
    /* ç»Ÿè®¡å¡ç‰‡ */
    .stats-row { display: flex; gap: 12px; margin-bottom: 20px; flex-wrap: wrap; }
    .stat-card {
      background: var(--card-bg);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 16px 20px;
      min-width: 100px;
      cursor: pointer;
      transition: all 0.2s;
    }
    .stat-card:hover { border-color: var(--accent); }
    .stat-card.active { border-color: var(--accent); background: rgba(99, 102, 241, 0.05); }
    .stat-card .num { font-size: 1.5rem; font-weight: 600; color: var(--text); }
    .stat-card .label { font-size: 0.85rem; color: var(--text-light); margin-top: 4px; }
    
    /* ç­›é€‰æ  */
    .filter-row {
      display: flex; gap: 10px; margin-bottom: 16px; flex-wrap: wrap; align-items: center;
      background: var(--card-bg); padding: 12px; border-radius: var(--radius); border: 1px solid var(--border);
    }
    .filter-row select, .filter-row input[type="text"] {
      padding: 6px 10px; border: 1px solid var(--border); border-radius: var(--radius);
      background: var(--bg); color: var(--text); font-size: 14px;
    }
    .filter-row input[type="text"] { flex: 1; min-width: 150px; }
    
    /* æ‰¹é‡æ“ä½œæ  */
    .batch-bar {
      display: none; background: var(--accent); color: #fff; padding: 10px 16px;
      border-radius: var(--radius); margin-bottom: 12px; align-items: center; gap: 12px;
    }
    .batch-bar.visible { display: flex; }
    .batch-bar button { background: rgba(255,255,255,0.2); border: none; color: #fff; padding: 6px 12px; border-radius: var(--radius); cursor: pointer; }
    .batch-bar button:hover { background: rgba(255,255,255,0.3); }
    
    /* æ‰¹æ³¨åˆ—è¡¨ */
    .anno-list { display: flex; flex-direction: column; gap: 12px; }
    .anno-item {
      background: var(--card-bg); border: 1px solid var(--border); border-radius: var(--radius);
      padding: 14px; transition: all 0.2s;
    }
    .anno-item:hover { border-color: var(--accent); }
    .anno-item.selected { background: rgba(99, 102, 241, 0.05); border-color: var(--accent); }
    .anno-item.removed { opacity: 0.6; }
    
    .anno-item-header { display: flex; align-items: flex-start; gap: 10px; }
    .anno-checkbox { margin-top: 2px; }
    .anno-quote {
      font-size: 13px; color: var(--text-light); border-left: 3px solid var(--accent);
      padding: 4px 10px; margin-bottom: 8px; background: var(--bg); border-radius: 0 4px 4px 0;
      max-height: 60px; overflow: hidden; line-height: 1.5;
    }
    .anno-content { font-size: 14px; line-height: 1.6; color: var(--text); margin-bottom: 10px; }
    .anno-meta {
      display: flex; flex-wrap: wrap; gap: 8px 16px; font-size: 12px; color: var(--text-light);
      align-items: center;
    }
    .anno-meta .badge {
      display: inline-block; padding: 2px 8px; border-radius: 10px; font-size: 11px;
    }
    .badge-demo { background: #fef3c7; color: #92400e; }
    .badge-admin { background: #dbeafe; color: #1e40af; }
    .badge-super { background: #fce7f3; color: #9d174d; }
    .badge-private { background: #f3f4f6; color: #6b7280; }
    .badge-reported { background: #fef2f2; color: #dc2626; }
    .badge-removed { background: #fee2e2; color: #b91c1c; }
    
    .anno-actions { display: flex; gap: 8px; margin-left: auto; }
    .anno-actions button {
      background: none; border: 1px solid var(--border); padding: 4px 10px;
      border-radius: var(--radius); font-size: 12px; cursor: pointer; color: var(--text);
    }
    .anno-actions button:hover { border-color: var(--accent); color: var(--accent); }
    .anno-actions button.danger:hover { border-color: #dc2626; color: #dc2626; }
    
    /* åˆ†é¡µ */
    .pagination {
      display: flex; justify-content: center; align-items: center; gap: 12px;
      margin-top: 20px; padding: 16px;
    }
    .pagination button {
      background: var(--card-bg); border: 1px solid var(--border); padding: 8px 16px;
      border-radius: var(--radius); cursor: pointer; color: var(--text);
    }
    .pagination button:disabled { opacity: 0.5; cursor: not-allowed; }
    .pagination button:not(:disabled):hover { border-color: var(--accent); }
    .pagination .page-info { font-size: 14px; color: var(--text-light); }
    
    /* ç©ºçŠ¶æ€ */
    .empty-state { text-align: center; padding: 60px 20px; color: var(--text-light); }
    
    /* åŠ è½½çŠ¶æ€ */
    .loading-state { text-align: center; padding: 40px; color: var(--text-light); }
    
    /* Tab åˆ‡æ¢ */
    .tab-bar { display: flex; gap: 0; margin-bottom: 16px; border-bottom: 2px solid var(--border); }
    .tab-btn {
      padding: 10px 20px; border: none; background: none; cursor: pointer;
      font-size: 14px; color: var(--text-light); border-bottom: 2px solid transparent;
      margin-bottom: -2px; transition: all 0.2s;
    }
    .tab-btn.active { color: var(--accent); border-bottom-color: var(--accent); font-weight: 500; }
    .tab-btn:hover { color: var(--text); }
    .tab-panel { display: none; }
    .tab-panel.active { display: block; }
    
    /* ä¸¾æŠ¥é¡¹ */
    .report-item {
      background: var(--card-bg); border: 1px solid var(--border); border-radius: var(--radius);
      padding: 14px; margin-bottom: 12px;
    }
    .report-item .report-reason {
      font-size: 13px; color: var(--text); background: #fef2f2; padding: 8px 12px;
      border-radius: var(--radius); margin: 8px 0; border-left: 3px solid #dc2626;
    }
    .report-actions { display: flex; gap: 8px; margin-top: 10px; }
    .report-actions button {
      padding: 6px 14px; border-radius: var(--radius); font-size: 12px; cursor: pointer; border: 1px solid var(--border);
      background: var(--card-bg); color: var(--text);
    }
    .report-actions button.btn-remove { border-color: #dc2626; color: #dc2626; }
    .report-actions button.btn-remove:hover { background: #dc2626; color: #fff; }
    .report-actions button.btn-keep { border-color: #16a34a; color: #16a34a; }
    .report-actions button.btn-keep:hover { background: #16a34a; color: #fff; }
  </style>
</head>
<body>
  <div class="anno-admin">
    <div class="anno-header">
      <h1>ğŸ“ æ‰¹æ³¨ç®¡ç†</h1>
      <div><a href="/admin.html">â† è¿”å›ç®¡ç†åå°</a> <a href="#" onclick="doLogout();return false" style="font-size:12px;color:#e74c3c;margin-left:12px">é€€å‡ºç™»å½•</a></div>
    </div>
    
    <div class="stats-row" id="stats-row">
      <div class="stat-card" data-filter="all">
        <div class="num" id="stat-total">-</div>
        <div class="label">æ€»æ•°</div>
      </div>
      <div class="stat-card" data-filter="today">
        <div class="num" id="stat-today">-</div>
        <div class="label">ä»Šæ—¥</div>
      </div>
      <div class="stat-card" data-filter="reported">
        <div class="num" id="stat-reported">-</div>
        <div class="label">è¢«ä¸¾æŠ¥</div>
      </div>
      <div class="stat-card" data-filter="removed">
        <div class="num" id="stat-removed">-</div>
        <div class="label">å·²ç§»é™¤</div>
      </div>
    </div>
    
    <div class="tab-bar">
      <button class="tab-btn active" data-tab="annotations">ğŸ“ æ‰¹æ³¨åˆ—è¡¨</button>
      <button class="tab-btn" data-tab="reports">âš ï¸ ä¸¾æŠ¥ç®¡ç†</button>
    </div>
    
    <div class="tab-panel active" id="panel-annotations">
    <div class="filter-row">
      <select id="filter-book">
        <option value="">å…¨éƒ¨ä¹¦ç±</option>
      </select>
      <select id="filter-status">
        <option value="">å…¨éƒ¨çŠ¶æ€</option>
        <option value="normal">æ­£å¸¸</option>
        <option value="reported">è¢«ä¸¾æŠ¥</option>
        <option value="removed">å·²ç§»é™¤</option>
      </select>
      <select id="filter-visibility">
        <option value="">å…¨éƒ¨ç±»å‹</option>
        <option value="public">å…¬å¼€</option>
        <option value="private">ç§æœ‰</option>
      </select>
      <input type="text" id="filter-search" placeholder="æœç´¢æ‰¹æ³¨å†…å®¹æˆ–åŸæ–‡...">
      <button class="btn btn-sm" id="btn-search">æœç´¢</button>
    </div>
    
    <div class="batch-bar" id="batch-bar">
      <span>å·²é€‰ <strong id="selected-count">0</strong> æ¡</span>
      <button id="batch-remove">æ‰¹é‡ç§»é™¤</button>
      <button id="batch-restore">æ‰¹é‡æ¢å¤</button>
      <button id="batch-cancel">å–æ¶ˆ</button>
    </div>
    
    <div class="anno-list" id="anno-list">
      <div class="loading-state">åŠ è½½ä¸­...</div>
    </div>
    
    <div class="pagination" id="pagination" style="display:none">
      <button id="btn-prev">ä¸Šä¸€é¡µ</button>
      <span class="page-info"><span id="page-current">1</span> / <span id="page-total">1</span></span>
      <button id="btn-next">ä¸‹ä¸€é¡µ</button>
    </div>
    </div><!-- end panel-annotations -->
    
    <div class="tab-panel" id="panel-reports">
      <div class="filter-row">
        <select id="report-filter-status">
          <option value="">å…¨éƒ¨çŠ¶æ€</option>
          <option value="pending">å¾…å¤„ç†</option>
          <option value="escalated">ç¤¾åŒºæŠ•ç¥¨ä¸­</option>
          <option value="resolved">å·²å¤„ç†</option>
        </select>
        <select id="report-filter-book">
          <option value="">å…¨éƒ¨ä¹¦ç±</option>
        </select>
      </div>
      <div id="report-list"><div class="loading-state">åŠ è½½ä¸­...</div></div>
      <div class="pagination" id="report-pagination" style="display:none">
        <button id="report-btn-prev">ä¸Šä¸€é¡µ</button>
        <span class="page-info"><span id="report-page-current">1</span> / <span id="report-page-total">1</span></span>
        <button id="report-btn-next">ä¸‹ä¸€é¡µ</button>
      </div>
    </div><!-- end panel-reports -->
  </div>

  <script>
    // è®¤è¯ç”±HttpOnly Cookieè‡ªåŠ¨æºå¸¦ï¼Œé¡µé¢åŠ è½½æ—¶æ£€æŸ¥ç™»å½•çŠ¶æ€
    let currentPage = 1;
    let totalPages = 1;
    let selectedIds = new Set();
    let currentRole = '';

    async function api(method, path, body) {
      const opts = {
        method,
        headers: {},
        credentials: 'same-origin'
      };
      if (body) {
        opts.headers['Content-Type'] = 'application/json';
        opts.body = JSON.stringify(body);
      }
      return fetch(path, opts);
    }

    // è·å–å½“å‰ç”¨æˆ·ä¿¡æ¯
    async function doLogout() {
      try { await fetch('/api/auth/logout', { method: 'POST', credentials: 'same-origin' }); } catch {}
      location.href = '/admin.html';
    }

    async function fetchMe() {
      const res = await api('GET', '/api/me');
      if (res.ok) {
        const data = await res.json();
        currentRole = data.role;
      } else {
        alert('è¯·å…ˆç™»å½•');
        location.href = '/admin.html';
      }
    }

    // åŠ è½½ç»Ÿè®¡
    async function loadStats() {
      const res = await api('GET', '/api/admin/annotations/stats');
      if (res.ok) {
        const data = await res.json();
        document.getElementById('stat-total').textContent = data.total;
        document.getElementById('stat-today').textContent = data.today;
        document.getElementById('stat-reported').textContent = data.reported;
        document.getElementById('stat-removed').textContent = data.removed;
      }
    }

    // åŠ è½½ä¹¦ç±åˆ—è¡¨
    async function loadBooks() {
      const res = await api('GET', '/api/admin/books');
      if (res.ok) {
        const data = await res.json();
        const select = document.getElementById('filter-book');
        (data.books || []).forEach(b => {
          const opt = document.createElement('option');
          opt.value = b.id;
          opt.textContent = b.title;
          select.appendChild(opt);
        });
      }
    }

    // åŠ è½½æ‰¹æ³¨åˆ—è¡¨
    async function loadAnnotations() {
      const bookId = document.getElementById('filter-book').value;
      const status = document.getElementById('filter-status').value;
      const visibility = document.getElementById('filter-visibility').value;
      const search = document.getElementById('filter-search').value;

      const params = new URLSearchParams({ page: currentPage, limit: 20 });
      if (bookId) params.set('bookId', bookId);
      if (status) params.set('status', status);
      if (visibility) params.set('visibility', visibility);
      if (search) params.set('search', search);

      const list = document.getElementById('anno-list');
      list.innerHTML = '<div class="loading-state">åŠ è½½ä¸­...</div>';

      const res = await api('GET', `/api/admin/annotations?${params}`);
      if (!res.ok) {
        list.innerHTML = '<div class="empty-state">åŠ è½½å¤±è´¥</div>';
        return;
      }

      const data = await res.json();
      const annos = data.annotations || [];
      totalPages = data.pagination?.totalPages || 1;

      if (annos.length === 0) {
        list.innerHTML = '<div class="empty-state">æš‚æ— æ‰¹æ³¨</div>';
        document.getElementById('pagination').style.display = 'none';
        return;
      }

      list.innerHTML = annos.map(a => renderAnnoItem(a)).join('');
      document.getElementById('pagination').style.display = 'flex';
      document.getElementById('page-current').textContent = currentPage;
      document.getElementById('page-total').textContent = totalPages;
      document.getElementById('btn-prev').disabled = currentPage <= 1;
      document.getElementById('btn-next').disabled = currentPage >= totalPages;

      bindItemEvents();
    }

    function renderAnnoItem(a) {
      const roleBadge = a.user_role === 'super_admin' ? '<span class="badge badge-super">è¶…ç®¡</span>' :
                        a.user_role === 'admin' ? '<span class="badge badge-admin">ç®¡ç†</span>' :
                        a.user_role === 'demo' ? '<span class="badge badge-demo">demo</span>' : '';
      const statusBadge = a.status === 'reported' ? '<span class="badge badge-reported">âš ï¸ä¸¾æŠ¥</span>' :
                          a.status === 'removed' ? '<span class="badge badge-removed">ğŸš«å·²ç§»é™¤</span>' : '';
      const visBadge = a.visibility === 'private' ? '<span class="badge badge-private">ğŸ”’ç§æœ‰</span>' : '';
      
      const isRemoved = a.status === 'removed';
      const canDelete = currentRole === 'super_admin' && isRemoved;

      return `
        <div class="anno-item ${isRemoved ? 'removed' : ''} ${selectedIds.has(a.id) ? 'selected' : ''}" data-id="${a.id}">
          <div class="anno-item-header">
            <input type="checkbox" class="anno-checkbox" data-id="${a.id}" ${selectedIds.has(a.id) ? 'checked' : ''}>
            <div style="flex:1">
              <div class="anno-quote">${escHtml(a.sent_text || '')}</div>
              <div class="anno-content">${escHtml(a.content)}</div>
              <div class="anno-meta">
                <span>ğŸ‘¤ ${escHtml(a.username || 'æœªçŸ¥')}</span>
                ${roleBadge}
                <span>ğŸ“– ${escHtml(a.book_title || '')} / ${escHtml(a.chapter_title || '')}</span>
                <span>ğŸ• ${timeAgo(a.created_at)}</span>
                ${visBadge}
                ${statusBadge}
                <span>â¤ï¸ ${a.like_count || 0}</span>
                <div class="anno-actions">
                  <button class="btn-context" data-book="${a.book_id}" data-chapter="${a.chapter_id}" data-para="${a.para_idx}">ä¸Šä¸‹æ–‡</button>
                  ${isRemoved ? 
                    `<button class="btn-restore" data-id="${a.id}">æ¢å¤</button>` :
                    `<button class="btn-remove" data-id="${a.id}">ç§»é™¤</button>`
                  }
                  ${canDelete ? `<button class="btn-delete danger" data-id="${a.id}">æ°¸ä¹…åˆ é™¤</button>` : ''}
                </div>
              </div>
            </div>
          </div>
        </div>
      `;
    }

    function escHtml(s) {
      return String(s).replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));
    }

    function timeAgo(dateStr) {
      if (!dateStr) return '';
      const diff = Date.now() - new Date(dateStr + 'Z').getTime();
      const m = Math.floor(diff / 60000);
      if (m < 1) return 'åˆšåˆš';
      if (m < 60) return m + 'åˆ†é’Ÿå‰';
      const h = Math.floor(m / 60);
      if (h < 24) return h + 'å°æ—¶å‰';
      const d = Math.floor(h / 24);
      if (d < 30) return d + 'å¤©å‰';
      return new Date(dateStr).toLocaleDateString('zh-CN');
    }

    function bindItemEvents() {
      // å¤é€‰æ¡†
      document.querySelectorAll('.anno-checkbox').forEach(cb => {
        cb.addEventListener('change', () => {
          const id = parseInt(cb.dataset.id);
          if (cb.checked) selectedIds.add(id);
          else selectedIds.delete(id);
          cb.closest('.anno-item').classList.toggle('selected', cb.checked);
          updateBatchBar();
        });
      });

      // ä¸Šä¸‹æ–‡æŒ‰é’®
      document.querySelectorAll('.btn-context').forEach(btn => {
        btn.addEventListener('click', () => {
          const bookId = btn.dataset.book;
          const chapterId = btn.dataset.chapter;
          const paraIdx = btn.dataset.para;
          window.open(`/read.html?id=${chapterId}#para-${paraIdx}`, '_blank');
        });
      });

      // ç§»é™¤æŒ‰é’®
      document.querySelectorAll('.btn-remove').forEach(btn => {
        btn.addEventListener('click', async () => {
          if (!confirm('ç¡®å®šç§»é™¤æ­¤æ‰¹æ³¨ï¼Ÿ')) return;
          const id = btn.dataset.id;
          const res = await api('PUT', `/api/admin/annotations/${id}`, { status: 'removed' });
          if (res.ok) loadAnnotations();
          else alert('æ“ä½œå¤±è´¥');
        });
      });

      // æ¢å¤æŒ‰é’®
      document.querySelectorAll('.btn-restore').forEach(btn => {
        btn.addEventListener('click', async () => {
          const id = btn.dataset.id;
          const res = await api('PUT', `/api/admin/annotations/${id}`, { status: 'normal' });
          if (res.ok) loadAnnotations();
          else alert('æ“ä½œå¤±è´¥');
        });
      });

      // æ°¸ä¹…åˆ é™¤æŒ‰é’®
      document.querySelectorAll('.btn-delete').forEach(btn => {
        btn.addEventListener('click', async () => {
          if (!confirm('æ°¸ä¹…åˆ é™¤åæ— æ³•æ¢å¤ï¼Œç¡®å®šï¼Ÿ')) return;
          const id = btn.dataset.id;
          const res = await api('DELETE', `/api/admin/annotations/${id}`);
          if (res.ok) { loadAnnotations(); loadStats(); }
          else alert('åˆ é™¤å¤±è´¥');
        });
      });
    }

    function updateBatchBar() {
      const bar = document.getElementById('batch-bar');
      const count = selectedIds.size;
      document.getElementById('selected-count').textContent = count;
      bar.classList.toggle('visible', count > 0);
    }

    // ç»Ÿè®¡å¡ç‰‡ç‚¹å‡»
    document.querySelectorAll('.stat-card').forEach(card => {
      card.addEventListener('click', () => {
        const filter = card.dataset.filter;
        document.querySelectorAll('.stat-card').forEach(c => c.classList.remove('active'));
        card.classList.add('active');
        
        const statusSelect = document.getElementById('filter-status');
        if (filter === 'reported') statusSelect.value = 'reported';
        else if (filter === 'removed') statusSelect.value = 'removed';
        else statusSelect.value = '';
        
        currentPage = 1;
        loadAnnotations();
      });
    });

    // ç­›é€‰
    document.getElementById('btn-search').addEventListener('click', () => {
      currentPage = 1;
      loadAnnotations();
    });
    document.getElementById('filter-search').addEventListener('keydown', e => {
      if (e.key === 'Enter') { currentPage = 1; loadAnnotations(); }
    });
    ['filter-book', 'filter-status', 'filter-visibility'].forEach(id => {
      document.getElementById(id).addEventListener('change', () => {
        currentPage = 1;
        loadAnnotations();
      });
    });

    // åˆ†é¡µ
    document.getElementById('btn-prev').addEventListener('click', () => {
      if (currentPage > 1) { currentPage--; loadAnnotations(); }
    });
    document.getElementById('btn-next').addEventListener('click', () => {
      if (currentPage < totalPages) { currentPage++; loadAnnotations(); }
    });

    // æ‰¹é‡æ“ä½œ
    document.getElementById('batch-remove').addEventListener('click', async () => {
      if (!confirm(`ç¡®å®šç§»é™¤é€‰ä¸­çš„ ${selectedIds.size} æ¡æ‰¹æ³¨ï¼Ÿ`)) return;
      const res = await api('POST', '/api/admin/annotations/batch', { ids: [...selectedIds], action: 'remove' });
      if (res.ok) { selectedIds.clear(); updateBatchBar(); loadAnnotations(); loadStats(); }
      else alert('æ“ä½œå¤±è´¥');
    });
    document.getElementById('batch-restore').addEventListener('click', async () => {
      const res = await api('POST', '/api/admin/annotations/batch', { ids: [...selectedIds], action: 'restore' });
      if (res.ok) { selectedIds.clear(); updateBatchBar(); loadAnnotations(); loadStats(); }
      else alert('æ“ä½œå¤±è´¥');
    });
    document.getElementById('batch-cancel').addEventListener('click', () => {
      selectedIds.clear();
      document.querySelectorAll('.anno-checkbox').forEach(cb => cb.checked = false);
      document.querySelectorAll('.anno-item').forEach(item => item.classList.remove('selected'));
      updateBatchBar();
    });

    // Tab åˆ‡æ¢
    document.querySelectorAll('.tab-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        document.querySelectorAll('.tab-panel').forEach(p => p.classList.remove('active'));
        btn.classList.add('active');
        document.getElementById('panel-' + btn.dataset.tab).classList.add('active');
        if (btn.dataset.tab === 'reports' && !reportsLoaded) {
          loadReports();
          reportsLoaded = true;
        }
      });
    });

    // --- ä¸¾æŠ¥ç®¡ç† ---
    let reportPage = 1;
    let reportTotalPages = 1;
    let reportsLoaded = false;

    async function loadReports() {
      const status = document.getElementById('report-filter-status').value;
      const bookId = document.getElementById('report-filter-book').value;
      const params = new URLSearchParams({ page: reportPage, limit: 20 });
      if (status) params.set('status', status);
      if (bookId) params.set('bookId', bookId);

      const list = document.getElementById('report-list');
      list.innerHTML = '<div class="loading-state">åŠ è½½ä¸­...</div>';

      const res = await api('GET', `/api/admin/reports?${params}`);
      if (!res.ok) { list.innerHTML = '<div class="empty-state">åŠ è½½å¤±è´¥</div>'; return; }

      const data = await res.json();
      const reports = data.reports || [];
      reportTotalPages = data.pagination?.totalPages || 1;

      if (reports.length === 0) {
        list.innerHTML = '<div class="empty-state">æš‚æ— ä¸¾æŠ¥</div>';
        document.getElementById('report-pagination').style.display = 'none';
        return;
      }

      list.innerHTML = reports.map(r => renderReportItem(r)).join('');
      document.getElementById('report-pagination').style.display = 'flex';
      document.getElementById('report-page-current').textContent = reportPage;
      document.getElementById('report-page-total').textContent = reportTotalPages;
      document.getElementById('report-btn-prev').disabled = reportPage <= 1;
      document.getElementById('report-btn-next').disabled = reportPage >= reportTotalPages;
      bindReportEvents();
    }

    function renderReportItem(r) {
      const statusMap = {
        'pending': '<span class="badge badge-reported">å¾…å¤„ç†</span>',
        'escalated': '<span class="badge" style="background:#fef3c7;color:#92400e">æŠ•ç¥¨ä¸­</span>',
        'resolved': '<span class="badge" style="background:#dcfce7;color:#15803d">å·²å¤„ç†</span>'
      };
      const roleBadge = r.anno_user_role === 'super_admin' ? '<span class="badge badge-super">è¶…ç®¡</span>' :
                        r.anno_user_role === 'admin' ? '<span class="badge badge-admin">ç®¡ç†</span>' :
                        r.anno_user_role === 'demo' ? '<span class="badge badge-demo">demo</span>' : '';
      const isPending = r.status === 'pending' || r.status === 'escalated';

      return `
        <div class="report-item" data-id="${r.id}">
          <div class="anno-quote">${escHtml(r.sent_text || '')}</div>
          <div class="anno-content">${escHtml(r.anno_content || '')}</div>
          <div class="anno-meta">
            <span>æ‰¹æ³¨ä½œè€…: ${escHtml(r.anno_username || 'æœªçŸ¥')}</span> ${roleBadge}
            <span>ğŸ“– ${escHtml(r.book_title || '')} / ${escHtml(r.chapter_title || '')}</span>
            ${statusMap[r.status] || ''}
            <span>ä¸¾æŠ¥æ•°: ${r.report_count || 1}</span>
          </div>
          <div class="report-reason">ä¸¾æŠ¥ç†ç”±: ${escHtml(r.reason)}</div>
          <div class="anno-meta">
            <span>ä¸¾æŠ¥äºº: ${escHtml(r.reporter_username || 'æ¸¸å®¢')}</span>
            <span>ğŸ• ${timeAgo(r.created_at)}</span>
            ${r.handler_action ? `<span>å¤„ç†ç»“æœ: ${r.handler_action === 'remove' ? 'ç§»é™¤' : 'ä¿ç•™'}</span>` : ''}
          </div>
          ${isPending ? `
          <div class="report-actions">
            <button class="btn-remove" data-id="${r.id}">ç§»é™¤æ‰¹æ³¨</button>
            <button class="btn-keep" data-id="${r.id}">ä¿ç•™æ‰¹æ³¨</button>
          </div>` : ''}
        </div>
      `;
    }

    function bindReportEvents() {
      document.querySelectorAll('.report-actions .btn-remove').forEach(btn => {
        btn.addEventListener('click', async () => {
          if (!confirm('ç¡®å®šç§»é™¤è¯¥æ‰¹æ³¨ï¼Ÿ')) return;
          const res = await api('PATCH', `/api/admin/reports/${btn.dataset.id}`, { action: 'remove' });
          if (res.ok) { loadReports(); loadStats(); }
          else alert('æ“ä½œå¤±è´¥');
        });
      });
      document.querySelectorAll('.report-actions .btn-keep').forEach(btn => {
        btn.addEventListener('click', async () => {
          if (!confirm('ç¡®å®šä¿ç•™è¯¥æ‰¹æ³¨ï¼Ÿ')) return;
          const res = await api('PATCH', `/api/admin/reports/${btn.dataset.id}`, { action: 'keep' });
          if (res.ok) { loadReports(); loadStats(); }
          else alert('æ“ä½œå¤±è´¥');
        });
      });
    }

    // ä¸¾æŠ¥ç­›é€‰
    ['report-filter-status', 'report-filter-book'].forEach(id => {
      document.getElementById(id).addEventListener('change', () => { reportPage = 1; loadReports(); });
    });
    document.getElementById('report-btn-prev').addEventListener('click', () => {
      if (reportPage > 1) { reportPage--; loadReports(); }
    });
    document.getElementById('report-btn-next').addEventListener('click', () => {
      if (reportPage < reportTotalPages) { reportPage++; loadReports(); }
    });

    // åˆå§‹åŒ–
    (async () => {
      await fetchMe();
      await Promise.all([loadStats(), loadBooks()]);
      await loadAnnotations();
      // å¤åˆ¶ä¹¦ç±é€‰é¡¹åˆ°ä¸¾æŠ¥ç­›é€‰
      const reportBookSelect = document.getElementById('report-filter-book');
      document.querySelectorAll('#filter-book option').forEach(opt => {
        if (opt.value) reportBookSelect.appendChild(opt.cloneNode(true));
      });
    })();
  </script>
</body>
</html>
