<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>é˜…è¯» - æˆ‘çš„ä¹¦æ¶</title>
  <meta name="description" content="">
  <link rel="stylesheet" href="/style.css">
  <link rel="manifest" href="/manifest.json">
  <meta name="theme-color" content="#d4a574">
</head>
<body>
  <div class="progress-bar" id="progress-bar"></div>
  <div class="navbar">
    <h1><a href="/">ğŸ“š æˆ‘çš„ä¹¦æ¶</a></h1>
    <nav>
      <a href="#" id="back-link">è¿”å›ç›®å½•</a>
    </nav>
  </div>
  <div class="reader" id="reader-area">
    <div class="breadcrumb" id="breadcrumb"></div>
    <div id="content" class="loading">åŠ è½½ä¸­...</div>
  </div>

  <!-- åº•éƒ¨å·¥å…·æ  -->
  <div class="reader-bottom-bar" id="bottom-bar">
    <button class="bar-btn" id="bar-prev" title="ä¸Šä¸€ç« "><span class="bar-icon">â—€</span>ä¸Šä¸€ç« </button>
    <button class="bar-btn" id="bar-toc" title="ç›®å½•"><span class="bar-icon">â˜°</span>ç›®å½•</button>
    <button class="bar-btn" id="bar-bookmark" title="ä¹¦ç­¾"><span class="bar-icon" id="bookmark-icon">â˜†</span>ä¹¦ç­¾</button>
    <button class="bar-btn" id="bar-settings" title="è®¾ç½®"><span class="bar-icon">âš™</span>è®¾ç½®</button>
    <button class="bar-btn" id="bar-annotations" title="æ‰¹æ³¨"><span class="bar-icon">ğŸ“</span>æ‰¹æ³¨</button>
    <button class="bar-btn" id="bar-immersive" title="æ²‰æµ¸æ¨¡å¼"><span class="bar-icon">ğŸ”²</span>æ²‰æµ¸</button>
    <button class="bar-btn" id="bar-next" title="ä¸‹ä¸€ç« "><span class="bar-icon">â–¶</span>ä¸‹ä¸€ç« </button>
  </div>

  <!-- ç« èŠ‚ç›®å½•æµ®å±‚ -->
  <div class="toc-overlay" id="toc-overlay">
    <div class="toc-panel">
      <h3 id="toc-title">ç›®å½•</h3>
      <ul class="toc-list" id="toc-list"></ul>
    </div>
  </div>

  <!-- è®¾ç½®é¢æ¿ -->
  <div class="settings-overlay" id="settings-overlay">
    <div class="settings-panel">
      <h3>é˜…è¯»è®¾ç½®<button class="close-btn" id="close-settings">âœ•</button></h3>
      <div class="setting-row">
        <span class="setting-label">ä¸»é¢˜</span>
        <div class="theme-options" id="theme-options">
          <div class="theme-dot" data-theme="light" title="é»˜è®¤"></div>
          <div class="theme-dot" data-theme="dark" title="å¤œé—´"></div>
          <div class="theme-dot" data-theme="green" title="æŠ¤çœ¼"></div>
          <div class="theme-dot" data-theme="sepia" title="ç¾Šçš®çº¸"></div>
          <div class="theme-dot" data-theme="blue" title="æ·¡è“"></div>
        </div>
      </div>
      <div class="setting-row">
        <span class="setting-label">å­—ä½“</span>
        <div class="font-options" id="font-options">
          <div class="font-option" data-font="'Georgia','Noto Serif SC','Source Han Serif CN',serif" style="font-family:Georgia,serif">å®‹ä½“/è¡¬çº¿</div>
          <div class="font-option" data-font="'PingFang SC','Microsoft YaHei','Noto Sans SC',sans-serif" style="font-family:sans-serif">é»‘ä½“/æ— è¡¬çº¿</div>
          <div class="font-option" data-font="'KaiTi','STKaiti','AR PL UKai CN',serif" style="font-family:KaiTi,STKaiti,serif">æ¥·ä½“</div>
          <div class="font-option" data-font="'FangSong','STFangsong',serif" style="font-family:FangSong,STFangsong,serif">ä»¿å®‹</div>
        </div>
      </div>
      <div class="setting-row">
        <span class="setting-label">å­—å·</span>
        <div class="slider-row">
          <span style="font-size:12px">A</span>
          <input type="range" id="font-size-slider" min="14" max="28" step="1">
          <span style="font-size:20px">A</span>
          <span class="slider-val" id="font-size-val">17px</span>
        </div>
      </div>
      <div class="setting-row">
        <span class="setting-label">è¡Œè·</span>
        <div class="slider-row">
          <span style="font-size:12px">ç´§</span>
          <input type="range" id="line-height-slider" min="1.5" max="3" step="0.1">
          <span style="font-size:12px">æ¾</span>
          <span class="slider-val" id="line-height-val">2.0</span>
        </div>
      </div>
      <div class="setting-row">
        <span class="setting-label">é¡µé¢å®½åº¦</span>
        <div class="slider-row">
          <span style="font-size:12px">çª„</span>
          <input type="range" id="width-slider" min="500" max="960" step="20">
          <span style="font-size:12px">å®½</span>
          <span class="slider-val" id="width-val">720px</span>
        </div>
      </div>
      <div class="setting-row">
        <span class="setting-label">é˜…è¯»æ¨¡å¼</span>
        <div class="mode-options" id="mode-options">
          <div class="mode-option" data-mode="scroll">ğŸ“œ æ»šåŠ¨</div>
          <div class="mode-option" data-mode="pager">ğŸ“– ç¿»é¡µ</div>
        </div>
      </div>
    </div>
  </div>

  <button class="back-to-top has-bar" id="back-top" onclick="window.scrollTo({top:0,behavior:'smooth'})">â†‘</button>

  <!-- ç¿»é¡µæ¨¡å¼ï¼šç‚¹å‡»åŒºåŸŸ + é¡µç  -->
  <div class="pager-tap-left" id="pager-tap-left" style="display:none"></div>
  <div class="pager-tap-right" id="pager-tap-right" style="display:none"></div>
  <div class="pager-indicator" id="pager-indicator"></div>
  <div class="immersive-hint" id="immersive-hint">ç‚¹å‡»ä¸­å¤®æˆ–æŒ‰ Esc é€€å‡ºæ²‰æµ¸æ¨¡å¼</div>

  <!-- æ‰¹æ³¨æµ®åŠ¨å·¥å…·æ  -->
  <div class="annotation-toolbar" id="annotation-toolbar">
    <div class="toolbar-colors">
      <span style="font-size:13px;color:var(--text-light)">é«˜äº®ï¼š</span>
      <div class="color-dot active" data-color="#FFD700" style="background:#FFD700" title="é‡‘è‰²"></div>
      <div class="color-dot" data-color="#FF6B6B" style="background:#FF6B6B" title="çº¢è‰²"></div>
      <div class="color-dot" data-color="#4ECDC4" style="background:#4ECDC4" title="é’è‰²"></div>
      <div class="color-dot" data-color="#45B7D1" style="background:#45B7D1" title="è“è‰²"></div>
      <div class="color-dot" data-color="#96CEB4" style="background:#96CEB4" title="ç»¿è‰²"></div>
    </div>
    <div class="toolbar-note">
      <textarea id="annotation-note-input" placeholder="æ·»åŠ æ‰¹æ³¨ï¼ˆå¯é€‰ï¼‰" rows="2"></textarea>
    </div>
    <div class="toolbar-actions">
      <button class="btn-cancel-annotation" id="annotation-cancel">å–æ¶ˆ</button>
      <button class="btn-save-annotation" id="annotation-save">ä¿å­˜</button>
    </div>
  </div>

  <!-- æ‰¹æ³¨æ°”æ³¡ -->
  <div class="annotation-tooltip" id="annotation-tooltip">
    <div class="tooltip-text" id="tooltip-text"></div>
    <div class="tooltip-note" id="tooltip-note"></div>
    <div class="tooltip-meta" id="tooltip-meta"></div>
  </div>

  <!-- æ‰¹æ³¨ä¾§è¾¹é¢æ¿ -->
  <div class="annotation-panel-overlay" id="annotation-panel-overlay">
    <div class="annotation-panel" id="annotation-panel">
      <h3>
        <span>ğŸ“ æ‰¹æ³¨ (<span id="annotation-count">0</span>)</span>
        <button class="close-panel-btn" id="close-annotation-panel">âœ•</button>
      </h3>
      <div id="annotation-list"></div>
    </div>
  </div>

  <script>
    // ===== é˜…è¯»è®¾ç½®åˆå§‹åŒ– =====
    let immersiveActive = false; // æ²‰æµ¸æ¨¡å¼çŠ¶æ€ï¼ˆæå‰å£°æ˜ä¾›å…¶ä»–handlerä½¿ç”¨ï¼‰
    const THEMES = ['light','dark','green','sepia','blue'];
    const FONTS = [
      "'Georgia','Noto Serif SC','Source Han Serif CN',serif",
      "'PingFang SC','Microsoft YaHei','Noto Sans SC',sans-serif",
      "'KaiTi','STKaiti','AR PL UKai CN',serif",
      "'FangSong','STFangsong',serif"
    ];

    function loadSettings() {
      let readingMode = 'scroll';
      try { readingMode = localStorage.getItem('reading-mode') || 'scroll'; } catch {}
      return {
        theme: localStorage.getItem('theme') || 'light',
        fontSize: parseInt(localStorage.getItem('font-size')) || 17,
        lineHeight: parseFloat(localStorage.getItem('line-height')) || 2,
        fontFamily: localStorage.getItem('font-family') || FONTS[0],
        readingWidth: parseInt(localStorage.getItem('reading-width')) || 720,
        readingMode: readingMode
      };
    }

    let settings = loadSettings();

    // ===== ç¿»é¡µæ¨¡å¼å˜é‡ï¼ˆéœ€åœ¨ applyAllSettings ä¹‹å‰å£°æ˜ï¼‰=====
    let pagerState = { currentPage: 0, totalPages: 1, columnWidth: 0 };
    const pagerTapLeft = document.getElementById('pager-tap-left');
    const pagerTapRight = document.getElementById('pager-tap-right');
    const pagerIndicator = document.getElementById('pager-indicator');

    applyAllSettings();

    function applyAllSettings() {
      const root = document.documentElement;
      root.setAttribute('data-theme', settings.theme);
      root.style.setProperty('--font-size', settings.fontSize + 'px');
      root.style.setProperty('--line-height', settings.lineHeight);
      root.style.setProperty('--letter-spacing', '0.02em');
      root.style.setProperty('--font-family', settings.fontFamily);
      root.style.setProperty('--reading-width', settings.readingWidth + 'px');
      applyReadingMode();
    }

    function saveSetting(key, val) {
      localStorage.setItem(key, val);
    }

    // ===== è®¾ç½®é¢æ¿äº¤äº’ =====
    const settingsOverlay = document.getElementById('settings-overlay');
    const tocOverlay = document.getElementById('toc-overlay');

    // ä¸»é¢˜é€‰æ‹©
    document.getElementById('theme-options').addEventListener('click', (e) => {
      const dot = e.target.closest('.theme-dot');
      if (!dot) return;
      settings.theme = dot.dataset.theme;
      saveSetting('theme', settings.theme);
      applyAllSettings();
      updateSettingsUI();
    });

    // å­—ä½“é€‰æ‹©
    document.getElementById('font-options').addEventListener('click', (e) => {
      const opt = e.target.closest('.font-option');
      if (!opt) return;
      settings.fontFamily = opt.dataset.font;
      saveSetting('font-family', settings.fontFamily);
      applyAllSettings();
      updateSettingsUI();
      // å­—ä½“å˜åŒ–åéœ€è¦ç­‰æ¸²æŸ“å†é‡æ–°åˆ†é¡µ
      if (settings.readingMode === 'pager') {
        requestAnimationFrame(() => { requestAnimationFrame(() => { pagerRecalc(); }); });
      }
    });

    // é˜²æŠ–å·¥å…·å‡½æ•°ï¼ˆç¿»é¡µæ¨¡å¼æ»‘å—ç”¨ï¼‰
    let _pagerDebounceTimer = null;
    function debouncedPagerRecalc() {
      if (_pagerDebounceTimer) clearTimeout(_pagerDebounceTimer);
      _pagerDebounceTimer = setTimeout(pagerRecalc, 100);
    }

    // å­—å·æ»‘å—
    document.getElementById('font-size-slider').addEventListener('input', (e) => {
      settings.fontSize = parseInt(e.target.value);
      saveSetting('font-size', settings.fontSize);
      document.getElementById('font-size-val').textContent = settings.fontSize + 'px';
      applyAllSettings();
      if (settings.readingMode === 'pager') debouncedPagerRecalc();
    });

    // è¡Œè·æ»‘å—
    document.getElementById('line-height-slider').addEventListener('input', (e) => {
      settings.lineHeight = parseFloat(e.target.value);
      saveSetting('line-height', settings.lineHeight);
      document.getElementById('line-height-val').textContent = settings.lineHeight.toFixed(1);
      applyAllSettings();
      if (settings.readingMode === 'pager') debouncedPagerRecalc();
    });

    // é¡µé¢å®½åº¦æ»‘å—
    document.getElementById('width-slider').addEventListener('input', (e) => {
      settings.readingWidth = parseInt(e.target.value);
      saveSetting('reading-width', settings.readingWidth);
      document.getElementById('width-val').textContent = settings.readingWidth + 'px';
      applyAllSettings();
      if (settings.readingMode === 'pager') debouncedPagerRecalc();
    });

    // é˜…è¯»æ¨¡å¼åˆ‡æ¢
    document.getElementById('mode-options').addEventListener('click', (e) => {
      const opt = e.target.closest('.mode-option');
      if (!opt) return;
      const newMode = opt.dataset.mode;
      if (newMode === settings.readingMode) return;
      settings.readingMode = newMode;
      saveSetting('reading-mode', newMode);
      applyAllSettings();
      updateSettingsUI();
    });

    function updateSettingsUI() {
      document.querySelectorAll('.theme-dot').forEach(d => {
        d.classList.toggle('active', d.dataset.theme === settings.theme);
      });
      document.querySelectorAll('.font-option').forEach(o => {
        o.classList.toggle('active', o.dataset.font === settings.fontFamily);
      });
      document.getElementById('font-size-slider').value = settings.fontSize;
      document.getElementById('font-size-val').textContent = settings.fontSize + 'px';
      document.getElementById('line-height-slider').value = settings.lineHeight;
      document.getElementById('line-height-val').textContent = settings.lineHeight.toFixed(1);
      document.getElementById('width-slider').value = settings.readingWidth;
      document.getElementById('width-val').textContent = settings.readingWidth + 'px';
      document.querySelectorAll('.mode-option').forEach(o => {
        o.classList.toggle('active', o.dataset.mode === settings.readingMode);
      });
    }

    // æ‰“å¼€/å…³é—­è®¾ç½®
    document.getElementById('bar-settings').addEventListener('click', () => {
      updateSettingsUI();
      settingsOverlay.classList.add('active');
    });
    document.getElementById('close-settings').addEventListener('click', () => {
      settingsOverlay.classList.remove('active');
    });
    settingsOverlay.addEventListener('click', (e) => {
      if (e.target === settingsOverlay) settingsOverlay.classList.remove('active');
    });

    // æ‰“å¼€/å…³é—­ç›®å½•
    document.getElementById('bar-toc').addEventListener('click', () => {
      tocOverlay.classList.add('active');
      // æ»šåŠ¨åˆ°å½“å‰ç« èŠ‚
      const cur = document.querySelector('.toc-list a.current');
      if (cur) cur.scrollIntoView({ block: 'center' });
    });
    tocOverlay.addEventListener('click', (e) => {
      if (e.target === tocOverlay) tocOverlay.classList.remove('active');
    });

    // ===== ç¿»é¡µæ¨¡å¼å¼•æ“ =====

    function applyReadingMode() {
      const isPager = settings.readingMode === 'pager';
      document.body.classList.toggle('pager-mode', isPager);
      pagerTapLeft.style.display = isPager ? 'block' : 'none';
      pagerTapRight.style.display = isPager ? 'block' : 'none';
      if (isPager) {
        pagerRecalc();
      } else {
        // åˆ‡å›æ»šåŠ¨æ¨¡å¼ï¼šæ¸…é™¤columnæ ·å¼å’Œtransform
        const content = document.querySelector('.reader-content');
        if (content) {
          // è®°ä½å½“å‰é˜…è¯»æ¯”ä¾‹
          const ratio = pagerState.totalPages > 1 ? pagerState.currentPage / (pagerState.totalPages - 1) : 0;
          content.style.transition = 'none';
          content.style.transform = '';
          content.style.height = '';
          content.style.columnWidth = '';
          content.style.columnGap = '';
          content.offsetHeight; // force reflow
          content.style.transition = '';
          // æ¢å¤æ»šåŠ¨ä½ç½®
          if (ratio > 0) {
            requestAnimationFrame(() => {
              const h = document.documentElement.scrollHeight - window.innerHeight;
              if (h > 0) window.scrollTo(0, h * ratio);
            });
          }
        }
        pagerIndicator.style.display = 'none';
      }
    }

    function pagerRecalc() {
      if (settings.readingMode !== 'pager') return;
      const content = document.querySelector('.reader-content');
      if (!content) return;
      // ä¿å­˜å½“å‰é˜…è¯»æ¯”ä¾‹
      const oldRatio = pagerState.totalPages > 1 ? pagerState.currentPage / (pagerState.totalPages - 1) : 0;
      // è·å–å®¹å™¨å¯ç”¨é«˜åº¦
      const reader = document.getElementById('reader-area');
      const readerRect = reader.getBoundingClientRect();
      const titleEl = reader.querySelector('h2');
      const titleH = titleEl ? titleEl.offsetHeight + 16 : 0;
      const availH = readerRect.height - titleH;
      if (availH <= 0) return;
      const colW = readerRect.width;
      pagerState.columnWidth = colW;
      // æ‰¹é‡è®¾ç½®æ ·å¼ï¼Œåªè§¦å‘ä¸€æ¬¡ reflow
      content.style.transition = 'none';
      content.style.transform = 'translateX(0)';
      content.style.height = availH + 'px';
      content.style.columnWidth = colW + 'px';
      content.style.columnGap = colW + 'px';
      // å•æ¬¡å¼ºåˆ¶ reflow è·å– scrollWidth
      const scrollW = content.scrollWidth;
      if (scrollW <= colW) {
        pagerState.totalPages = 1;
      } else {
        pagerState.totalPages = Math.round((scrollW / colW + 1) / 2);
      }
      pagerState.totalPages = Math.max(1, pagerState.totalPages);
      // æ¢å¤åˆ°ç›¸è¿‘çš„é¡µç 
      if (pagerState.totalPages > 1) {
        pagerState.currentPage = Math.min(Math.round(oldRatio * (pagerState.totalPages - 1)), pagerState.totalPages - 1);
      } else {
        pagerState.currentPage = 0;
      }
      pagerState.currentPage = Math.max(0, pagerState.currentPage);
      pagerGoTo(pagerState.currentPage, false);
    }

    function pagerGoTo(page, animate) {
      const content = document.querySelector('.reader-content');
      if (!content) return;
      page = Math.max(0, Math.min(page, pagerState.totalPages - 1));
      pagerState.currentPage = page;
      const offset = page * pagerState.columnWidth * 2;
      if (animate === false) {
        content.style.transition = 'none';
      } else {
        content.style.transition = 'transform 0.35s cubic-bezier(0.25, 0.46, 0.45, 0.94)';
      }
      content.style.transform = 'translateX(-' + offset + 'px)';
      if (animate === false) {
        // force reflow then restore transition
        content.offsetHeight;
        content.style.transition = '';
      }
      pagerUpdateIndicator();
      // ä¿å­˜è¿›åº¦ï¼ˆç”¨é¡µç æ¯”ä¾‹æ¨¡æ‹ŸscrollPctï¼‰
      if (window._chapterMeta) {
        const m = window._chapterMeta;
        const pct = pagerState.totalPages > 1 ? page / (pagerState.totalPages - 1) : 0;
        try {
          const progress = {
            chapterId: m.chapterId, chapterTitle: m.chapterTitle,
            bookTitle: m.bookTitle, bookId: m.bookId,
            scrollPct: pct, time: Date.now()
          };
          localStorage.setItem('reading_' + m.bookId, JSON.stringify(progress));
        } catch {}
      }
    }

    function pagerUpdateIndicator() {
      pagerIndicator.textContent = (pagerState.currentPage + 1) + ' / ' + pagerState.totalPages;
    }

    function pagerNext() {
      if (pagerState.currentPage < pagerState.totalPages - 1) {
        pagerGoTo(pagerState.currentPage + 1, true);
      } else if (nextUrl) {
        location.href = nextUrl;
      }
    }

    function pagerPrev() {
      if (pagerState.currentPage > 0) {
        pagerGoTo(pagerState.currentPage - 1, true);
      } else if (prevUrl) {
        location.href = prevUrl;
      }
    }

    // ç¿»é¡µç‚¹å‡»åŒºåŸŸ
    pagerTapLeft.addEventListener('click', (e) => { e.stopPropagation(); pagerPrev(); });
    pagerTapRight.addEventListener('click', (e) => { e.stopPropagation(); pagerNext(); });

    // è§¦æ‘¸æ»‘åŠ¨ç¿»é¡µ
    let touchStartX = 0, touchStartY = 0, touchStartTime = 0;
    document.addEventListener('touchstart', (e) => {
      if (settings.readingMode !== 'pager') return;
      if (e.target.closest('.settings-panel') || e.target.closest('.toc-panel') || e.target.closest('.reader-bottom-bar')) return;
      touchStartX = e.touches[0].clientX;
      touchStartY = e.touches[0].clientY;
      touchStartTime = Date.now();
    }, { passive: true });

    document.addEventListener('touchend', (e) => {
      if (settings.readingMode !== 'pager') return;
      if (e.target.closest('.settings-panel') || e.target.closest('.toc-panel') || e.target.closest('.reader-bottom-bar')) return;
      const dx = e.changedTouches[0].clientX - touchStartX;
      const dy = e.changedTouches[0].clientY - touchStartY;
      const dt = Date.now() - touchStartTime;
      // æ°´å¹³æ»‘åŠ¨è·ç¦»>50pxï¼Œä¸”æ°´å¹³>å‚ç›´ï¼Œä¸”æ—¶é—´<500ms
      if (Math.abs(dx) > 50 && Math.abs(dx) > Math.abs(dy) && dt < 500) {
        if (dx < 0) pagerNext();
        else pagerPrev();
      }
    }, { passive: true });

    // resizeæ—¶é‡æ–°è®¡ç®—
    let resizeTimer = null;
    window.addEventListener('resize', () => {
      if (settings.readingMode !== 'pager') return;
      if (resizeTimer) clearTimeout(resizeTimer);
      resizeTimer = setTimeout(pagerRecalc, 200);
    });

    // ===== åº•éƒ¨å·¥å…·æ æ˜¾ç¤º/éšè— =====
    const bottomBar = document.getElementById('bottom-bar');
    let barVisible = true;
    bottomBar.classList.add('visible');

    document.getElementById('reader-area').addEventListener('click', (e) => {
      if (immersiveActive) return; // æ²‰æµ¸æ¨¡å¼ä¸‹ç”±ä¸“é—¨çš„handlerå¤„ç†
      if (e.target.closest('a') || e.target.closest('button') || e.target.closest('.reader-nav')) return;
      // ç¿»é¡µæ¨¡å¼ä¸‹ï¼Œä¸­é—´åŒºåŸŸç‚¹å‡»åˆ‡æ¢å·¥å…·æ ï¼ˆå·¦å³åŒºåŸŸç”±tap zoneå¤„ç†ï¼‰
      if (settings.readingMode === 'pager') {
        const x = e.clientX;
        const w = window.innerWidth;
        if (x < w * 0.35 || x > w * 0.65) return; // å·¦å³åŒºåŸŸä¸å¤„ç†
      }
      barVisible = !barVisible;
      bottomBar.classList.toggle('visible', barVisible);
    });

    // ===== è¿›åº¦æ¡ + æ»šåŠ¨ä½ç½®è®°å¿† =====
    let scrollSaveTimer = null;
    window.addEventListener('scroll', () => {
      if (settings.readingMode === 'pager') return;
      const h = document.documentElement.scrollHeight - window.innerHeight;
      const pct = h > 0 ? (window.scrollY / h * 100) : 0;
      document.getElementById('progress-bar').style.width = pct + '%';
      document.getElementById('back-top').classList.toggle('visible', window.scrollY > 400);

      // èŠ‚æµä¿å­˜æ»šåŠ¨ä½ç½®
      if (scrollSaveTimer) clearTimeout(scrollSaveTimer);
      scrollSaveTimer = setTimeout(saveScrollPosition, 1000);
    });

    function saveScrollPosition() {
      if (!window._chapterMeta) return;
      if (settings.readingMode === 'pager') return; // pageræ¨¡å¼åœ¨pagerGoToä¸­ä¿å­˜
      const m = window._chapterMeta;
      const h = document.documentElement.scrollHeight - window.innerHeight;
      const pct = h > 0 ? (window.scrollY / h) : 0;
      const progress = {
        chapterId: m.chapterId, chapterTitle: m.chapterTitle,
        bookTitle: m.bookTitle, bookId: m.bookId,
        scrollPct: pct, time: Date.now()
      };
      localStorage.setItem(`reading_${m.bookId}`, JSON.stringify(progress));
    }

    // ===== é”®ç›˜å¿«æ·é”® =====
    let prevUrl = null, nextUrl = null, backUrl = null;
    document.addEventListener('keydown', (e) => {
      if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') return;
      if (e.key === 'ArrowLeft') {
        if (settings.readingMode === 'pager') pagerPrev();
        else if (prevUrl) location.href = prevUrl;
        return;
      }
      if (e.key === 'ArrowRight') {
        if (settings.readingMode === 'pager') pagerNext();
        else if (nextUrl) location.href = nextUrl;
        return;
      }
      if (e.key === 'Escape') {
        if (immersiveActive) { exitImmersive(); return; }
        if (document.fullscreenElement) { document.exitFullscreen(); return; }
        if (document.getElementById('annotation-panel-overlay')?.classList.contains('active')) { document.getElementById('annotation-panel-overlay').classList.remove('active'); return; }
        const _aToolbar = document.getElementById('annotation-toolbar');
        if (_aToolbar?.classList.contains('visible')) { _aToolbar.classList.remove('visible'); return; }
        if (settingsOverlay.classList.contains('active')) settingsOverlay.classList.remove('active');
        else if (tocOverlay.classList.contains('active')) tocOverlay.classList.remove('active');
        else if (backUrl) location.href = backUrl;
      }
      if (e.key === 'i' || e.key === 'I') {
        toggleImmersive();
        return;
      }
      if (e.key === 't' || e.key === 'T') {
        const idx = THEMES.indexOf(settings.theme);
        settings.theme = THEMES[(idx + 1) % THEMES.length];
        saveSetting('theme', settings.theme);
        applyAllSettings(); updateSettingsUI();
      }
      if (e.key === 'f' || e.key === 'F') {
        if (document.fullscreenElement) document.exitFullscreen();
        else document.documentElement.requestFullscreen().catch(() => {});
      }
      if (e.key === 's' || e.key === 'S') {
        settingsOverlay.classList.toggle('active');
      }
    });

    // ===== åŠ è½½ç«™ç‚¹è®¾ç½® =====
    fetch('/api/settings').then(r => r.json()).then(d => {
      const s = d.settings || {};
      if (s.site_name) document.querySelector('.navbar h1 a').textContent = 'ğŸ“š ' + s.site_name;
    }).catch(() => {});

    // ===== åŠ è½½è‡ªå®šä¹‰å­—ä½“ =====
    fetch('/api/fonts').then(r => r.json()).then(d => {
      const fonts = d.fonts || [];
      const container = document.getElementById('font-options');
      fonts.forEach(name => {
        const familyName = 'Custom-' + name.replace(/\.woff2$/i, '');
        const face = new FontFace(familyName, `url(/api/fonts/${encodeURIComponent(name)})`);
        face.load().then(loaded => {
          document.fonts.add(loaded);
          const div = document.createElement('div');
          div.className = 'font-option';
          div.dataset.font = `'${familyName}'`;
          div.style.fontFamily = familyName;
          div.textContent = name.replace(/\.woff2$/i, '');
          container.appendChild(div);
          // å¦‚æœå½“å‰é€‰ä¸­çš„å°±æ˜¯è¿™ä¸ªå­—ä½“ï¼Œæ ‡è®°active
          if (settings.fontFamily === `'${familyName}'`) div.classList.add('active');
        }).catch(() => {}); // åŠ è½½å¤±è´¥é™é»˜å¿½ç•¥
      });
    }).catch(() => {});

    // ===== é¢„åŠ è½½ç¼“å­˜ =====
    let prefetchedNext = null;

    // ===== åŠ è½½ç« èŠ‚ =====
    const chapterId = new URLSearchParams(location.search).get('id');
    if (!chapterId || !/^\d+$/.test(chapterId)) {
      document.getElementById('content').innerHTML = '<div class="msg msg-error">æ— æ•ˆçš„ç« èŠ‚ID</div>';
    } else {
      loadChapter();
    }

    async function loadChapter() {
      const el = document.getElementById('content');
      try {
        // æ£€æŸ¥æ˜¯å¦æœ‰é¢„åŠ è½½ç¼“å­˜
        let data;
        if (prefetchedNext && prefetchedNext.chapter && String(prefetchedNext.chapter.id) === chapterId) {
          data = prefetchedNext;
          prefetchedNext = null;
        } else {
          const res = await fetch(`/api/chapters/${chapterId}`);
          if (!res.ok) throw new Error(res.status === 404 ? 'ç« èŠ‚ä¸å­˜åœ¨' : 'åŠ è½½å¤±è´¥');
          data = await res.json();
        }
        const c = data.chapter;

        // å­˜å‚¨å…ƒæ•°æ®
        window._chapterMeta = {
          chapterId: c.id, chapterTitle: c.title,
          bookTitle: c.book_title, bookId: c.book_id
        };
        window._chapterData = { content: data.content, title: c.title };

        // SEO
        document.title = esc(c.title) + ' - ' + esc(c.book_title);
        const metaDesc = document.querySelector('meta[name="description"]');
        if (metaDesc) metaDesc.content = `${c.book_title} - ${c.title}`;

        // é¢åŒ…å±‘
        backUrl = `/book.html?id=${c.book_id}`;
        document.getElementById('back-link').href = backUrl;
        document.getElementById('breadcrumb').innerHTML =
          `<a href="/">ä¹¦æ¶</a><span>â€º</span><a href="/book.html?id=${c.book_id}">${esc(c.book_title)}</a><span>â€º</span>${esc(c.title)}`;

        // æ­£æ–‡ â€” æ®µè½åŒ–æ¸²æŸ“ï¼ˆæ”¯æŒæ‰¹æ³¨é«˜äº®ï¼‰
        const contentDiv = document.createElement('div');
        contentDiv.className = 'reader-content';
        const paragraphs = data.content.split('\n');
        window._paragraphs = paragraphs; // ä¾›æ‰¹æ³¨ç³»ç»Ÿä½¿ç”¨
        paragraphs.forEach((text, idx) => {
          const p = document.createElement('p');
          p.className = text.trim() ? 'reader-p' : 'reader-p reader-p-empty';
          p.setAttribute('data-p-idx', idx);
          p.textContent = text;
          contentDiv.appendChild(p);
        });

        // å¯¼èˆª
        prevUrl = data.prevChapter ? `/read.html?id=${data.prevChapter.id}` : null;
        nextUrl = data.nextChapter ? `/read.html?id=${data.nextChapter.id}` : null;

        const nav = document.createElement('div');
        nav.className = 'reader-nav';
        nav.innerHTML = `
          ${prevUrl ? `<a href="${prevUrl}">â† ${esc(data.prevChapter.title)}</a>` : '<span class="disabled">å·²æ˜¯ç¬¬ä¸€ç« </span>'}
          <a href="/book.html?id=${c.book_id}">ç›®å½•</a>
          <a href="#" id="export-btn" style="font-size:13px">å¯¼å‡ºTXT</a>
          <a href="#" id="download-book-btn" style="font-size:13px">ğŸ“¥ ç¼“å­˜å…¨ä¹¦</a>
          ${nextUrl ? `<a href="${nextUrl}">${esc(data.nextChapter.title)} â†’</a>` : '<span class="disabled">å·²æ˜¯æœ€æ–°ç« </span>'}
        `;

        el.innerHTML = `<h2>${esc(c.title)}</h2>`;
        el.appendChild(contentDiv);
        el.appendChild(nav);

        // å¯¼å‡ºæŒ‰é’®äº‹ä»¶
        document.getElementById('export-btn').addEventListener('click', (e) => { e.preventDefault(); exportThis(); });

        // ç¼“å­˜å…¨ä¹¦æŒ‰é’®
        document.getElementById('download-book-btn').addEventListener('click', async (e) => {
          e.preventDefault();
          const btn = e.target;
          try {
            btn.textContent = 'ğŸ“¥ è·å–ç›®å½•...';
            const bRes = await fetch(`/api/books/${c.book_id}`);
            const bData = await bRes.json();
            const chs = bData.chapters || [];
            if (chs.length === 0) { btn.textContent = 'ğŸ“¥ æ— ç« èŠ‚'; return; }
            let done = 0;
            for (const ch of chs) {
              await fetch(`/api/chapters/${ch.id}`);
              done++;
              btn.textContent = `ğŸ“¥ ${done}/${chs.length}`;
            }
            btn.textContent = 'âœ… ç¼“å­˜å®Œæˆ';
          } catch (err) {
            btn.textContent = 'âŒ ç¼“å­˜å¤±è´¥';
          }
        });

        // åº•éƒ¨å·¥å…·æ æŒ‰é’®
        document.getElementById('bar-prev').onclick = () => { if (prevUrl) location.href = prevUrl; };
        document.getElementById('bar-next').onclick = () => { if (nextUrl) location.href = nextUrl; };
        document.getElementById('bar-prev').style.opacity = prevUrl ? '1' : '0.3';
        document.getElementById('bar-next').style.opacity = nextUrl ? '1' : '0.3';

        // ä¿å­˜é˜…è¯»è¿›åº¦
        saveScrollPosition();

        // é˜…è¯»ç»Ÿè®¡ï¼šè®°å½•ç« èŠ‚å­—æ•°å’Œé˜…è¯»å¤©æ•°
        trackReadingStats(c.id, data.content.length);

        // æ›´æ–°ä¹¦ç­¾å›¾æ ‡
        updateBookmarkIcon();

        // æ¢å¤æ»šåŠ¨ä½ç½®
        restoreScrollPosition(c.book_id, c.id);

        // åŠ è½½ç›®å½•
        loadTOC(c.book_id, c.id);

        // åŠ è½½æ‰¹æ³¨
        loadAnnotations(c.id);

        // é¢„åŠ è½½ä¸‹ä¸€ç« 
        if (data.nextChapter) {
          setTimeout(() => {
            fetch(`/api/chapters/${data.nextChapter.id}`)
              .then(r => r.json())
              .then(d => { prefetchedNext = d; })
              .catch(() => {});
          }, 2000);
        }
      } catch (e) {
        el.innerHTML = `<div class="msg msg-error">${esc(e.message)}</div>`;
      }
    }

    function restoreScrollPosition(bookId, currentChapterId) {
      try {
        const saved = JSON.parse(localStorage.getItem(`reading_${bookId}`));
        if (saved && saved.chapterId === currentChapterId && saved.scrollPct > 0) {
          if (settings.readingMode === 'pager') {
            // ç¿»é¡µæ¨¡å¼ï¼šå»¶è¿Ÿåˆ°åˆ†é¡µè®¡ç®—åæ¢å¤
            requestAnimationFrame(() => {
              requestAnimationFrame(() => {
                pagerRecalc();
                const page = Math.round(saved.scrollPct * (pagerState.totalPages - 1));
                pagerGoTo(page, false);
              });
            });
          } else {
            // æ»šåŠ¨æ¨¡å¼ï¼šæ¢å¤æ»šåŠ¨ä½ç½®
            requestAnimationFrame(() => {
              const h = document.documentElement.scrollHeight - window.innerHeight;
              if (h > 0) window.scrollTo(0, h * saved.scrollPct);
            });
          }
        } else if (settings.readingMode === 'pager') {
          // æ²¡æœ‰ä¿å­˜çš„ä½ç½®ï¼Œä½†éœ€è¦åˆå§‹åŒ–åˆ†é¡µ
          requestAnimationFrame(() => {
            requestAnimationFrame(() => { pagerRecalc(); });
          });
        }
      } catch {
        if (settings.readingMode === 'pager') {
          requestAnimationFrame(() => {
            requestAnimationFrame(() => { pagerRecalc(); });
          });
        }
      }
    }

    async function loadTOC(bookId, currentChapterId) {
      try {
        const res = await fetch(`/api/books/${bookId}`);
        const data = await res.json();
        const list = document.getElementById('toc-list');
        document.getElementById('toc-title').textContent = data.book.title;
        list.innerHTML = (data.chapters || []).map(ch =>
          `<li><a href="/read.html?id=${ch.id}" class="${ch.id === currentChapterId ? 'current' : ''}">${esc(ch.title)}</a></li>`
        ).join('');
      } catch {}
    }

    function esc(s) {
      const d = document.createElement('div');
      d.textContent = s || '';
      return d.innerHTML;
    }

    function exportThis() {
      if (!window._chapterData) return;
      const BOM = '\uFEFF';
      const blob = new Blob([BOM + window._chapterData.content], {type:'text/plain;charset=utf-8'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = (window._chapterData.title + '.txt').replace(/[<>:"/\\|?*]/g, '_');
      a.click();
      URL.revokeObjectURL(url);
    }

    // ===== ä¹¦ç­¾åŠŸèƒ½ =====
    function getBookmarks(bookId) {
      try { return JSON.parse(localStorage.getItem(`bookmarks_${bookId}`)) || []; }
      catch { return []; }
    }
    function saveBookmarks(bookId, bookmarks) {
      localStorage.setItem(`bookmarks_${bookId}`, JSON.stringify(bookmarks));
    }
    function isBookmarked() {
      if (!window._chapterMeta) return false;
      const m = window._chapterMeta;
      const bms = getBookmarks(m.bookId);
      return bms.some(b => b.chapterId === m.chapterId);
    }
    function updateBookmarkIcon() {
      document.getElementById('bookmark-icon').textContent = isBookmarked() ? 'â˜…' : 'â˜†';
    }
    function toggleBookmark() {
      if (!window._chapterMeta) return;
      const m = window._chapterMeta;
      let bms = getBookmarks(m.bookId);
      const idx = bms.findIndex(b => b.chapterId === m.chapterId);
      if (idx >= 0) {
        bms.splice(idx, 1);
      } else {
        const h = document.documentElement.scrollHeight - window.innerHeight;
        const pct = h > 0 ? (window.scrollY / h) : 0;
        bms.push({
          chapterId: m.chapterId, chapterTitle: m.chapterTitle,
          scrollPct: pct, time: Date.now()
        });
      }
      saveBookmarks(m.bookId, bms);
      updateBookmarkIcon();
    }
    document.getElementById('bar-bookmark').addEventListener('click', toggleBookmark);

    // ===== é˜…è¯»ç»Ÿè®¡ =====
    function getReadingStats() {
      try { return JSON.parse(localStorage.getItem('readingStats')) || {}; } catch { return {}; }
    }
    function saveReadingStats(s) {
      localStorage.setItem('readingStats', JSON.stringify(s));
    }
    function trackReadingStats(chId, charCount) {
      const s = getReadingStats();
      if (!s.totalSeconds) s.totalSeconds = 0;
      if (!s.totalChars) s.totalChars = 0;
      if (!Array.isArray(s.readChapterIds)) s.readChapterIds = [];
      if (!Array.isArray(s.days)) s.days = [];
      // è®°å½•ä»Šå¤©
      const today = new Date().toISOString().slice(0, 10);
      if (!s.days.includes(today)) s.days.push(today);
      // é¦–æ¬¡é˜…è¯»è¯¥ç« èŠ‚æ‰ç´¯åŠ å­—æ•°
      if (!s.readChapterIds.includes(chId)) {
        s.readChapterIds.push(chId);
        s.totalChars += charCount;
      }
      s.lastActiveDate = today;
      saveReadingStats(s);
    }
    // æ¯30ç§’ç´¯åŠ é˜…è¯»æ—¶é•¿
    setInterval(() => {
      if (document.hidden) return;
      const s = getReadingStats();
      s.totalSeconds = (s.totalSeconds || 0) + 30;
      saveReadingStats(s);
    }, 30000);

    // ===== æ²‰æµ¸æ¨¡å¼ =====
    const immersiveHint = document.getElementById('immersive-hint');

    function toggleImmersive() {
      immersiveActive = !immersiveActive;
      document.body.classList.toggle('immersive', immersiveActive);
      if (immersiveActive) {
        document.documentElement.requestFullscreen().catch(() => {});
        // æ˜¾ç¤ºé€€å‡ºæç¤º
        immersiveHint.classList.add('show');
        setTimeout(() => immersiveHint.classList.remove('show'), 2000);
      } else {
        if (document.fullscreenElement) document.exitFullscreen().catch(() => {});
      }
      // ç¿»é¡µæ¨¡å¼éœ€è¦é‡æ–°è®¡ç®—
      if (settings.readingMode === 'pager') {
        requestAnimationFrame(() => requestAnimationFrame(() => pagerRecalc()));
      }
    }

    function exitImmersive() {
      if (!immersiveActive) return;
      immersiveActive = false;
      document.body.classList.remove('immersive');
      if (document.fullscreenElement) document.exitFullscreen().catch(() => {});
      if (settings.readingMode === 'pager') {
        requestAnimationFrame(() => requestAnimationFrame(() => pagerRecalc()));
      }
    }

    document.getElementById('bar-immersive').addEventListener('click', toggleImmersive);

    // æ²‰æµ¸æ¨¡å¼ä¸‹ä¸­å¤®åŒºåŸŸç‚¹å‡»é€€å‡º
    document.getElementById('reader-area').addEventListener('click', (e) => {
      if (!immersiveActive) return;
      if (e.target.closest('a') || e.target.closest('button')) return;
      const x = e.clientX, w = window.innerWidth;
      // ç¿»é¡µæ¨¡å¼ä¸‹å·¦å³åŒºåŸŸç”¨äºç¿»é¡µï¼Œåªæœ‰ä¸­å¤®é€€å‡º
      if (settings.readingMode === 'pager') {
        if (x > w * 0.3 && x < w * 0.7) exitImmersive();
      } else {
        // æ»šåŠ¨æ¨¡å¼ä¸‹ç‚¹å‡»ä¸­å¤®é€€å‡º
        if (x > w * 0.25 && x < w * 0.75) exitImmersive();
      }
    });

    // Escé€€å‡ºæ²‰æµ¸
    document.addEventListener('fullscreenchange', () => {
      if (!document.fullscreenElement && immersiveActive) {
        immersiveActive = false;
        document.body.classList.remove('immersive');
        if (settings.readingMode === 'pager') {
          requestAnimationFrame(() => requestAnimationFrame(() => pagerRecalc()));
        }
      }
    });

    // ===== PWA Service Worker =====
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('/sw.js').catch(() => {});
    }

    // ===== æ‰¹æ³¨ç³»ç»Ÿ =====
    const ANNOTATION_COLORS = ['#FFD700', '#FF6B6B', '#4ECDC4', '#45B7D1', '#96CEB4'];
    let _annotations = []; // å½“å‰ç« èŠ‚çš„æ‰¹æ³¨æ•°æ®
    let _selectedColor = '#FFD700';
    let _pendingSelection = null; // { paragraphIndex, startOffset, endOffset, text }
    let _annotationToken = null; // è®¤è¯token

    // è½»é‡ toast æç¤º
    function showAnnotationToast(msg) {
      let t = document.getElementById('annotation-toast');
      if (!t) { t = document.createElement('div'); t.id = 'annotation-toast'; t.className = 'annotation-toast'; document.body.appendChild(t); }
      t.textContent = msg; t.classList.add('visible');
      clearTimeout(t._timer);
      t._timer = setTimeout(() => t.classList.remove('visible'), 2500);
    }

    // æœªç™»å½•éšè—æ‰¹æ³¨æŒ‰é’®

    // è·å–è®¤è¯token
    function getAnnotationToken() {
      if (_annotationToken) return _annotationToken;
      _annotationToken = localStorage.getItem('auth_token') || sessionStorage.getItem('auth_token') || '';
      return _annotationToken;
    }

    // æœªç™»å½•éšè—æ‰¹æ³¨æŒ‰é’®
    if (!getAnnotationToken()) {
      document.getElementById('bar-annotations').style.display = 'none';
    }

    function annotationApi(method, url, body) {
      const token = getAnnotationToken();
      if (!token) return Promise.resolve(null);
      const opts = { method, headers: { 'Authorization': 'Bearer ' + token, 'Content-Type': 'application/json' } };
      if (body) opts.body = JSON.stringify(body);
      return fetch(url, opts);
    }

    // åŠ è½½æ‰¹æ³¨
    async function loadAnnotations(chapterId) {
      const token = getAnnotationToken();
      if (!token) return; // æœªç™»å½•ä¸åŠ è½½æ‰¹æ³¨
      try {
        const res = await annotationApi('GET', '/api/annotations?chapter_id=' + chapterId);
        if (!res || !res.ok) return;
        const data = await res.json();
        _annotations = data.annotations || [];
        renderAnnotationHighlights();
        updateAnnotationCount();
        // é«˜äº®æ¸²æŸ“å¯èƒ½æ”¹å˜å†…å®¹å°ºå¯¸ï¼Œç¿»é¡µæ¨¡å¼éœ€é‡æ–°è®¡ç®—
        if (typeof pagerRecalc === 'function' && settings.readingMode === 'pager') {
          requestAnimationFrame(() => requestAnimationFrame(() => pagerRecalc()));
        }
      } catch {}
    }

    // æ¸²æŸ“é«˜äº®
    function renderAnnotationHighlights() {
      // å…ˆæ¸…é™¤æ‰€æœ‰é«˜äº®
      document.querySelectorAll('.annotation-highlight').forEach(el => {
        const parent = el.parentNode;
        if (parent) {
          parent.replaceChild(document.createTextNode(el.textContent), el);
          parent.normalize();
        }
      });

      if (_annotations.length === 0) return;

      // æŒ‰æ®µè½åˆ†ç»„
      const byParagraph = {};
      _annotations.forEach(a => {
        if (!byParagraph[a.paragraph_index]) byParagraph[a.paragraph_index] = [];
        byParagraph[a.paragraph_index].push(a);
      });

      for (const [pIdx, annots] of Object.entries(byParagraph)) {
        const p = document.querySelector(`p[data-p-idx="${pIdx}"]`);
        if (!p) continue;

        const text = p.textContent;
        // æ’åºï¼šæŒ‰ start_offset å‡åºï¼Œé‡å æ—¶çŸ­çš„ä¼˜å…ˆ
        const sorted = annots
          .filter(a => {
            // æ ¡éªŒæ–‡æœ¬æ˜¯å¦åŒ¹é…
            const actual = text.slice(a.start_offset, a.end_offset);
            return actual === a.selected_text;
          })
          .sort((a, b) => a.start_offset - b.start_offset || (a.end_offset - a.start_offset) - (b.end_offset - b.start_offset));

        if (sorted.length === 0) continue;

        // æ„å»ºä¸é‡å çš„é«˜äº®åŒºé—´ï¼ˆç®€å•è´ªå¿ƒï¼šåæ¥çš„è¦†ç›–å‰é¢çš„é‡å éƒ¨åˆ†ï¼‰
        const fragments = [];
        let lastEnd = 0;

        for (const a of sorted) {
          const start = Math.max(a.start_offset, lastEnd);
          const end = a.end_offset;
          if (start >= end) continue;

          if (start > lastEnd) {
            fragments.push({ type: 'text', text: text.slice(lastEnd, start) });
          }
          fragments.push({ type: 'highlight', text: text.slice(start, end), annotation: a });
          lastEnd = end;
        }
        if (lastEnd < text.length) {
          fragments.push({ type: 'text', text: text.slice(lastEnd) });
        }

        // é‡å»ºæ®µè½å†…å®¹
        p.textContent = '';
        const frag = document.createDocumentFragment();
        for (const f of fragments) {
          if (f.type === 'text') {
            frag.appendChild(document.createTextNode(f.text));
          } else {
            const mark = document.createElement('mark');
            mark.className = 'annotation-highlight';
            const safeId = Number(f.annotation.id) || 0;
            const safeColor = /^#[0-9A-Fa-f]{6}$/.test(f.annotation.color) ? f.annotation.color : '#FFD700';
            mark.setAttribute('data-annotation-id', safeId);
            mark.setAttribute('data-color', safeColor);
            mark.style.background = safeColor + '4D'; // 30% opacity
            mark.style.borderBottomColor = safeColor + '99'; // 60% opacity
            mark.textContent = f.text;
            frag.appendChild(mark);
          }
        }
        p.appendChild(frag);
      }
    }

    // æ›´æ–°æ‰¹æ³¨è®¡æ•°
    function updateAnnotationCount() {
      const el = document.getElementById('annotation-count');
      if (el) el.textContent = _annotations.length;
    }

    // ===== æ–‡æœ¬é€‰æ‹© â†’ å¼¹å‡ºå·¥å…·æ  =====
    const annotationToolbar = document.getElementById('annotation-toolbar');
    const annotationNoteInput = document.getElementById('annotation-note-input');

    document.addEventListener('mouseup', handleTextSelection);
    document.addEventListener('touchend', (e) => {
      // å»¶è¿Ÿå¤„ç†è§¦æ‘¸é€‰æ‹©ï¼Œç­‰å¾…æµè§ˆå™¨å®Œæˆé€‰åŒº
      setTimeout(() => handleTextSelection(e), 200);
    });

    function handleTextSelection(e) {
      // å¿½ç•¥å·¥å…·æ å†…çš„ç‚¹å‡»
      if (e && e.target && e.target.closest('.annotation-toolbar')) return;
      if (e && e.target && e.target.closest('.annotation-panel')) return;

      const selection = window.getSelection();
      if (!selection || selection.isCollapsed || !selection.toString().trim()) {
        // å»¶è¿Ÿéšè—ï¼Œé¿å…ç‚¹å‡»ä¿å­˜æŒ‰é’®æ—¶é€‰åŒºå·²æ¶ˆå¤±
        setTimeout(() => {
          if (!_pendingSelection) hideAnnotationToolbar();
        }, 100);
        return;
      }

      const token = getAnnotationToken();
      if (!token) return; // æœªç™»å½•ä¸æ˜¾ç¤ºå·¥å…·æ 

      const range = selection.getRangeAt(0);
      const startNode = range.startContainer;
      const endNode = range.endContainer;

      // ç¡®ä¿é€‰åŒºåœ¨ reader-content å†…
      const readerContent = document.querySelector('.reader-content');
      if (!readerContent || !readerContent.contains(startNode) || !readerContent.contains(endNode)) return;

      // æ‰¾åˆ°èµ·å§‹å’Œç»“æŸæ®µè½
      const startP = startNode.nodeType === Node.TEXT_NODE ? startNode.parentElement.closest('p[data-p-idx]') : startNode.closest('p[data-p-idx]');
      const endP = endNode.nodeType === Node.TEXT_NODE ? endNode.parentElement.closest('p[data-p-idx]') : endNode.closest('p[data-p-idx]');

      if (!startP || !endP) return;

      // ç›®å‰åªæ”¯æŒå•æ®µè½å†…çš„æ‰¹æ³¨
      if (startP !== endP) {
        showAnnotationToast('æš‚ä¸æ”¯æŒè·¨æ®µè½æ‰¹æ³¨ï¼Œè¯·åœ¨å•ä¸ªæ®µè½å†…é€‰æ‹©');
        return;
      }

      const pIdx = parseInt(startP.getAttribute('data-p-idx'));
      const selectedText = selection.toString();

      if (selectedText.length > 2000) return; // å¤ªé•¿ä¸å¤„ç†

      // è®¡ç®—æ®µè½å†…çš„å­—ç¬¦åç§»é‡
      const pText = window._paragraphs ? window._paragraphs[pIdx] : startP.textContent;
      const startOffset = getTextOffset(startP, range.startContainer, range.startOffset);
      const endOffset = getTextOffset(startP, range.endContainer, range.endOffset);

      if (startOffset < 0 || endOffset < 0 || startOffset >= endOffset) return;

      // æ ¡éªŒé€‰ä¸­æ–‡æœ¬
      const expectedText = pText.slice(startOffset, endOffset);
      if (expectedText !== selectedText) return;

      _pendingSelection = {
        paragraphIndex: pIdx,
        startOffset: startOffset,
        endOffset: endOffset,
        text: selectedText
      };

      showAnnotationToolbar(range);
    }

    // è®¡ç®—æ–‡æœ¬èŠ‚ç‚¹åœ¨æ®µè½ä¸­çš„å­—ç¬¦åç§»
    function getTextOffset(paragraph, node, offset) {
      let charCount = 0;
      const walker = document.createTreeWalker(paragraph, NodeFilter.SHOW_TEXT, null);
      let current;
      while (current = walker.nextNode()) {
        if (current === node) {
          return charCount + offset;
        }
        charCount += current.textContent.length;
      }
      // node å¯èƒ½æ˜¯å…ƒç´ èŠ‚ç‚¹
      if (node.nodeType === Node.ELEMENT_NODE) {
        const children = node.childNodes;
        let count = 0;
        const walker2 = document.createTreeWalker(paragraph, NodeFilter.SHOW_TEXT, null);
        let cur2;
        let childIdx = 0;
        while (cur2 = walker2.nextNode()) {
          // æ£€æŸ¥è¿™ä¸ªæ–‡æœ¬èŠ‚ç‚¹æ˜¯å¦åœ¨ offset ä¹‹å‰çš„å­èŠ‚ç‚¹ä¸­
          while (childIdx < offset && children[childIdx]) {
            if (children[childIdx].contains(cur2) || children[childIdx] === cur2) {
              break;
            }
            childIdx++;
          }
          if (childIdx >= offset) return count;
          count += cur2.textContent.length;
        }
        return count;
      }
      return -1;
    }

    function showAnnotationToolbar(range) {
      const rect = range.getBoundingClientRect();
      annotationToolbar.classList.add('visible');
      annotationNoteInput.value = '';

      // å®šä½ï¼šé€‰åŒºä¸Šæ–¹æˆ–ä¸‹æ–¹
      const toolbarH = annotationToolbar.offsetHeight || 140;
      const toolbarW = annotationToolbar.offsetWidth || 240;
      let top = rect.top - toolbarH - 8;
      let left = rect.left + (rect.width - toolbarW) / 2;

      if (top < 8) top = rect.bottom + 8; // ä¸Šæ–¹æ”¾ä¸ä¸‹å°±æ”¾ä¸‹æ–¹
      if (left < 8) left = 8;
      if (left + toolbarW > window.innerWidth - 8) left = window.innerWidth - toolbarW - 8;

      annotationToolbar.style.top = top + 'px';
      annotationToolbar.style.left = left + 'px';
    }

    function hideAnnotationToolbar() {
      annotationToolbar.classList.remove('visible');
      annotationToolbar.removeAttribute('data-edit-id');
      _pendingSelection = null;
    }

    // é¢œè‰²é€‰æ‹©
    document.querySelector('.toolbar-colors').addEventListener('click', (e) => {
      const dot = e.target.closest('.color-dot');
      if (!dot) return;
      _selectedColor = dot.dataset.color;
      document.querySelectorAll('.toolbar-colors .color-dot').forEach(d => d.classList.toggle('active', d === dot));
    });

    // å–æ¶ˆ
    document.getElementById('annotation-cancel').addEventListener('click', () => {
      hideAnnotationToolbar();
      window.getSelection().removeAllRanges();
    });

    // ä¿å­˜æ‰¹æ³¨ï¼ˆæ–°å»º or ç¼–è¾‘ï¼‰
    document.getElementById('annotation-save').addEventListener('click', async () => {
      const btn = document.getElementById('annotation-save');
      if (btn.disabled) return;
      btn.disabled = true;
      btn.textContent = 'ä¿å­˜ä¸­...';

      const editId = annotationToolbar.getAttribute('data-edit-id');

      try {
        if (editId) {
          // ç¼–è¾‘æ¨¡å¼
          const id = Number(editId);
          const note = annotationNoteInput.value.trim();
          const res = await annotationApi('PUT', '/api/annotations/' + id, { note: note, color: _selectedColor });
          if (!res || !res.ok) {
            const data = res ? await res.json() : {};
            if (res && res.status === 401) { _annotationToken = null; alert('ç™»å½•å·²è¿‡æœŸï¼Œè¯·åˆ·æ–°é¡µé¢'); return; }
            alert('ä¿å­˜å¤±è´¥ï¼š' + (data.error || 'æœªçŸ¥é”™è¯¯'));
            return;
          }
          const a = _annotations.find(x => x.id === id);
          if (a) { a.note = note; a.color = _selectedColor; }
          renderAnnotationHighlights();
          hideAnnotationToolbar();
        } else if (_pendingSelection && window._chapterMeta) {
          // æ–°å»ºæ¨¡å¼
          const note = annotationNoteInput.value.trim();
          const sel = _pendingSelection;
          const res = await annotationApi('POST', '/api/annotations', {
            chapter_id: window._chapterMeta.chapterId,
            paragraph_index: sel.paragraphIndex,
            start_offset: sel.startOffset,
            end_offset: sel.endOffset,
            selected_text: sel.text,
            note: note,
            color: _selectedColor
          });
          if (!res || !res.ok) {
            const data = res ? await res.json() : {};
            if (res && res.status === 401) { _annotationToken = null; alert('ç™»å½•å·²è¿‡æœŸï¼Œè¯·åˆ·æ–°é¡µé¢'); return; }
            alert('ä¿å­˜å¤±è´¥ï¼š' + (data.error || 'æœªçŸ¥é”™è¯¯'));
            return;
          }
          const data = await res.json();
          _annotations.push(data.annotation);
          renderAnnotationHighlights();
          updateAnnotationCount();
          hideAnnotationToolbar();
          window.getSelection().removeAllRanges();
        }
        // ç¿»é¡µæ¨¡å¼é‡æ–°è®¡ç®—
        if (typeof pagerRecalc === 'function' && settings.readingMode === 'pager') {
          requestAnimationFrame(() => requestAnimationFrame(() => pagerRecalc()));
        }
      } catch (err) {
        alert('ä¿å­˜å¤±è´¥ï¼š' + err.message);
      } finally {
        btn.disabled = false;
        btn.textContent = 'ä¿å­˜';
      }
    });

    // ===== æ‰¹æ³¨æ°”æ³¡ï¼ˆhoverï¼‰ =====
    const annotationTooltip = document.getElementById('annotation-tooltip');
    let _tooltipTimer = null;

    document.addEventListener('mouseover', (e) => {
      const mark = e.target.closest('.annotation-highlight');
      if (!mark) return;

      const id = Number(mark.getAttribute('data-annotation-id'));
      const annotation = _annotations.find(a => a.id === id);
      if (!annotation) return;

      clearTimeout(_tooltipTimer);

      const textEl = document.getElementById('tooltip-text');
      const noteEl = document.getElementById('tooltip-note');
      const metaEl = document.getElementById('tooltip-meta');

      textEl.textContent = 'ã€Œ' + annotation.selected_text.slice(0, 50) + (annotation.selected_text.length > 50 ? '...' : '') + 'ã€';
      noteEl.textContent = annotation.note || 'ï¼ˆæ— æ‰¹æ³¨å†…å®¹ï¼‰';
      metaEl.textContent = (annotation.username || '') + (annotation.created_at ? ' Â· ' + annotation.created_at.slice(0, 16).replace('T', ' ') : '');

      if (!annotation.note) {
        noteEl.style.display = 'none';
      } else {
        noteEl.style.display = '';
      }

      const rect = mark.getBoundingClientRect();
      annotationTooltip.classList.add('visible');

      const tipH = annotationTooltip.offsetHeight || 60;
      const tipW = annotationTooltip.offsetWidth || 200;
      let top = rect.top - tipH - 8;
      let left = rect.left + (rect.width - tipW) / 2;

      if (top < 8) top = rect.bottom + 8;
      if (left < 8) left = 8;
      if (left + tipW > window.innerWidth - 8) left = window.innerWidth - tipW - 8;

      annotationTooltip.style.top = top + 'px';
      annotationTooltip.style.left = left + 'px';
    });

    document.addEventListener('mouseout', (e) => {
      const mark = e.target.closest('.annotation-highlight');
      if (!mark) return;
      _tooltipTimer = setTimeout(() => {
        annotationTooltip.classList.remove('visible');
      }, 200);
    });

    // ===== æ‰¹æ³¨ä¾§è¾¹é¢æ¿ =====
    const annotationPanelOverlay = document.getElementById('annotation-panel-overlay');

    document.getElementById('bar-annotations').addEventListener('click', () => {
      renderAnnotationPanel();
      annotationPanelOverlay.classList.add('active');
    });

    document.getElementById('close-annotation-panel').addEventListener('click', () => {
      annotationPanelOverlay.classList.remove('active');
    });

    annotationPanelOverlay.addEventListener('click', (e) => {
      if (e.target === annotationPanelOverlay) annotationPanelOverlay.classList.remove('active');
    });

    function renderAnnotationPanel() {
      const list = document.getElementById('annotation-list');
      updateAnnotationCount();

      if (_annotations.length === 0) {
        list.innerHTML = '<div class="panel-empty">æš‚æ— æ‰¹æ³¨<br><span style="font-size:12px;margin-top:8px;display:block">é€‰ä¸­æ–‡æœ¬å³å¯æ·»åŠ æ‰¹æ³¨</span></div>';
        return;
      }

      // æŒ‰æ®µè½é¡ºåºæ’åˆ—
      const sorted = [..._annotations].sort((a, b) => a.paragraph_index - b.paragraph_index || a.start_offset - b.start_offset);

      list.innerHTML = sorted.map(a => {
        const safeId = Number(a.id) || 0;
        const safeColor = /^#[0-9A-Fa-f]{6}$/.test(a.color) ? a.color : '#FFD700';
        const safeTime = esc((a.created_at || '').slice(0, 16).replace('T', ' '));
        return `
        <div class="panel-item" data-annotation-id="${safeId}">
          <div class="panel-item-text" style="border-left-color:${safeColor}">ã€Œ${esc(a.selected_text.slice(0, 100))}${a.selected_text.length > 100 ? '...' : ''}ã€</div>
          ${a.note ? `<div class="panel-item-note">${esc(a.note)}</div>` : ''}
          <div class="panel-item-meta">
            <span>${esc(a.username || '')} Â· ${safeTime}</span>
            <div class="panel-item-actions">
              <button class="btn-edit-annotation" title="ç¼–è¾‘">âœï¸</button>
              <button class="btn-delete-annotation" title="åˆ é™¤">ğŸ—‘ï¸</button>
            </div>
          </div>
        </div>`;
      }).join('');
    }

    // é¢æ¿äº‹ä»¶å§”æ‰˜
    document.getElementById('annotation-list').addEventListener('click', async (e) => {
      const item = e.target.closest('.panel-item');
      if (!item) return;
      const id = Number(item.getAttribute('data-annotation-id'));
      const annotation = _annotations.find(a => a.id === id);
      if (!annotation) return;

      if (e.target.closest('.btn-delete-annotation')) {
        if (!confirm('ç¡®å®šåˆ é™¤è¿™æ¡æ‰¹æ³¨ï¼Ÿ')) return;
        try {
          const res = await annotationApi('DELETE', '/api/annotations/' + id);
          if (res && res.ok) {
            _annotations = _annotations.filter(a => a.id !== id);
            renderAnnotationHighlights();
            renderAnnotationPanel();
            // ç¿»é¡µæ¨¡å¼éœ€è¦é‡æ–°è®¡ç®—
            if (settings.readingMode === 'pager') {
              requestAnimationFrame(() => requestAnimationFrame(() => pagerRecalc()));
            }
          } else {
            const data = res ? await res.json() : {};
            alert('åˆ é™¤å¤±è´¥ï¼š' + (data.error || 'æœªçŸ¥é”™è¯¯'));
          }
        } catch (err) {
          alert('åˆ é™¤å¤±è´¥ï¼š' + err.message);
        }
        return;
      }

      if (e.target.closest('.btn-edit-annotation')) {
        const newNote = prompt('ç¼–è¾‘æ‰¹æ³¨å†…å®¹ï¼š', annotation.note || '');
        if (newNote === null) return;
        try {
          const res = await annotationApi('PUT', '/api/annotations/' + id, { note: newNote });
          if (res && res.ok) {
            annotation.note = newNote;
            renderAnnotationPanel();
          } else {
            const data = res ? await res.json() : {};
            alert('ç¼–è¾‘å¤±è´¥ï¼š' + (data.error || 'æœªçŸ¥é”™è¯¯'));
          }
        } catch (err) {
          alert('ç¼–è¾‘å¤±è´¥ï¼š' + err.message);
        }
        return;
      }

      // ç‚¹å‡»æ‰¹æ³¨é¡¹ â†’ æ»šåŠ¨åˆ°å¯¹åº”ä½ç½®
      const p = document.querySelector(`p[data-p-idx="${annotation.paragraph_index}"]`);
      if (p) {
        if (settings.readingMode === 'pager') {
          // ç¿»é¡µæ¨¡å¼ï¼šæ‰¾åˆ°æ®µè½æ‰€åœ¨é¡µ
          const content = document.querySelector('.reader-content');
          if (content && pagerState.columnWidth > 0) {
            const pRect = p.getBoundingClientRect();
            const contentRect = content.getBoundingClientRect();
            // å…ˆè·³åˆ°ç¬¬0é¡µè·å–åŸºå‡†ä½ç½®
            const currentPage = pagerState.currentPage;
            content.style.transition = 'none';
            content.style.transform = 'translateX(0)';
            content.offsetHeight;
            const pLeft = p.offsetLeft;
            const page = Math.floor(pLeft / (pagerState.columnWidth * 2));
            pagerGoTo(Math.min(page, pagerState.totalPages - 1), false);
          }
        } else {
          p.scrollIntoView({ behavior: 'smooth', block: 'center' });
        }
        // é—ªçƒé«˜äº®
        const mark = p.querySelector(`.annotation-highlight[data-annotation-id="${id}"]`);
        if (mark) {
          mark.style.transition = 'background 0.2s';
          const origBg = mark.style.background;
          const flashColor = /^#[0-9A-Fa-f]{6}$/.test(annotation.color) ? annotation.color : '#FFD700';
          mark.style.background = flashColor + 'AA';
          setTimeout(() => { mark.style.background = origBg; }, 800);
        }
        annotationPanelOverlay.classList.remove('active');
      }
    });

    // ç‚¹å‡»é«˜äº®æ–‡æœ¬ â†’ å¼¹å‡ºç¼–è¾‘/åˆ é™¤å·¥å…·æ 
    document.addEventListener('click', (e) => {
      const mark = e.target.closest('.annotation-highlight');
      if (!mark) return;
      // å¦‚æœæœ‰é€‰åŒºï¼ˆç”¨æˆ·åœ¨é€‰æ‹©æ–‡æœ¬ï¼‰ï¼Œä¸å¤„ç†
      const sel = window.getSelection();
      if (sel && !sel.isCollapsed && sel.toString().trim()) return;

      const id = Number(mark.getAttribute('data-annotation-id'));
      const annotation = _annotations.find(a => a.id === id);
      if (!annotation) return;

      // å¤ç”¨å·¥å…·æ æ˜¾ç¤ºç¼–è¾‘ç•Œé¢
      _pendingSelection = null; // æ ‡è®°ä¸ºç¼–è¾‘æ¨¡å¼
      annotationNoteInput.value = annotation.note || '';
      _selectedColor = annotation.color || '#FFD700';
      document.querySelectorAll('.toolbar-colors .color-dot').forEach(d => d.classList.toggle('active', d.dataset.color === _selectedColor));

      const rect = mark.getBoundingClientRect();
      annotationToolbar.classList.add('visible');
      annotationToolbar.setAttribute('data-edit-id', id);

      const toolbarH = annotationToolbar.offsetHeight || 140;
      const toolbarW = annotationToolbar.offsetWidth || 240;
      let top = rect.top - toolbarH - 8;
      let left = rect.left + (rect.width - toolbarW) / 2;
      if (top < 8) top = rect.bottom + 8;
      if (left < 8) left = 8;
      if (left + toolbarW > window.innerWidth - 8) left = window.innerWidth - toolbarW - 8;
      annotationToolbar.style.top = top + 'px';
      annotationToolbar.style.left = left + 'px';
    });
  </script>
</body>
</html>

