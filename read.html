<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>é˜…è¯»</title>
  <meta name="description" content="">
  <link rel="stylesheet" href="/style.css">
</head>
<body>
  <div class="progress-bar" id="progress-bar"></div>
  <div class="navbar">
    <h1><a href="/">ğŸ“š æˆ‘çš„ä¹¦æ¶</a></h1>
    <nav>
      <a href="#" id="back-link">è¿”å›ç›®å½•</a>
    </nav>
  </div>
  <div class="reader" id="reader-area">
    <div class="breadcrumb" id="breadcrumb"></div>
    <div id="content" class="loading">åŠ è½½ä¸­...</div>
  </div>

  <!-- åº•éƒ¨å·¥å…·æ  -->
  <div class="reader-bottom-bar" id="bottom-bar">
    <button class="bar-btn" id="bar-prev" title="ä¸Šä¸€ç« "><span class="bar-icon">â—€</span>ä¸Šä¸€ç« </button>
    <button class="bar-btn" id="bar-toc" title="ç›®å½•"><span class="bar-icon">â˜°</span>ç›®å½•</button>
    <button class="bar-btn" id="bar-bookmark" title="ä¹¦ç­¾"><span class="bar-icon" id="bookmark-icon">â˜†</span>ä¹¦ç­¾</button>
    <button class="bar-btn" id="bar-settings" title="è®¾ç½®"><span class="bar-icon">âš™</span>è®¾ç½®</button>
    <button class="bar-btn" id="bar-next" title="ä¸‹ä¸€ç« "><span class="bar-icon">â–¶</span>ä¸‹ä¸€ç« </button>
  </div>

  <!-- ç« èŠ‚ç›®å½•æµ®å±‚ -->
  <div class="toc-overlay" id="toc-overlay">
    <div class="toc-panel">
      <h3 id="toc-title">ç›®å½•</h3>
      <ul class="toc-list" id="toc-list"></ul>
    </div>
  </div>

  <!-- è®¾ç½®é¢æ¿ -->
  <div class="settings-overlay" id="settings-overlay">
    <div class="settings-panel">
      <h3>é˜…è¯»è®¾ç½®<button class="close-btn" id="close-settings">âœ•</button></h3>
      <div class="setting-row">
        <span class="setting-label">ä¸»é¢˜</span>
        <div class="theme-options" id="theme-options">
          <div class="theme-dot" data-theme="light" title="é»˜è®¤"></div>
          <div class="theme-dot" data-theme="dark" title="å¤œé—´"></div>
          <div class="theme-dot" data-theme="green" title="æŠ¤çœ¼"></div>
          <div class="theme-dot" data-theme="sepia" title="ç¾Šçš®çº¸"></div>
          <div class="theme-dot" data-theme="blue" title="æ·¡è“"></div>
        </div>
      </div>
      <div class="setting-row">
        <span class="setting-label">å­—ä½“</span>
        <div class="font-options" id="font-options">
          <div class="font-option" data-font="'Georgia','Noto Serif SC','Source Han Serif CN',serif" style="font-family:Georgia,serif">å®‹ä½“/è¡¬çº¿</div>
          <div class="font-option" data-font="'PingFang SC','Microsoft YaHei','Noto Sans SC',sans-serif" style="font-family:sans-serif">é»‘ä½“/æ— è¡¬çº¿</div>
          <div class="font-option" data-font="'KaiTi','STKaiti','AR PL UKai CN',serif" style="font-family:KaiTi,STKaiti,serif">æ¥·ä½“</div>
          <div class="font-option" data-font="'FangSong','STFangsong',serif" style="font-family:FangSong,STFangsong,serif">ä»¿å®‹</div>
        </div>
      </div>
      <div class="setting-row">
        <span class="setting-label">å­—å·</span>
        <div class="slider-row">
          <span style="font-size:12px">A</span>
          <input type="range" id="font-size-slider" min="14" max="28" step="1">
          <span style="font-size:20px">A</span>
          <span class="slider-val" id="font-size-val">17px</span>
        </div>
      </div>
      <div class="setting-row">
        <span class="setting-label">è¡Œè·</span>
        <div class="slider-row">
          <span style="font-size:12px">ç´§</span>
          <input type="range" id="line-height-slider" min="1.5" max="3" step="0.1">
          <span style="font-size:12px">æ¾</span>
          <span class="slider-val" id="line-height-val">2.0</span>
        </div>
      </div>
      <div class="setting-row">
        <span class="setting-label">é¡µé¢å®½åº¦</span>
        <div class="slider-row">
          <span style="font-size:12px">çª„</span>
          <input type="range" id="width-slider" min="500" max="960" step="20">
          <span style="font-size:12px">å®½</span>
          <span class="slider-val" id="width-val">720px</span>
        </div>
      </div>
    </div>
  </div>

  <button class="back-to-top has-bar" id="back-top" onclick="window.scrollTo({top:0,behavior:'smooth'})">â†‘</button>

  <script>
    // ===== é˜…è¯»è®¾ç½®åˆå§‹åŒ– =====
    const THEMES = ['light','dark','green','sepia','blue'];
    const FONTS = [
      "'Georgia','Noto Serif SC','Source Han Serif CN',serif",
      "'PingFang SC','Microsoft YaHei','Noto Sans SC',sans-serif",
      "'KaiTi','STKaiti','AR PL UKai CN',serif",
      "'FangSong','STFangsong',serif"
    ];

    function loadSettings() {
      return {
        theme: localStorage.getItem('theme') || 'light',
        fontSize: parseInt(localStorage.getItem('font-size')) || 17,
        lineHeight: parseFloat(localStorage.getItem('line-height')) || 2,
        fontFamily: localStorage.getItem('font-family') || FONTS[0],
        readingWidth: parseInt(localStorage.getItem('reading-width')) || 720
      };
    }

    let settings = loadSettings();
    applyAllSettings();

    function applyAllSettings() {
      const root = document.documentElement;
      root.setAttribute('data-theme', settings.theme);
      root.style.setProperty('--font-size', settings.fontSize + 'px');
      root.style.setProperty('--line-height', settings.lineHeight);
      root.style.setProperty('--letter-spacing', '0.02em');
      root.style.setProperty('--font-family', settings.fontFamily);
      root.style.setProperty('--reading-width', settings.readingWidth + 'px');
    }

    function saveSetting(key, val) {
      localStorage.setItem(key, val);
    }

    // ===== è®¾ç½®é¢æ¿äº¤äº’ =====
    const settingsOverlay = document.getElementById('settings-overlay');
    const tocOverlay = document.getElementById('toc-overlay');

    // ä¸»é¢˜é€‰æ‹©
    document.getElementById('theme-options').addEventListener('click', (e) => {
      const dot = e.target.closest('.theme-dot');
      if (!dot) return;
      settings.theme = dot.dataset.theme;
      saveSetting('theme', settings.theme);
      applyAllSettings();
      updateSettingsUI();
    });

    // å­—ä½“é€‰æ‹©
    document.getElementById('font-options').addEventListener('click', (e) => {
      const opt = e.target.closest('.font-option');
      if (!opt) return;
      settings.fontFamily = opt.dataset.font;
      saveSetting('font-family', settings.fontFamily);
      applyAllSettings();
      updateSettingsUI();
    });

    // å­—å·æ»‘å—
    document.getElementById('font-size-slider').addEventListener('input', (e) => {
      settings.fontSize = parseInt(e.target.value);
      saveSetting('font-size', settings.fontSize);
      document.getElementById('font-size-val').textContent = settings.fontSize + 'px';
      applyAllSettings();
    });

    // è¡Œè·æ»‘å—
    document.getElementById('line-height-slider').addEventListener('input', (e) => {
      settings.lineHeight = parseFloat(e.target.value);
      saveSetting('line-height', settings.lineHeight);
      document.getElementById('line-height-val').textContent = settings.lineHeight.toFixed(1);
      applyAllSettings();
    });

    // é¡µé¢å®½åº¦æ»‘å—
    document.getElementById('width-slider').addEventListener('input', (e) => {
      settings.readingWidth = parseInt(e.target.value);
      saveSetting('reading-width', settings.readingWidth);
      document.getElementById('width-val').textContent = settings.readingWidth + 'px';
      applyAllSettings();
    });

    function updateSettingsUI() {
      document.querySelectorAll('.theme-dot').forEach(d => {
        d.classList.toggle('active', d.dataset.theme === settings.theme);
      });
      document.querySelectorAll('.font-option').forEach(o => {
        o.classList.toggle('active', o.dataset.font === settings.fontFamily);
      });
      document.getElementById('font-size-slider').value = settings.fontSize;
      document.getElementById('font-size-val').textContent = settings.fontSize + 'px';
      document.getElementById('line-height-slider').value = settings.lineHeight;
      document.getElementById('line-height-val').textContent = settings.lineHeight.toFixed(1);
      document.getElementById('width-slider').value = settings.readingWidth;
      document.getElementById('width-val').textContent = settings.readingWidth + 'px';
    }

    // æ‰“å¼€/å…³é—­è®¾ç½®
    document.getElementById('bar-settings').addEventListener('click', () => {
      updateSettingsUI();
      settingsOverlay.classList.add('active');
    });
    document.getElementById('close-settings').addEventListener('click', () => {
      settingsOverlay.classList.remove('active');
    });
    settingsOverlay.addEventListener('click', (e) => {
      if (e.target === settingsOverlay) settingsOverlay.classList.remove('active');
    });

    // æ‰“å¼€/å…³é—­ç›®å½•
    document.getElementById('bar-toc').addEventListener('click', () => {
      tocOverlay.classList.add('active');
      // æ»šåŠ¨åˆ°å½“å‰ç« èŠ‚
      const cur = document.querySelector('.toc-list a.current');
      if (cur) cur.scrollIntoView({ block: 'center' });
    });
    tocOverlay.addEventListener('click', (e) => {
      if (e.target === tocOverlay) tocOverlay.classList.remove('active');
    });

    // ===== åº•éƒ¨å·¥å…·æ æ˜¾ç¤º/éšè— =====
    const bottomBar = document.getElementById('bottom-bar');
    let barVisible = true;
    bottomBar.classList.add('visible');

    document.getElementById('reader-area').addEventListener('click', (e) => {
      if (e.target.closest('a') || e.target.closest('button') || e.target.closest('.reader-nav')) return;
      barVisible = !barVisible;
      bottomBar.classList.toggle('visible', barVisible);
    });

    // ===== è¿›åº¦æ¡ + æ»šåŠ¨ä½ç½®è®°å¿† =====
    let scrollSaveTimer = null;
    window.addEventListener('scroll', () => {
      const h = document.documentElement.scrollHeight - window.innerHeight;
      const pct = h > 0 ? (window.scrollY / h * 100) : 0;
      document.getElementById('progress-bar').style.width = pct + '%';
      document.getElementById('back-top').classList.toggle('visible', window.scrollY > 400);

      // èŠ‚æµä¿å­˜æ»šåŠ¨ä½ç½®
      if (scrollSaveTimer) clearTimeout(scrollSaveTimer);
      scrollSaveTimer = setTimeout(saveScrollPosition, 1000);
    });

    function saveScrollPosition() {
      if (!window._chapterMeta) return;
      const m = window._chapterMeta;
      const h = document.documentElement.scrollHeight - window.innerHeight;
      const pct = h > 0 ? (window.scrollY / h) : 0;
      const progress = {
        chapterId: m.chapterId, chapterTitle: m.chapterTitle,
        bookTitle: m.bookTitle, bookId: m.bookId,
        scrollPct: pct, time: Date.now()
      };
      localStorage.setItem(`reading_${m.bookId}`, JSON.stringify(progress));
    }

    // ===== é”®ç›˜å¿«æ·é”® =====
    let prevUrl = null, nextUrl = null, backUrl = null;
    document.addEventListener('keydown', (e) => {
      if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') return;
      if (e.key === 'ArrowLeft' && prevUrl) location.href = prevUrl;
      if (e.key === 'ArrowRight' && nextUrl) location.href = nextUrl;
      if (e.key === 'Escape') {
        if (settingsOverlay.classList.contains('active')) settingsOverlay.classList.remove('active');
        else if (tocOverlay.classList.contains('active')) tocOverlay.classList.remove('active');
        else if (backUrl) location.href = backUrl;
      }
    });

    // ===== åŠ è½½ç«™ç‚¹è®¾ç½® =====
    fetch('/api/settings').then(r => r.json()).then(d => {
      const s = d.settings || {};
      if (s.site_name) document.querySelector('.navbar h1 a').textContent = 'ğŸ“š ' + s.site_name;
    }).catch(() => {});

    // ===== é¢„åŠ è½½ç¼“å­˜ =====
    let prefetchedNext = null;

    // ===== åŠ è½½ç« èŠ‚ =====
    const chapterId = new URLSearchParams(location.search).get('id');
    if (!chapterId || !/^\d+$/.test(chapterId)) {
      document.getElementById('content').innerHTML = '<div class="msg msg-error">æ— æ•ˆçš„ç« èŠ‚ID</div>';
    } else {
      loadChapter();
    }

    async function loadChapter() {
      const el = document.getElementById('content');
      try {
        // æ£€æŸ¥æ˜¯å¦æœ‰é¢„åŠ è½½ç¼“å­˜
        let data;
        if (prefetchedNext && prefetchedNext.chapter && String(prefetchedNext.chapter.id) === chapterId) {
          data = prefetchedNext;
          prefetchedNext = null;
        } else {
          const res = await fetch(`/api/chapters/${chapterId}`);
          if (!res.ok) throw new Error(res.status === 404 ? 'ç« èŠ‚ä¸å­˜åœ¨' : 'åŠ è½½å¤±è´¥');
          data = await res.json();
        }
        const c = data.chapter;

        // å­˜å‚¨å…ƒæ•°æ®
        window._chapterMeta = {
          chapterId: c.id, chapterTitle: c.title,
          bookTitle: c.book_title, bookId: c.book_id
        };
        window._chapterData = { content: data.content, title: c.title };

        // SEO
        document.title = esc(c.title) + ' - ' + esc(c.book_title);
        const metaDesc = document.querySelector('meta[name="description"]');
        if (metaDesc) metaDesc.content = `${c.book_title} - ${c.title}`;

        // é¢åŒ…å±‘
        backUrl = `/book.html?id=${c.book_id}`;
        document.getElementById('back-link').href = backUrl;
        document.getElementById('breadcrumb').innerHTML =
          `<a href="/">ä¹¦æ¶</a><span>â€º</span><a href="/book.html?id=${c.book_id}">${esc(c.book_title)}</a><span>â€º</span>${esc(c.title)}`;

        // æ­£æ–‡
        const contentDiv = document.createElement('div');
        contentDiv.className = 'reader-content';
        contentDiv.textContent = data.content;

        // å¯¼èˆª
        prevUrl = data.prevChapter ? `/read.html?id=${data.prevChapter.id}` : null;
        nextUrl = data.nextChapter ? `/read.html?id=${data.nextChapter.id}` : null;

        const nav = document.createElement('div');
        nav.className = 'reader-nav';
        nav.innerHTML = `
          ${prevUrl ? `<a href="${prevUrl}">â† ${esc(data.prevChapter.title)}</a>` : '<span class="disabled">å·²æ˜¯ç¬¬ä¸€ç« </span>'}
          <a href="/book.html?id=${c.book_id}">ç›®å½•</a>
          <a href="#" id="export-btn" style="font-size:13px">å¯¼å‡ºTXT</a>
          ${nextUrl ? `<a href="${nextUrl}">${esc(data.nextChapter.title)} â†’</a>` : '<span class="disabled">å·²æ˜¯æœ€æ–°ç« </span>'}
        `;

        el.innerHTML = `<h2>${esc(c.title)}</h2>`;
        el.appendChild(contentDiv);
        el.appendChild(nav);

        // å¯¼å‡ºæŒ‰é’®äº‹ä»¶
        document.getElementById('export-btn').addEventListener('click', (e) => { e.preventDefault(); exportThis(); });

        // åº•éƒ¨å·¥å…·æ æŒ‰é’®
        document.getElementById('bar-prev').onclick = () => { if (prevUrl) location.href = prevUrl; };
        document.getElementById('bar-next').onclick = () => { if (nextUrl) location.href = nextUrl; };
        document.getElementById('bar-prev').style.opacity = prevUrl ? '1' : '0.3';
        document.getElementById('bar-next').style.opacity = nextUrl ? '1' : '0.3';

        // ä¿å­˜é˜…è¯»è¿›åº¦
        saveScrollPosition();

        // æ›´æ–°ä¹¦ç­¾å›¾æ ‡
        updateBookmarkIcon();

        // æ¢å¤æ»šåŠ¨ä½ç½®
        restoreScrollPosition(c.book_id, c.id);

        // åŠ è½½ç›®å½•
        loadTOC(c.book_id, c.id);

        // é¢„åŠ è½½ä¸‹ä¸€ç« 
        if (data.nextChapter) {
          setTimeout(() => {
            fetch(`/api/chapters/${data.nextChapter.id}`)
              .then(r => r.json())
              .then(d => { prefetchedNext = d; })
              .catch(() => {});
          }, 2000);
        }
      } catch (e) {
        el.innerHTML = `<div class="msg msg-error">${esc(e.message)}</div>`;
      }
    }

    function restoreScrollPosition(bookId, currentChapterId) {
      try {
        const saved = JSON.parse(localStorage.getItem(`reading_${bookId}`));
        if (saved && saved.chapterId === currentChapterId && saved.scrollPct > 0) {
          // ç­‰DOMæ¸²æŸ“å®Œå†æ¢å¤
          requestAnimationFrame(() => {
            const h = document.documentElement.scrollHeight - window.innerHeight;
            if (h > 0) window.scrollTo(0, h * saved.scrollPct);
          });
        }
      } catch {}
    }

    async function loadTOC(bookId, currentChapterId) {
      try {
        const res = await fetch(`/api/books/${bookId}`);
        const data = await res.json();
        const list = document.getElementById('toc-list');
        document.getElementById('toc-title').textContent = data.book.title;
        list.innerHTML = (data.chapters || []).map(ch =>
          `<li><a href="/read.html?id=${ch.id}" class="${ch.id === currentChapterId ? 'current' : ''}">${esc(ch.title)}</a></li>`
        ).join('');
      } catch {}
    }

    function esc(s) {
      const d = document.createElement('div');
      d.textContent = s || '';
      return d.innerHTML;
    }

    function exportThis() {
      if (!window._chapterData) return;
      const BOM = '\uFEFF';
      const blob = new Blob([BOM + window._chapterData.content], {type:'text/plain;charset=utf-8'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = (window._chapterData.title + '.txt').replace(/[<>:"/\\|?*]/g, '_');
      a.click();
      URL.revokeObjectURL(url);
    }

    // ===== ä¹¦ç­¾åŠŸèƒ½ =====
    function getBookmarks(bookId) {
      try { return JSON.parse(localStorage.getItem(`bookmarks_${bookId}`)) || []; }
      catch { return []; }
    }
    function saveBookmarks(bookId, bookmarks) {
      localStorage.setItem(`bookmarks_${bookId}`, JSON.stringify(bookmarks));
    }
    function isBookmarked() {
      if (!window._chapterMeta) return false;
      const m = window._chapterMeta;
      const bms = getBookmarks(m.bookId);
      return bms.some(b => b.chapterId === m.chapterId);
    }
    function updateBookmarkIcon() {
      document.getElementById('bookmark-icon').textContent = isBookmarked() ? 'â˜…' : 'â˜†';
    }
    function toggleBookmark() {
      if (!window._chapterMeta) return;
      const m = window._chapterMeta;
      let bms = getBookmarks(m.bookId);
      const idx = bms.findIndex(b => b.chapterId === m.chapterId);
      if (idx >= 0) {
        bms.splice(idx, 1);
      } else {
        const h = document.documentElement.scrollHeight - window.innerHeight;
        const pct = h > 0 ? (window.scrollY / h) : 0;
        bms.push({
          chapterId: m.chapterId, chapterTitle: m.chapterTitle,
          scrollPct: pct, time: Date.now()
        });
      }
      saveBookmarks(m.bookId, bms);
      updateBookmarkIcon();
    }
    document.getElementById('bar-bookmark').addEventListener('click', toggleBookmark);
  </script>
</body>
</html>
