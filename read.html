<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>é˜…è¯» - æˆ‘çš„ä¹¦æ¶</title>
  <meta name="description" content="">
  <link rel="stylesheet" href="/style.css">
  <link rel="manifest" href="/manifest.json">
  <meta name="theme-color" content="#d4a574">
</head>
<body>
  <div class="progress-bar" id="progress-bar"></div>
  <div class="navbar">
    <h1><a href="/">ğŸ“š æˆ‘çš„ä¹¦æ¶</a></h1>
    <nav>
      <a href="#" id="back-link">è¿”å›ç›®å½•</a>
    </nav>
  </div>
  <div class="reader" id="reader-area">
    <div class="breadcrumb" id="breadcrumb"></div>
    <div id="content" class="loading">åŠ è½½ä¸­...</div>
  </div>

  <!-- åº•éƒ¨å·¥å…·æ  -->
  <div class="reader-bottom-bar" id="bottom-bar">
    <button class="bar-btn" id="bar-prev" title="ä¸Šä¸€ç« "><span class="bar-icon">â—€</span>ä¸Šä¸€ç« </button>
    <button class="bar-btn" id="bar-toc" title="ç›®å½•"><span class="bar-icon">â˜°</span>ç›®å½•</button>
    <button class="bar-btn" id="bar-bookmark" title="ä¹¦ç­¾"><span class="bar-icon" id="bookmark-icon">â˜†</span>ä¹¦ç­¾</button>
    <button class="bar-btn" id="bar-settings" title="è®¾ç½®"><span class="bar-icon">âš™</span>è®¾ç½®</button>
    <button class="bar-btn" id="bar-immersive" title="æ²‰æµ¸æ¨¡å¼"><span class="bar-icon">ğŸ”²</span>æ²‰æµ¸</button>
    <button class="bar-btn" id="bar-next" title="ä¸‹ä¸€ç« "><span class="bar-icon">â–¶</span>ä¸‹ä¸€ç« </button>
  </div>

  <!-- ç« èŠ‚ç›®å½•æµ®å±‚ -->
  <div class="toc-overlay" id="toc-overlay">
    <div class="toc-panel">
      <h3 id="toc-title">ç›®å½•</h3>
      <ul class="toc-list" id="toc-list"></ul>
    </div>
  </div>

  <!-- è®¾ç½®é¢æ¿ -->
  <div class="settings-overlay" id="settings-overlay">
    <div class="settings-panel">
      <h3>é˜…è¯»è®¾ç½®<button class="close-btn" id="close-settings">âœ•</button></h3>
      <div class="setting-row">
        <span class="setting-label">ä¸»é¢˜</span>
        <div class="theme-options" id="theme-options">
          <div class="theme-dot" data-theme="light" title="é»˜è®¤"></div>
          <div class="theme-dot" data-theme="dark" title="å¤œé—´"></div>
          <div class="theme-dot" data-theme="green" title="æŠ¤çœ¼"></div>
          <div class="theme-dot" data-theme="sepia" title="ç¾Šçš®çº¸"></div>
          <div class="theme-dot" data-theme="blue" title="æ·¡è“"></div>
        </div>
      </div>
      <div class="setting-row">
        <span class="setting-label">å­—ä½“</span>
        <div class="font-options" id="font-options">
          <div class="font-option" data-font="'Georgia','Noto Serif SC','Source Han Serif CN',serif" style="font-family:Georgia,serif">å®‹ä½“/è¡¬çº¿</div>
          <div class="font-option" data-font="'PingFang SC','Microsoft YaHei','Noto Sans SC',sans-serif" style="font-family:sans-serif">é»‘ä½“/æ— è¡¬çº¿</div>
          <div class="font-option" data-font="'KaiTi','STKaiti','AR PL UKai CN',serif" style="font-family:KaiTi,STKaiti,serif">æ¥·ä½“</div>
          <div class="font-option" data-font="'FangSong','STFangsong',serif" style="font-family:FangSong,STFangsong,serif">ä»¿å®‹</div>
        </div>
      </div>
      <div class="setting-row">
        <span class="setting-label">å­—å·</span>
        <div class="slider-row">
          <span style="font-size:12px">A</span>
          <input type="range" id="font-size-slider" min="14" max="28" step="1">
          <span style="font-size:20px">A</span>
          <span class="slider-val" id="font-size-val">17px</span>
        </div>
      </div>
      <div class="setting-row">
        <span class="setting-label">è¡Œè·</span>
        <div class="slider-row">
          <span style="font-size:12px">ç´§</span>
          <input type="range" id="line-height-slider" min="1.5" max="3" step="0.1">
          <span style="font-size:12px">æ¾</span>
          <span class="slider-val" id="line-height-val">2.0</span>
        </div>
      </div>
      <div class="setting-row">
        <span class="setting-label">é¡µé¢å®½åº¦</span>
        <div class="slider-row">
          <span style="font-size:12px">çª„</span>
          <input type="range" id="width-slider" min="500" max="960" step="20">
          <span style="font-size:12px">å®½</span>
          <span class="slider-val" id="width-val">720px</span>
        </div>
      </div>
      <div class="setting-row">
        <span class="setting-label">é˜…è¯»æ¨¡å¼</span>
        <div class="mode-options" id="mode-options">
          <div class="mode-option" data-mode="scroll">ğŸ“œ æ»šåŠ¨</div>
          <div class="mode-option" data-mode="pager">ğŸ“– ç¿»é¡µ</div>
        </div>
      </div>
    </div>
  </div>

  <button class="back-to-top has-bar" id="back-top" onclick="window.scrollTo({top:0,behavior:'smooth'})">â†‘</button>

  <!-- ç¿»é¡µæ¨¡å¼ï¼šç‚¹å‡»åŒºåŸŸ + é¡µç  -->
  <div class="pager-tap-left" id="pager-tap-left" style="display:none"></div>
  <div class="pager-tap-right" id="pager-tap-right" style="display:none"></div>
  <div class="pager-indicator" id="pager-indicator"></div>
  <div class="immersive-hint" id="immersive-hint">ç‚¹å‡»ä¸­å¤®æˆ–æŒ‰ Esc é€€å‡ºæ²‰æµ¸æ¨¡å¼</div>

  <!-- æ‰¹æ³¨ï¼šæµ®åŠ¨æŒ‰é’®ï¼ˆPC+ç§»åŠ¨ç«¯ç»Ÿä¸€ï¼‰ -->
  <div id="anno-float-btn" class="anno-float-btn">ğŸ“</div>

  <!-- æ‰¹æ³¨ï¼šè¾“å…¥æ¡† -->
  <div id="anno-editor" class="anno-editor" style="display:none">
    <div class="anno-editor-quote" id="anno-quote"></div>
    <textarea id="anno-input" maxlength="500" placeholder="å†™ä¸‹ä½ çš„æ‰¹æ³¨..."></textarea>
    <div class="anno-editor-footer">
      <button id="anno-vis-btn" class="anno-vis-btn" type="button">ğŸ”’ ä»…è‡ªå·±å¯è§</button>
      <div class="anno-editor-actions">
        <button class="btn btn-sm" id="anno-cancel" type="button">å–æ¶ˆ</button>
        <button class="btn btn-sm anno-submit-btn" id="anno-submit" type="button">å‘è¡¨</button>
      </div>
    </div>
  </div>

  <!-- æ‰¹æ³¨ï¼šæŸ¥çœ‹å¼¹çª— -->
  <div id="anno-popover" class="anno-popover" style="display:none"></div>

  <script>
    // ===== è®¤è¯çŠ¶æ€ =====
    const authToken = localStorage.getItem('auth_token') || sessionStorage.getItem('auth_token') || '';
    let currentUser = null; // { userId, username, role }
    let canAnnotate = false; // å½“å‰ä¹¦ç±æ˜¯å¦å¯æ‰¹æ³¨
    let currentBookId = null;
    let currentChapterId = null;

    async function fetchCurrentUser() {
      if (!authToken) return;
      try {
        const res = await fetch('/api/me', { headers: { 'Authorization': 'Bearer ' + authToken } });
        if (res.ok) {
          currentUser = await res.json();
        }
      } catch {}
    }

    function annoApi(method, path, body) {
      const opts = { method, headers: {} };
      if (authToken) opts.headers['Authorization'] = 'Bearer ' + authToken;
      if (body) {
        opts.headers['Content-Type'] = 'application/json';
        opts.body = JSON.stringify(body);
      }
      return fetch(path, opts);
    }

    // ===== å¥å­åˆ†å‰²å·¥å…· =====
    function splitSentences(text) {
      if (!text || !text.trim()) return [];
      // åŒ¹é…å¥å­ï¼šéå¥æœ«æ ‡ç‚¹çš„å­—ç¬¦ + å¯é€‰çš„å¥æœ«æ ‡ç‚¹ï¼ˆå«çœç•¥å·â€¦å’Œè¿ç»­è‹±æ–‡å¥å·..ï¼‰
      // ğŸŸ¡-4: è¿ç»­è‹±æ–‡å¥å· .. / ... è§†ä¸ºçœç•¥å·ï¼Œä¸é€ä¸ªæ–­å¥
      const raw = text.match(/[^ã€‚ï¼ï¼Ÿâ€¦!?\n]+(?:\.{2,}|[ã€‚ï¼ï¼Ÿâ€¦!?\n])?/g) || [text];
      const merged = [];
      let buf = '';
      let depth = 0;
      for (const seg of raw) {
        buf += seg;
        for (const ch of seg) {
          if (ch === '\u201c' || ch === '\u300c' || ch === '\u300e') depth++;
          if (ch === '\u201d' || ch === '\u300d' || ch === '\u300f') depth = Math.max(0, depth - 1);
        }
        if (depth === 0) {
          const trimmed = buf.trim();
          if (trimmed) merged.push(trimmed);
          buf = '';
        }
      }
      if (buf.trim()) merged.push(buf.trim());
      return merged;
    }

    function snapToSentence(paragraphText, selStart, selEnd) {
      const sentences = splitSentences(paragraphText);
      let pos = 0;
      for (let i = 0; i < sentences.length; i++) {
        const s = sentences[i];
        const sStart = paragraphText.indexOf(s, pos);
        const sEnd = sStart + s.length;
        if (selStart < sEnd && selEnd > sStart) {
          return { text: s, sentIdx: i, start: sStart, end: sEnd };
        }
        pos = sEnd;
      }
      return null;
    }

    async function sentenceHash(text) {
      const buf = await crypto.subtle.digest('SHA-256', new TextEncoder().encode(text));
      return [...new Uint8Array(buf)].slice(0, 4).map(b => b.toString(16).padStart(2, '0')).join('');
    }

    function annotationOpacity(count) {
      if (count <= 0) return 0;
      // 1äºº=0.3, 3äººâ‰ˆ0.5, 10äººâ‰ˆ0.75, 20äººâ‰ˆ0.9ï¼ˆğŸŸ¢-2: æ”¹ä¸º20æ¡è¾¾åˆ°æœ€å¤§æµ“åº¦ï¼‰
      const min = 0.3, max = 0.9;
      return Math.min(max, min + (max - min) * (Math.log10(count) / Math.log10(20)));
    }

    // ===== é˜…è¯»è®¾ç½®åˆå§‹åŒ– =====
    let immersiveActive = false; // æ²‰æµ¸æ¨¡å¼çŠ¶æ€ï¼ˆæå‰å£°æ˜ä¾›å…¶ä»–handlerä½¿ç”¨ï¼‰
    const THEMES = ['light','dark','green','sepia','blue'];
    const FONTS = [
      "'Georgia','Noto Serif SC','Source Han Serif CN',serif",
      "'PingFang SC','Microsoft YaHei','Noto Sans SC',sans-serif",
      "'KaiTi','STKaiti','AR PL UKai CN',serif",
      "'FangSong','STFangsong',serif"
    ];

    function loadSettings() {
      let readingMode = 'scroll';
      try { readingMode = localStorage.getItem('reading-mode') || 'scroll'; } catch {}
      return {
        theme: localStorage.getItem('theme') || 'light',
        fontSize: parseInt(localStorage.getItem('font-size')) || 17,
        lineHeight: parseFloat(localStorage.getItem('line-height')) || 2,
        fontFamily: localStorage.getItem('font-family') || FONTS[0],
        readingWidth: parseInt(localStorage.getItem('reading-width')) || 720,
        readingMode: readingMode
      };
    }

    let settings = loadSettings();

    // ===== ç¿»é¡µæ¨¡å¼å˜é‡ï¼ˆéœ€åœ¨ applyAllSettings ä¹‹å‰å£°æ˜ï¼‰=====
    let pagerState = { currentPage: 0, totalPages: 1, columnWidth: 0 };
    const pagerTapLeft = document.getElementById('pager-tap-left');
    const pagerTapRight = document.getElementById('pager-tap-right');
    const pagerIndicator = document.getElementById('pager-indicator');

    applyAllSettings();

    function applyAllSettings() {
      const root = document.documentElement;
      root.setAttribute('data-theme', settings.theme);
      root.style.setProperty('--font-size', settings.fontSize + 'px');
      root.style.setProperty('--line-height', settings.lineHeight);
      root.style.setProperty('--letter-spacing', '0.02em');
      root.style.setProperty('--font-family', settings.fontFamily);
      root.style.setProperty('--reading-width', settings.readingWidth + 'px');
      applyReadingMode();
    }

    function saveSetting(key, val) {
      localStorage.setItem(key, val);
    }

    // ===== è®¾ç½®é¢æ¿äº¤äº’ =====
    const settingsOverlay = document.getElementById('settings-overlay');
    const tocOverlay = document.getElementById('toc-overlay');

    // ä¸»é¢˜é€‰æ‹©
    document.getElementById('theme-options').addEventListener('click', (e) => {
      const dot = e.target.closest('.theme-dot');
      if (!dot) return;
      settings.theme = dot.dataset.theme;
      saveSetting('theme', settings.theme);
      applyAllSettings();
      updateSettingsUI();
    });

    // å­—ä½“é€‰æ‹©
    document.getElementById('font-options').addEventListener('click', (e) => {
      const opt = e.target.closest('.font-option');
      if (!opt) return;
      settings.fontFamily = opt.dataset.font;
      saveSetting('font-family', settings.fontFamily);
      applyAllSettings();
      updateSettingsUI();
      // å­—ä½“å˜åŒ–åéœ€è¦ç­‰æ¸²æŸ“å†é‡æ–°åˆ†é¡µ
      if (settings.readingMode === 'pager') {
        requestAnimationFrame(() => { requestAnimationFrame(() => { pagerRecalc(); }); });
      }
    });

    // é˜²æŠ–å·¥å…·å‡½æ•°ï¼ˆç¿»é¡µæ¨¡å¼æ»‘å—ç”¨ï¼‰
    let _pagerDebounceTimer = null;
    function debouncedPagerRecalc() {
      if (_pagerDebounceTimer) clearTimeout(_pagerDebounceTimer);
      _pagerDebounceTimer = setTimeout(pagerRecalc, 100);
    }

    // å­—å·æ»‘å—
    document.getElementById('font-size-slider').addEventListener('input', (e) => {
      settings.fontSize = parseInt(e.target.value);
      saveSetting('font-size', settings.fontSize);
      document.getElementById('font-size-val').textContent = settings.fontSize + 'px';
      applyAllSettings();
      if (settings.readingMode === 'pager') debouncedPagerRecalc();
    });

    // è¡Œè·æ»‘å—
    document.getElementById('line-height-slider').addEventListener('input', (e) => {
      settings.lineHeight = parseFloat(e.target.value);
      saveSetting('line-height', settings.lineHeight);
      document.getElementById('line-height-val').textContent = settings.lineHeight.toFixed(1);
      applyAllSettings();
      if (settings.readingMode === 'pager') debouncedPagerRecalc();
    });

    // é¡µé¢å®½åº¦æ»‘å—
    document.getElementById('width-slider').addEventListener('input', (e) => {
      settings.readingWidth = parseInt(e.target.value);
      saveSetting('reading-width', settings.readingWidth);
      document.getElementById('width-val').textContent = settings.readingWidth + 'px';
      applyAllSettings();
      if (settings.readingMode === 'pager') debouncedPagerRecalc();
    });

    // é˜…è¯»æ¨¡å¼åˆ‡æ¢
    document.getElementById('mode-options').addEventListener('click', (e) => {
      const opt = e.target.closest('.mode-option');
      if (!opt) return;
      const newMode = opt.dataset.mode;
      if (newMode === settings.readingMode) return;
      settings.readingMode = newMode;
      saveSetting('reading-mode', newMode);
      applyAllSettings();
      updateSettingsUI();
    });

    function updateSettingsUI() {
      document.querySelectorAll('.theme-dot').forEach(d => {
        d.classList.toggle('active', d.dataset.theme === settings.theme);
      });
      document.querySelectorAll('.font-option').forEach(o => {
        o.classList.toggle('active', o.dataset.font === settings.fontFamily);
      });
      document.getElementById('font-size-slider').value = settings.fontSize;
      document.getElementById('font-size-val').textContent = settings.fontSize + 'px';
      document.getElementById('line-height-slider').value = settings.lineHeight;
      document.getElementById('line-height-val').textContent = settings.lineHeight.toFixed(1);
      document.getElementById('width-slider').value = settings.readingWidth;
      document.getElementById('width-val').textContent = settings.readingWidth + 'px';
      document.querySelectorAll('.mode-option').forEach(o => {
        o.classList.toggle('active', o.dataset.mode === settings.readingMode);
      });
    }

    // æ‰“å¼€/å…³é—­è®¾ç½®
    document.getElementById('bar-settings').addEventListener('click', () => {
      updateSettingsUI();
      settingsOverlay.classList.add('active');
    });
    document.getElementById('close-settings').addEventListener('click', () => {
      settingsOverlay.classList.remove('active');
    });
    settingsOverlay.addEventListener('click', (e) => {
      if (e.target === settingsOverlay) settingsOverlay.classList.remove('active');
    });

    // æ‰“å¼€/å…³é—­ç›®å½•
    document.getElementById('bar-toc').addEventListener('click', () => {
      tocOverlay.classList.add('active');
      // æ»šåŠ¨åˆ°å½“å‰ç« èŠ‚
      const cur = document.querySelector('.toc-list a.current');
      if (cur) cur.scrollIntoView({ block: 'center' });
    });
    tocOverlay.addEventListener('click', (e) => {
      if (e.target === tocOverlay) tocOverlay.classList.remove('active');
    });

    // ===== ç¿»é¡µæ¨¡å¼å¼•æ“ =====

    function applyReadingMode() {
      const isPager = settings.readingMode === 'pager';
      document.body.classList.toggle('pager-mode', isPager);
      pagerTapLeft.style.display = isPager ? 'block' : 'none';
      pagerTapRight.style.display = isPager ? 'block' : 'none';
      if (isPager) {
        pagerRecalc();
      } else {
        // åˆ‡å›æ»šåŠ¨æ¨¡å¼ï¼šæ¸…é™¤columnæ ·å¼å’Œtransform
        const content = document.querySelector('.reader-content');
        if (content) {
          // è®°ä½å½“å‰é˜…è¯»æ¯”ä¾‹
          const ratio = pagerState.totalPages > 1 ? pagerState.currentPage / (pagerState.totalPages - 1) : 0;
          content.style.transition = 'none';
          content.style.transform = '';
          content.style.height = '';
          content.style.columnWidth = '';
          content.style.columnGap = '';
          content.offsetHeight; // force reflow
          content.style.transition = '';
          // æ¢å¤æ»šåŠ¨ä½ç½®
          if (ratio > 0) {
            requestAnimationFrame(() => {
              const h = document.documentElement.scrollHeight - window.innerHeight;
              if (h > 0) window.scrollTo(0, h * ratio);
            });
          }
        }
        pagerIndicator.style.display = 'none';
      }
    }

    function pagerRecalc() {
      if (settings.readingMode !== 'pager') return;
      const content = document.querySelector('.reader-content');
      if (!content) return;
      // ä¿å­˜å½“å‰é˜…è¯»æ¯”ä¾‹
      const oldRatio = pagerState.totalPages > 1 ? pagerState.currentPage / (pagerState.totalPages - 1) : 0;
      // è·å–å®¹å™¨å¯ç”¨é«˜åº¦
      const reader = document.getElementById('reader-area');
      const readerRect = reader.getBoundingClientRect();
      const titleEl = reader.querySelector('h2');
      const titleH = titleEl ? titleEl.offsetHeight + 16 : 0;
      const availH = readerRect.height - titleH;
      if (availH <= 0) return;
      const colW = readerRect.width;
      pagerState.columnWidth = colW;
      // æ‰¹é‡è®¾ç½®æ ·å¼ï¼Œåªè§¦å‘ä¸€æ¬¡ reflow
      content.style.transition = 'none';
      content.style.transform = 'translateX(0)';
      content.style.height = availH + 'px';
      content.style.columnWidth = colW + 'px';
      content.style.columnGap = colW + 'px';
      // å•æ¬¡å¼ºåˆ¶ reflow è·å– scrollWidth
      const scrollW = content.scrollWidth;
      if (scrollW <= colW) {
        pagerState.totalPages = 1;
      } else {
        pagerState.totalPages = Math.round((scrollW / colW + 1) / 2);
      }
      pagerState.totalPages = Math.max(1, pagerState.totalPages);
      // æ¢å¤åˆ°ç›¸è¿‘çš„é¡µç 
      if (pagerState.totalPages > 1) {
        pagerState.currentPage = Math.min(Math.round(oldRatio * (pagerState.totalPages - 1)), pagerState.totalPages - 1);
      } else {
        pagerState.currentPage = 0;
      }
      pagerState.currentPage = Math.max(0, pagerState.currentPage);
      pagerGoTo(pagerState.currentPage, false);
    }

    function pagerGoTo(page, animate) {
      const content = document.querySelector('.reader-content');
      if (!content) return;
      page = Math.max(0, Math.min(page, pagerState.totalPages - 1));
      pagerState.currentPage = page;
      const offset = page * pagerState.columnWidth * 2;
      if (animate === false) {
        content.style.transition = 'none';
      } else {
        content.style.transition = 'transform 0.35s cubic-bezier(0.25, 0.46, 0.45, 0.94)';
      }
      content.style.transform = 'translateX(-' + offset + 'px)';
      if (animate === false) {
        // force reflow then restore transition
        content.offsetHeight;
        content.style.transition = '';
      }
      pagerUpdateIndicator();
      // ä¿å­˜è¿›åº¦ï¼ˆç”¨é¡µç æ¯”ä¾‹æ¨¡æ‹ŸscrollPctï¼‰
      if (window._chapterMeta) {
        const m = window._chapterMeta;
        const pct = pagerState.totalPages > 1 ? page / (pagerState.totalPages - 1) : 0;
        try {
          const progress = {
            chapterId: m.chapterId, chapterTitle: m.chapterTitle,
            bookTitle: m.bookTitle, bookId: m.bookId,
            scrollPct: pct, time: Date.now()
          };
          localStorage.setItem('reading_' + m.bookId, JSON.stringify(progress));
        } catch {}
      }
    }

    function pagerUpdateIndicator() {
      pagerIndicator.textContent = (pagerState.currentPage + 1) + ' / ' + pagerState.totalPages;
    }

    function pagerNext() {
      if (pagerState.currentPage < pagerState.totalPages - 1) {
        pagerGoTo(pagerState.currentPage + 1, true);
      } else if (nextUrl) {
        location.href = nextUrl;
      }
    }

    function pagerPrev() {
      if (pagerState.currentPage > 0) {
        pagerGoTo(pagerState.currentPage - 1, true);
      } else if (prevUrl) {
        location.href = prevUrl;
      }
    }

    // ç¿»é¡µç‚¹å‡»åŒºåŸŸ
    pagerTapLeft.addEventListener('click', (e) => { e.stopPropagation(); pagerPrev(); });
    pagerTapRight.addEventListener('click', (e) => { e.stopPropagation(); pagerNext(); });

    // è§¦æ‘¸æ»‘åŠ¨ç¿»é¡µ
    let touchStartX = 0, touchStartY = 0, touchStartTime = 0;
    document.addEventListener('touchstart', (e) => {
      if (settings.readingMode !== 'pager') return;
      if (e.target.closest('.settings-panel') || e.target.closest('.toc-panel') || e.target.closest('.reader-bottom-bar')) return;
      touchStartX = e.touches[0].clientX;
      touchStartY = e.touches[0].clientY;
      touchStartTime = Date.now();
    }, { passive: true });

    document.addEventListener('touchend', (e) => {
      if (settings.readingMode !== 'pager') return;
      if (e.target.closest('.settings-panel') || e.target.closest('.toc-panel') || e.target.closest('.reader-bottom-bar')) return;
      const dx = e.changedTouches[0].clientX - touchStartX;
      const dy = e.changedTouches[0].clientY - touchStartY;
      const dt = Date.now() - touchStartTime;
      // æ°´å¹³æ»‘åŠ¨è·ç¦»>50pxï¼Œä¸”æ°´å¹³>å‚ç›´ï¼Œä¸”æ—¶é—´<500ms
      if (Math.abs(dx) > 50 && Math.abs(dx) > Math.abs(dy) && dt < 500) {
        if (dx < 0) pagerNext();
        else pagerPrev();
      }
    }, { passive: true });

    // resizeæ—¶é‡æ–°è®¡ç®—
    let resizeTimer = null;
    window.addEventListener('resize', () => {
      if (settings.readingMode !== 'pager') return;
      if (resizeTimer) clearTimeout(resizeTimer);
      resizeTimer = setTimeout(pagerRecalc, 200);
    });

    // ===== åº•éƒ¨å·¥å…·æ æ˜¾ç¤º/éšè— =====
    const bottomBar = document.getElementById('bottom-bar');
    let barVisible = true;
    bottomBar.classList.add('visible');

    document.getElementById('reader-area').addEventListener('click', (e) => {
      if (immersiveActive) return; // æ²‰æµ¸æ¨¡å¼ä¸‹ç”±ä¸“é—¨çš„handlerå¤„ç†
      if (e.target.closest('a') || e.target.closest('button') || e.target.closest('.reader-nav')) return;
      // ç¿»é¡µæ¨¡å¼ä¸‹ï¼Œä¸­é—´åŒºåŸŸç‚¹å‡»åˆ‡æ¢å·¥å…·æ ï¼ˆå·¦å³åŒºåŸŸç”±tap zoneå¤„ç†ï¼‰
      if (settings.readingMode === 'pager') {
        const x = e.clientX;
        const w = window.innerWidth;
        if (x < w * 0.35 || x > w * 0.65) return; // å·¦å³åŒºåŸŸä¸å¤„ç†
      }
      barVisible = !barVisible;
      bottomBar.classList.toggle('visible', barVisible);
    });

    // ===== è¿›åº¦æ¡ + æ»šåŠ¨ä½ç½®è®°å¿† =====
    let scrollSaveTimer = null;
    window.addEventListener('scroll', () => {
      if (settings.readingMode === 'pager') return;
      const h = document.documentElement.scrollHeight - window.innerHeight;
      const pct = h > 0 ? (window.scrollY / h * 100) : 0;
      document.getElementById('progress-bar').style.width = pct + '%';
      document.getElementById('back-top').classList.toggle('visible', window.scrollY > 400);

      // èŠ‚æµä¿å­˜æ»šåŠ¨ä½ç½®
      if (scrollSaveTimer) clearTimeout(scrollSaveTimer);
      scrollSaveTimer = setTimeout(saveScrollPosition, 1000);
    });

    function saveScrollPosition() {
      if (!window._chapterMeta) return;
      if (settings.readingMode === 'pager') return; // pageræ¨¡å¼åœ¨pagerGoToä¸­ä¿å­˜
      const m = window._chapterMeta;
      const h = document.documentElement.scrollHeight - window.innerHeight;
      const pct = h > 0 ? (window.scrollY / h) : 0;
      const progress = {
        chapterId: m.chapterId, chapterTitle: m.chapterTitle,
        bookTitle: m.bookTitle, bookId: m.bookId,
        scrollPct: pct, time: Date.now()
      };
      localStorage.setItem(`reading_${m.bookId}`, JSON.stringify(progress));
    }

    // ===== é”®ç›˜å¿«æ·é”® =====
    let prevUrl = null, nextUrl = null, backUrl = null;
    document.addEventListener('keydown', (e) => {
      if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') return;
      if (e.key === 'ArrowLeft') {
        if (settings.readingMode === 'pager') pagerPrev();
        else if (prevUrl) location.href = prevUrl;
        return;
      }
      if (e.key === 'ArrowRight') {
        if (settings.readingMode === 'pager') pagerNext();
        else if (nextUrl) location.href = nextUrl;
        return;
      }
      if (e.key === 'Escape') {
        if (immersiveActive) { exitImmersive(); return; }
        if (document.fullscreenElement) { document.exitFullscreen(); return; }
        if (settingsOverlay.classList.contains('active')) settingsOverlay.classList.remove('active');
        else if (tocOverlay.classList.contains('active')) tocOverlay.classList.remove('active');
        else if (backUrl) location.href = backUrl;
      }
      if (e.key === 'i' || e.key === 'I') {
        toggleImmersive();
        return;
      }
      if (e.key === 't' || e.key === 'T') {
        const idx = THEMES.indexOf(settings.theme);
        settings.theme = THEMES[(idx + 1) % THEMES.length];
        saveSetting('theme', settings.theme);
        applyAllSettings(); updateSettingsUI();
      }
      if (e.key === 'f' || e.key === 'F') {
        if (document.fullscreenElement) document.exitFullscreen();
        else document.documentElement.requestFullscreen().catch(() => {});
      }
      if (e.key === 's' || e.key === 'S') {
        settingsOverlay.classList.toggle('active');
      }
    });

    // ===== åŠ è½½ç«™ç‚¹è®¾ç½® =====
    fetch('/api/settings').then(r => r.json()).then(d => {
      const s = d.settings || {};
      if (s.site_name) document.querySelector('.navbar h1 a').textContent = 'ğŸ“š ' + s.site_name;
    }).catch(() => {});

    // ===== åŠ è½½è‡ªå®šä¹‰å­—ä½“ =====
    fetch('/api/fonts').then(r => r.json()).then(d => {
      const fonts = d.fonts || [];
      const container = document.getElementById('font-options');
      fonts.forEach(name => {
        const familyName = 'Custom-' + name.replace(/\.woff2$/i, '');
        const face = new FontFace(familyName, `url(/api/fonts/${encodeURIComponent(name)})`);
        face.load().then(loaded => {
          document.fonts.add(loaded);
          const div = document.createElement('div');
          div.className = 'font-option';
          div.dataset.font = `'${familyName}'`;
          div.style.fontFamily = familyName;
          div.textContent = name.replace(/\.woff2$/i, '');
          container.appendChild(div);
          // å¦‚æœå½“å‰é€‰ä¸­çš„å°±æ˜¯è¿™ä¸ªå­—ä½“ï¼Œæ ‡è®°active
          if (settings.fontFamily === `'${familyName}'`) div.classList.add('active');
        }).catch(() => {}); // åŠ è½½å¤±è´¥é™é»˜å¿½ç•¥
      });
    }).catch(() => {});

    // ===== é¢„åŠ è½½ç¼“å­˜ =====
    let prefetchedNext = null;

    // ===== åŠ è½½ç« èŠ‚ =====
    const chapterId = new URLSearchParams(location.search).get('id');
    if (!chapterId || !/^\d+$/.test(chapterId)) {
      document.getElementById('content').innerHTML = '<div class="msg msg-error">æ— æ•ˆçš„ç« èŠ‚ID</div>';
    } else {
      loadChapter();
    }

    async function loadChapter() {
      const el = document.getElementById('content');
      try {
        // æ£€æŸ¥æ˜¯å¦æœ‰é¢„åŠ è½½ç¼“å­˜
        let data;
        if (prefetchedNext && prefetchedNext.chapter && String(prefetchedNext.chapter.id) === chapterId) {
          data = prefetchedNext;
          prefetchedNext = null;
        } else {
          const res = await fetch(`/api/chapters/${chapterId}`);
          if (!res.ok) throw new Error(res.status === 404 ? 'ç« èŠ‚ä¸å­˜åœ¨' : 'åŠ è½½å¤±è´¥');
          data = await res.json();
        }
        const c = data.chapter;

        // å­˜å‚¨å…ƒæ•°æ®
        window._chapterMeta = {
          chapterId: c.id, chapterTitle: c.title,
          bookTitle: c.book_title, bookId: c.book_id
        };
        window._chapterData = { content: data.content, title: c.title };

        // SEO
        document.title = esc(c.title) + ' - ' + esc(c.book_title);
        const metaDesc = document.querySelector('meta[name="description"]');
        if (metaDesc) metaDesc.content = `${c.book_title} - ${c.title}`;

        // é¢åŒ…å±‘
        backUrl = `/book.html?id=${c.book_id}`;
        document.getElementById('back-link').href = backUrl;
        document.getElementById('breadcrumb').innerHTML =
          `<a href="/">ä¹¦æ¶</a><span>â€º</span><a href="/book.html?id=${c.book_id}">${esc(c.book_title)}</a><span>â€º</span>${esc(c.title)}`;

        // æ­£æ–‡ â€” æŒ‰æ®µè½æ¸²æŸ“ä¸º <p>ï¼ˆæ‰¹æ³¨ç³»ç»Ÿä¾èµ–æ®µè½ç´¢å¼•ï¼‰
        const contentDiv = document.createElement('div');
        contentDiv.className = 'reader-content';
        const rawParagraphs = data.content.split('\n');
        rawParagraphs.forEach((text, idx) => {
          if (!text.trim()) return; // è·³è¿‡ç©ºè¡Œï¼Œä½†ä¿ç•™åŸå§‹ç´¢å¼•
          const p = document.createElement('p');
          p.textContent = text;
          p.dataset.paraIdx = idx;
          contentDiv.appendChild(p);
        });
        currentBookId = c.book_id;
        currentChapterId = c.id;

        // å¯¼èˆª
        prevUrl = data.prevChapter ? `/read.html?id=${data.prevChapter.id}` : null;
        nextUrl = data.nextChapter ? `/read.html?id=${data.nextChapter.id}` : null;

        const nav = document.createElement('div');
        nav.className = 'reader-nav';
        nav.innerHTML = `
          ${prevUrl ? `<a href="${prevUrl}">â† ${esc(data.prevChapter.title)}</a>` : '<span class="disabled">å·²æ˜¯ç¬¬ä¸€ç« </span>'}
          <a href="/book.html?id=${c.book_id}">ç›®å½•</a>
          <a href="#" id="export-btn" style="font-size:13px">å¯¼å‡ºTXT</a>
          <a href="#" id="download-book-btn" style="font-size:13px">ğŸ“¥ ç¼“å­˜å…¨ä¹¦</a>
          ${nextUrl ? `<a href="${nextUrl}">${esc(data.nextChapter.title)} â†’</a>` : '<span class="disabled">å·²æ˜¯æœ€æ–°ç« </span>'}
        `;

        el.innerHTML = `<h2>${esc(c.title)}</h2>`;
        el.appendChild(contentDiv);
        el.appendChild(nav);

        // å¯¼å‡ºæŒ‰é’®äº‹ä»¶
        document.getElementById('export-btn').addEventListener('click', (e) => { e.preventDefault(); exportThis(); });

        // ç¼“å­˜å…¨ä¹¦æŒ‰é’®
        document.getElementById('download-book-btn').addEventListener('click', async (e) => {
          e.preventDefault();
          const btn = e.target;
          try {
            btn.textContent = 'ğŸ“¥ è·å–ç›®å½•...';
            const bRes = await fetch(`/api/books/${c.book_id}`);
            const bData = await bRes.json();
            const chs = bData.chapters || [];
            if (chs.length === 0) { btn.textContent = 'ğŸ“¥ æ— ç« èŠ‚'; return; }
            let done = 0;
            for (const ch of chs) {
              await fetch(`/api/chapters/${ch.id}`);
              done++;
              btn.textContent = `ğŸ“¥ ${done}/${chs.length}`;
            }
            btn.textContent = 'âœ… ç¼“å­˜å®Œæˆ';
          } catch (err) {
            btn.textContent = 'âŒ ç¼“å­˜å¤±è´¥';
          }
        });

        // åº•éƒ¨å·¥å…·æ æŒ‰é’®
        document.getElementById('bar-prev').onclick = () => { if (prevUrl) location.href = prevUrl; };
        document.getElementById('bar-next').onclick = () => { if (nextUrl) location.href = nextUrl; };
        document.getElementById('bar-prev').style.opacity = prevUrl ? '1' : '0.3';
        document.getElementById('bar-next').style.opacity = nextUrl ? '1' : '0.3';

        // ä¿å­˜é˜…è¯»è¿›åº¦
        saveScrollPosition();

        // é˜…è¯»ç»Ÿè®¡ï¼šè®°å½•ç« èŠ‚å­—æ•°å’Œé˜…è¯»å¤©æ•°
        trackReadingStats(c.id, data.content.length);

        // æ›´æ–°ä¹¦ç­¾å›¾æ ‡
        updateBookmarkIcon();

        // æ¢å¤æ»šåŠ¨ä½ç½®
        restoreScrollPosition(c.book_id, c.id);

        // åŠ è½½ç›®å½•
        loadTOC(c.book_id, c.id);

        // é¢„åŠ è½½ä¸‹ä¸€ç« 
        if (data.nextChapter) {
          setTimeout(() => {
            fetch(`/api/chapters/${data.nextChapter.id}`)
              .then(r => r.json())
              .then(d => { prefetchedNext = d; })
              .catch(() => {});
          }, 2000);
        }

        // åˆå§‹åŒ–æ‰¹æ³¨ç³»ç»Ÿ
        initAnnotations();
      } catch (e) {
        el.innerHTML = `<div class="msg msg-error">${esc(e.message)}</div>`;
      }
    }

    function restoreScrollPosition(bookId, currentChapterId) {
      try {
        const saved = JSON.parse(localStorage.getItem(`reading_${bookId}`));
        if (saved && saved.chapterId === currentChapterId && saved.scrollPct > 0) {
          if (settings.readingMode === 'pager') {
            // ç¿»é¡µæ¨¡å¼ï¼šå»¶è¿Ÿåˆ°åˆ†é¡µè®¡ç®—åæ¢å¤
            requestAnimationFrame(() => {
              requestAnimationFrame(() => {
                pagerRecalc();
                const page = Math.round(saved.scrollPct * (pagerState.totalPages - 1));
                pagerGoTo(page, false);
              });
            });
          } else {
            // æ»šåŠ¨æ¨¡å¼ï¼šæ¢å¤æ»šåŠ¨ä½ç½®
            requestAnimationFrame(() => {
              const h = document.documentElement.scrollHeight - window.innerHeight;
              if (h > 0) window.scrollTo(0, h * saved.scrollPct);
            });
          }
        } else if (settings.readingMode === 'pager') {
          // æ²¡æœ‰ä¿å­˜çš„ä½ç½®ï¼Œä½†éœ€è¦åˆå§‹åŒ–åˆ†é¡µ
          requestAnimationFrame(() => {
            requestAnimationFrame(() => { pagerRecalc(); });
          });
        }
      } catch {
        if (settings.readingMode === 'pager') {
          requestAnimationFrame(() => {
            requestAnimationFrame(() => { pagerRecalc(); });
          });
        }
      }
    }

    async function loadTOC(bookId, currentChapterId) {
      try {
        const res = await fetch(`/api/books/${bookId}`);
        const data = await res.json();
        const list = document.getElementById('toc-list');
        document.getElementById('toc-title').textContent = data.book.title;
        list.innerHTML = (data.chapters || []).map(ch =>
          `<li><a href="/read.html?id=${ch.id}" class="${ch.id === currentChapterId ? 'current' : ''}">${esc(ch.title)}</a></li>`
        ).join('');
      } catch {}
    }

    function esc(s) {
      const d = document.createElement('div');
      d.textContent = s || '';
      return d.innerHTML;
    }

    function exportThis() {
      if (!window._chapterData) return;
      const BOM = '\uFEFF';
      const blob = new Blob([BOM + window._chapterData.content], {type:'text/plain;charset=utf-8'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = (window._chapterData.title + '.txt').replace(/[<>:"/\\|?*]/g, '_');
      a.click();
      URL.revokeObjectURL(url);
    }

    // ===== ä¹¦ç­¾åŠŸèƒ½ =====
    function getBookmarks(bookId) {
      try { return JSON.parse(localStorage.getItem(`bookmarks_${bookId}`)) || []; }
      catch { return []; }
    }
    function saveBookmarks(bookId, bookmarks) {
      localStorage.setItem(`bookmarks_${bookId}`, JSON.stringify(bookmarks));
    }
    function isBookmarked() {
      if (!window._chapterMeta) return false;
      const m = window._chapterMeta;
      const bms = getBookmarks(m.bookId);
      return bms.some(b => b.chapterId === m.chapterId);
    }
    function updateBookmarkIcon() {
      document.getElementById('bookmark-icon').textContent = isBookmarked() ? 'â˜…' : 'â˜†';
    }
    function toggleBookmark() {
      if (!window._chapterMeta) return;
      const m = window._chapterMeta;
      let bms = getBookmarks(m.bookId);
      const idx = bms.findIndex(b => b.chapterId === m.chapterId);
      if (idx >= 0) {
        bms.splice(idx, 1);
      } else {
        const h = document.documentElement.scrollHeight - window.innerHeight;
        const pct = h > 0 ? (window.scrollY / h) : 0;
        bms.push({
          chapterId: m.chapterId, chapterTitle: m.chapterTitle,
          scrollPct: pct, time: Date.now()
        });
      }
      saveBookmarks(m.bookId, bms);
      updateBookmarkIcon();
    }
    document.getElementById('bar-bookmark').addEventListener('click', toggleBookmark);

    // ===== é˜…è¯»ç»Ÿè®¡ =====
    function getReadingStats() {
      try { return JSON.parse(localStorage.getItem('readingStats')) || {}; } catch { return {}; }
    }
    function saveReadingStats(s) {
      localStorage.setItem('readingStats', JSON.stringify(s));
    }
    function trackReadingStats(chId, charCount) {
      const s = getReadingStats();
      if (!s.totalSeconds) s.totalSeconds = 0;
      if (!s.totalChars) s.totalChars = 0;
      if (!Array.isArray(s.readChapterIds)) s.readChapterIds = [];
      if (!Array.isArray(s.days)) s.days = [];
      // è®°å½•ä»Šå¤©
      const today = new Date().toISOString().slice(0, 10);
      if (!s.days.includes(today)) s.days.push(today);
      // é¦–æ¬¡é˜…è¯»è¯¥ç« èŠ‚æ‰ç´¯åŠ å­—æ•°
      if (!s.readChapterIds.includes(chId)) {
        s.readChapterIds.push(chId);
        s.totalChars += charCount;
      }
      s.lastActiveDate = today;
      saveReadingStats(s);
    }
    // æ¯30ç§’ç´¯åŠ é˜…è¯»æ—¶é•¿
    setInterval(() => {
      if (document.hidden) return;
      const s = getReadingStats();
      s.totalSeconds = (s.totalSeconds || 0) + 30;
      saveReadingStats(s);
    }, 30000);

    // ===== æ²‰æµ¸æ¨¡å¼ =====
    const immersiveHint = document.getElementById('immersive-hint');

    function toggleImmersive() {
      immersiveActive = !immersiveActive;
      document.body.classList.toggle('immersive', immersiveActive);
      if (immersiveActive) {
        document.documentElement.requestFullscreen().catch(() => {});
        // æ˜¾ç¤ºé€€å‡ºæç¤º
        immersiveHint.classList.add('show');
        setTimeout(() => immersiveHint.classList.remove('show'), 2000);
      } else {
        if (document.fullscreenElement) document.exitFullscreen().catch(() => {});
      }
      // ç¿»é¡µæ¨¡å¼éœ€è¦é‡æ–°è®¡ç®—
      if (settings.readingMode === 'pager') {
        requestAnimationFrame(() => requestAnimationFrame(() => pagerRecalc()));
      }
    }

    function exitImmersive() {
      if (!immersiveActive) return;
      immersiveActive = false;
      document.body.classList.remove('immersive');
      if (document.fullscreenElement) document.exitFullscreen().catch(() => {});
      if (settings.readingMode === 'pager') {
        requestAnimationFrame(() => requestAnimationFrame(() => pagerRecalc()));
      }
    }

    document.getElementById('bar-immersive').addEventListener('click', toggleImmersive);

    // æ²‰æµ¸æ¨¡å¼ä¸‹ä¸­å¤®åŒºåŸŸç‚¹å‡»é€€å‡º
    document.getElementById('reader-area').addEventListener('click', (e) => {
      if (!immersiveActive) return;
      if (e.target.closest('a') || e.target.closest('button')) return;
      const x = e.clientX, w = window.innerWidth;
      // ç¿»é¡µæ¨¡å¼ä¸‹å·¦å³åŒºåŸŸç”¨äºç¿»é¡µï¼Œåªæœ‰ä¸­å¤®é€€å‡º
      if (settings.readingMode === 'pager') {
        if (x > w * 0.3 && x < w * 0.7) exitImmersive();
      } else {
        // æ»šåŠ¨æ¨¡å¼ä¸‹ç‚¹å‡»ä¸­å¤®é€€å‡º
        if (x > w * 0.25 && x < w * 0.75) exitImmersive();
      }
    });

    // Escé€€å‡ºæ²‰æµ¸
    document.addEventListener('fullscreenchange', () => {
      if (!document.fullscreenElement && immersiveActive) {
        immersiveActive = false;
        document.body.classList.remove('immersive');
        if (settings.readingMode === 'pager') {
          requestAnimationFrame(() => requestAnimationFrame(() => pagerRecalc()));
        }
      }
    });

    // ===== PWA Service Worker =====
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('/sw.js').catch(() => {});
    }

    // ===== æ‰¹æ³¨ç³»ç»Ÿ =====
    let annoState = {
      paraIdx: null, sentIdx: null, sentText: '', sentHash: '',
      visibility: 'private', editing: false
    };

    async function initAnnotations() {
      await fetchCurrentUser();
      // æ£€æŸ¥ä¹¦ç±æ˜¯å¦å…è®¸æ‰¹æ³¨
      if (currentBookId) {
        try {
          const res = await fetch(`/api/books/${currentBookId}`);
          if (res.ok) {
            const data = await res.json();
            canAnnotate = currentUser && data.book?.annotation_enabled && !data.book?.annotation_locked;
          }
        } catch {}
      }
      // æ¸²æŸ“å·²æœ‰æ‰¹æ³¨ä¸‹åˆ’çº¿
      await renderAnnotationUnderlines();
      // ç»‘å®šäº¤äº’äº‹ä»¶
      if (canAnnotate) bindAnnotationEvents();
    }

    // --- ä¸‹åˆ’çº¿æ¸²æŸ“ ---
    function getTextNodes(el) {
      const nodes = [];
      const walker = document.createTreeWalker(el, NodeFilter.SHOW_TEXT);
      let node;
      while ((node = walker.nextNode())) nodes.push(node);
      return nodes;
    }

    function findTextInParagraph(p, targetText, sentIdx) {
      // ç”¨ splitSentences ç²¾ç¡®å®šä½åç§»é‡ï¼Œé¿å… indexOf é‡å¤æ–‡æœ¬é—®é¢˜ï¼ˆğŸŸ¡-5 ä¿®å¤ï¼‰
      const fullText = p.textContent;
      const sentences = splitSentences(fullText);
      let start = 0;
      for (let i = 0; i < sentences.length && i < sentIdx; i++) {
        const idx = fullText.indexOf(sentences[i], start);
        if (idx >= 0) start = idx + sentences[i].length;
      }
      const exactStart = fullText.indexOf(targetText, start);
      if (exactStart < 0) return null;
      const end = exactStart + targetText.length;

      const textNodes = getTextNodes(p);
      let charCount = 0;
      let startNode = null, startOffset = 0, endNode = null, endOffset = 0;
      for (const tn of textNodes) {
        const tnEnd = charCount + tn.length;
        if (!startNode && exactStart < tnEnd) {
          startNode = tn;
          startOffset = exactStart - charCount;
        }
        if (end <= tnEnd) {
          endNode = tn;
          endOffset = end - charCount;
          break;
        }
        charCount = tnEnd;
      }
      if (!startNode || !endNode) return null;
      const range = document.createRange();
      range.setStart(startNode, startOffset);
      range.setEnd(endNode, endOffset);
      return range;
    }

    // å®‰å…¨é«˜äº®ï¼šå¤„ç† range è·¨è¶Šå·²æœ‰ span èŠ‚ç‚¹çš„æƒ…å†µï¼ˆğŸ”´-2 ä¿®å¤ï¼‰
    function highlightRange(range, span) {
      // å¦‚æœ start å’Œ end åœ¨åŒä¸€ä¸ªæ–‡æœ¬èŠ‚ç‚¹ï¼ŒsurroundContents å®‰å…¨
      if (range.startContainer === range.endContainer && range.startContainer.nodeType === 3) {
        range.surroundContents(span);
        return span;
      }
      // è·¨èŠ‚ç‚¹ï¼šæå–å†…å®¹å†åŒ…è£¹
      try {
        const fragment = range.extractContents();
        span.appendChild(fragment);
        range.insertNode(span);
        return span;
      } catch {
        return null;
      }
    }

    async function renderAnnotationUnderlines() {
      if (!currentChapterId) return;
      try {
        const res = await annoApi('GET', `/api/annotations/summary?chapterId=${currentChapterId}`);
        if (!res.ok) return;
        const { sentences } = await res.json();
        if (!sentences || !sentences.length) return;

        const paragraphs = document.querySelectorAll('.reader-content p[data-para-idx]');
        const paraMap = {};
        paragraphs.forEach(p => { paraMap[p.dataset.paraIdx] = p; });

        for (const s of sentences) {
          const p = paraMap[s.para_idx];
          if (!p) continue;
          const sents = splitSentences(p.textContent);
          if (!sents[s.sent_idx]) continue;

          const range = findTextInParagraph(p, sents[s.sent_idx], s.sent_idx);
          if (!range) continue;

          const span = document.createElement('span');
          span.className = 'annotated';
          span.dataset.paraIdx = s.para_idx;
          span.dataset.sentIdx = s.sent_idx;

          const hasPublic = s.public_count > 0;
          const hasPrivate = s.private_count > 0;
          if (hasPublic && hasPrivate) {
            span.classList.add('has-both');
          } else if (hasPublic) {
            span.classList.add('has-public');
          } else {
            span.classList.add('private-only');
          }

          const totalVisible = s.public_count + (s.has_mine ? 1 : 0);
          span.style.setProperty('--anno-opacity', annotationOpacity(totalVisible));

          span.addEventListener('click', (e) => {
            e.stopPropagation();
            showAnnotationPopover(s.para_idx, s.sent_idx, span);
          });

          highlightRange(range, span);
        }

        // ç¿»é¡µæ¨¡å¼ä¸‹é‡æ–°è®¡ç®—åˆ†é¡µ
        if (settings.readingMode === 'pager') {
          requestAnimationFrame(() => requestAnimationFrame(() => pagerRecalc()));
        }
      } catch {}
    }

    // --- æŸ¥çœ‹æ‰¹æ³¨å¼¹çª— ---
    async function showAnnotationPopover(paraIdx, sentIdx, anchorEl) {
      const popover = document.getElementById('anno-popover');
      try {
        const res = await annoApi('GET',
          `/api/annotations?chapterId=${currentChapterId}&paraIdx=${paraIdx}&sentIdx=${sentIdx}`);
        if (!res.ok) return;
        const { annotations } = await res.json();

        if (!annotations || !annotations.length) {
          popover.style.display = 'none';
          return;
        }

        popover.innerHTML = annotations.map(a => `
          <div class="anno-popover-item">
            <div class="anno-popover-content">${esc(a.content)}</div>
            <div class="anno-popover-meta">
              ${esc(a.username || 'åŒ¿å')} Â· ${timeAgo(a.created_at)}
              ${a.visibility === 'private' ? ' Â· ğŸ”’' : ''}
            </div>
            <div class="anno-popover-actions">
              ${a.is_mine ? `<button class="btn-link anno-delete-btn" data-id="${Number(a.id)}">åˆ é™¤</button>` : ''}
            </div>
          </div>
        `).join('');

        // å®šä½
        const rect = anchorEl.getBoundingClientRect();
        popover.style.display = 'block';
        const popRect = popover.getBoundingClientRect();
        let top = rect.bottom + 8;
        let left = rect.left + rect.width / 2 - popRect.width / 2;
        // è¾¹ç•Œæ£€æµ‹
        if (top + popRect.height > window.innerHeight) top = rect.top - popRect.height - 8;
        if (left < 8) left = 8;
        if (left + popRect.width > window.innerWidth - 8) left = window.innerWidth - popRect.width - 8;
        popover.style.top = top + 'px';
        popover.style.left = left + 'px';

        // äº‹ä»¶å§”æ‰˜ç»‘å®šåˆ é™¤æŒ‰é’®ï¼ˆğŸŸ¡-2 ä¿®å¤ï¼‰
        popover.querySelectorAll('.anno-delete-btn').forEach(btn => {
          btn.onclick = () => deleteAnnotation(Number(btn.dataset.id));
        });
      } catch {}
    }

    function timeAgo(dateStr) {
      const diff = Date.now() - new Date(dateStr + 'Z').getTime();
      const m = Math.floor(diff / 60000);
      if (m < 1) return 'åˆšåˆš';
      if (m < 60) return m + 'åˆ†é’Ÿå‰';
      const h = Math.floor(m / 60);
      if (h < 24) return h + 'å°æ—¶å‰';
      const d = Math.floor(h / 24);
      if (d < 30) return d + 'å¤©å‰';
      return new Date(dateStr).toLocaleDateString('zh-CN');
    }

    async function deleteAnnotation(id) {
      if (!confirm('ç¡®å®šåˆ é™¤è¿™æ¡æ‰¹æ³¨ï¼Ÿ')) return;
      try {
        const res = await annoApi('DELETE', `/api/annotations/${id}`);
        if (res.ok) {
          document.getElementById('anno-popover').style.display = 'none';
          await refreshAnnotations();
        } else {
          alert('åˆ é™¤å¤±è´¥');
        }
      } catch {
        alert('ç½‘ç»œé”™è¯¯');
      }
    }

    // æ¸…é™¤æ‰€æœ‰ä¸‹åˆ’çº¿å¹¶é‡æ–°æ¸²æŸ“ï¼ˆğŸŸ¡-3: æå–ä¸ºå…¬å…±å‡½æ•° + ğŸŸ¢-7: é”™è¯¯å¤„ç†ï¼‰
    async function refreshAnnotations() {
      document.querySelectorAll('.annotated').forEach(el => {
        const parent = el.parentNode;
        while (el.firstChild) parent.insertBefore(el.firstChild, el);
        parent.removeChild(el);
      });
      // åˆå¹¶ç›¸é‚»æ–‡æœ¬èŠ‚ç‚¹ï¼Œé˜²æ­¢ç¢ç‰‡åŒ–
      document.querySelectorAll('.reader-content p').forEach(p => p.normalize());
      await renderAnnotationUnderlines();
    }

    // --- äº¤äº’äº‹ä»¶ç»‘å®š ---
    function bindAnnotationEvents() {
      const readerContent = document.querySelector('.reader-content');
      if (!readerContent) return;

      // PC + ç§»åŠ¨ç«¯ç»Ÿä¸€ç”¨ selectionchange + æµ®åŠ¨æŒ‰é’®
      const selHandler = debounceSelection();
      document.addEventListener('selectionchange', selHandler);

      // é˜…è¯»åŒºåŸŸæ‹¦æˆªå³é”®èœå•ï¼ˆæœ‰é€‰åŒºæ—¶é˜»æ­¢æµè§ˆå™¨é»˜è®¤èœå•ï¼‰
      readerContent.addEventListener('contextmenu', (e) => {
        const sel = window.getSelection();
        if (sel && !sel.isCollapsed) e.preventDefault();
      });

      // mouseup åï¼šæŠ‘åˆ¶ Chrome é€‰ä¸­æ–‡æœ¬æµ®åŠ¨å·¥å…·æ  + è§¦å‘é€‰åŒºæ£€æµ‹
      readerContent.addEventListener('mouseup', (e) => {
        // å¦‚æœç‚¹å‡»çš„æ˜¯æµ®åŠ¨æŒ‰é’®ï¼Œä¸è¦å¹²æ‰°é€‰åŒº
        if (e.target.closest('#anno-float-btn')) return;
        setTimeout(() => {
          const sel = window.getSelection();
          if (!sel || sel.isCollapsed || sel.rangeCount === 0) return;
          // ä¿å­˜å½“å‰é€‰åŒºï¼Œcollapse å†æ¢å¤ â€” ç»•è¿‡ Chrome æµ®åŠ¨å·¥å…·æ 
          const range = sel.getRangeAt(0).cloneRange();
          sel.removeAllRanges();
          sel.addRange(range);
          selHandler();
        }, 10);
      });

      // æµ®åŠ¨æŒ‰é’®ï¼šmousedown ç›´æ¥è§¦å‘ç¼–è¾‘å™¨ï¼ˆæ¯” click æ›´å¯é ï¼‰
      const floatBtn = document.getElementById('anno-float-btn');
      floatBtn.addEventListener('mousedown', (e) => {
        e.preventDefault();
        e.stopPropagation();
        openAnnotationEditor();
      });

      // ç¼–è¾‘å™¨æŒ‰é’®
      document.getElementById('anno-vis-btn').addEventListener('click', toggleVisibility);
      document.getElementById('anno-cancel').addEventListener('click', closeAnnotationEditor);
      document.getElementById('anno-submit').addEventListener('click', submitAnnotation);

      // ç‚¹å‡»å¤–éƒ¨å…³é—­å¼¹çª—
      document.addEventListener('click', (e) => {
        const popover = document.getElementById('anno-popover');
        if (popover.style.display !== 'none' && !popover.contains(e.target) && !e.target.closest('.annotated')) {
          popover.style.display = 'none';
        }
        // ç‚¹å‡»éæµ®åŠ¨æŒ‰é’®ä¸”éé€‰åŒºæ—¶éšè—æµ®åŠ¨æŒ‰é’®
        const floatBtn = document.getElementById('anno-float-btn');
        if (floatBtn.classList.contains('visible') && !floatBtn.contains(e.target)) {
          const sel = window.getSelection();
          if (!sel || sel.isCollapsed) floatBtn.classList.remove('visible');
        }
      });

      // Escape å…³é—­
      document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape') {
          document.getElementById('anno-float-btn').classList.remove('visible');
          document.getElementById('anno-popover').style.display = 'none';
          if (annoState.editing) closeAnnotationEditor();
        }
      });

      // æ»šåŠ¨æ—¶å…³é—­æµ®åŠ¨æŒ‰é’®
      window.addEventListener('scroll', () => {
        document.getElementById('anno-float-btn').classList.remove('visible');
      }, { passive: true });
    }

    function debounceSelection() {
      let timer = null;
      return () => {
        clearTimeout(timer);
        timer = setTimeout(() => {
          const sel = window.getSelection();
          if (!sel || sel.isCollapsed || annoState.editing) {
            document.getElementById('anno-float-btn').classList.remove('visible');
            return;
          }
          const anchorEl = sel.anchorNode?.nodeType === 3 ? sel.anchorNode.parentElement : sel.anchorNode;
          const readerContent = document.querySelector('.reader-content');
          if (!readerContent || !readerContent.contains(anchorEl)) return;

          const p = anchorEl?.closest('p[data-para-idx]');
          if (!p) return;

          const paraIdx = parseInt(p.dataset.paraIdx);
          const paraText = p.textContent;
          const range = sel.getRangeAt(0);
          const preRange = document.createRange();
          preRange.setStart(p, 0);
          preRange.setEnd(range.startContainer, range.startOffset);
          const selStart = preRange.toString().length;
          const selEnd = selStart + sel.toString().length;

          const snapped = snapToSentence(paraText, selStart, selEnd);
          if (!snapped) return;

          annoState.paraIdx = paraIdx;
          annoState.sentIdx = snapped.sentIdx;
          annoState.sentText = snapped.text;

          const rect = range.getBoundingClientRect();
          const btn = document.getElementById('anno-float-btn');
          btn.classList.add('visible');
          btn.style.left = (rect.left + rect.width / 2 - 18) + 'px';
          btn.style.top = (rect.top - 44) + 'px';
        }, 300);
      };
    }

    // --- æ‰¹æ³¨ç¼–è¾‘å™¨ ---
    async function openAnnotationEditor() {
      document.getElementById('anno-float-btn').classList.remove('visible');

      annoState.editing = true;
      annoState.sentHash = await sentenceHash(annoState.sentText);

      const editor = document.getElementById('anno-editor');
      document.getElementById('anno-quote').textContent = annoState.sentText;
      document.getElementById('anno-input').value = '';
      annoState.visibility = 'private';
      const visBtn = document.getElementById('anno-vis-btn');
      visBtn.textContent = 'ğŸ”’ ä»…è‡ªå·±å¯è§';
      visBtn.classList.remove('public');

      editor.style.display = 'block';
      document.getElementById('anno-input').focus();

      // PC ç«¯å®šä½åˆ°é€‰åŒºé™„è¿‘
      if (window.innerWidth > 768) {
        const sel = window.getSelection();
        if (sel && !sel.isCollapsed) {
          const rect = sel.getRangeAt(0).getBoundingClientRect();
          editor.style.left = Math.max(8, Math.min(rect.left, window.innerWidth - 340)) + 'px';
          editor.style.top = (rect.bottom + 12) + 'px';
          // å¦‚æœè¶…å‡ºåº•éƒ¨ï¼Œæ”¾åˆ°ä¸Šæ–¹
          requestAnimationFrame(() => {
            const edRect = editor.getBoundingClientRect();
            if (edRect.bottom > window.innerHeight - 8) {
              editor.style.top = (rect.top - edRect.height - 12) + 'px';
            }
          });
        }
      }
    }

    function closeAnnotationEditor() {
      annoState.editing = false;
      document.getElementById('anno-editor').style.display = 'none';
    }

    function toggleVisibility() {
      const btn = document.getElementById('anno-vis-btn');
      if (annoState.visibility === 'private') {
        annoState.visibility = 'public';
        btn.textContent = 'ğŸŒ æ‰€æœ‰äººå¯è§';
        btn.classList.add('public');
      } else {
        annoState.visibility = 'private';
        btn.textContent = 'ğŸ”’ ä»…è‡ªå·±å¯è§';
        btn.classList.remove('public');
      }
    }

    async function submitAnnotation() {
      const content = document.getElementById('anno-input').value.trim();
      if (!content) return;
      if (content.length > 500) { alert('æ‰¹æ³¨å†…å®¹ä¸èƒ½è¶…è¿‡500å­—'); return; }

      const btn = document.getElementById('anno-submit');
      btn.disabled = true;
      btn.textContent = 'å‘è¡¨ä¸­...';

      try {
        const res = await annoApi('POST', '/api/annotations', {
          chapterId: currentChapterId,
          bookId: currentBookId,
          paraIdx: annoState.paraIdx,
          sentIdx: annoState.sentIdx,
          sentHash: annoState.sentHash,
          sentText: annoState.sentText,
          content: content,
          visibility: annoState.visibility
        });

        if (res.ok) {
          closeAnnotationEditor();
          await refreshAnnotations();
        } else {
          const err = await res.json().catch(() => ({}));
          alert(err.error || 'å‘è¡¨å¤±è´¥');
        }
      } catch (e) {
        alert('ç½‘ç»œé”™è¯¯');
      } finally {
        btn.disabled = false;
        btn.textContent = 'å‘è¡¨';
      }
    }
  </script>
</body>
</html>

