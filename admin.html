<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ç®¡ç†åå°</title>
  <link rel="stylesheet" href="/style.css">
</head>
<body>
  <div class="navbar">
    <h1><a href="/">ğŸ“š æˆ‘çš„ä¹¦æ¶</a></h1>
    <nav>
      <a href="/">è¿”å›ä¹¦æ¶</a>
      <span id="user-info" style="display:none;font-size:13px;color:var(--text-light)"></span>
      <button class="theme-toggle" onclick="toggleTheme()" title="åˆ‡æ¢ä¸»é¢˜">ğŸŒ™</button>
    </nav>
  </div>
  <div class="container">

    <!-- ç™»å½•ç•Œé¢ -->
    <div id="login-panel">
      <div class="admin-section" style="max-width:400px;margin:60px auto">
        <h3>ğŸ” ç®¡ç†å‘˜ç™»å½•</h3>
        <div class="form-group">
          <label>ç”¨æˆ·å</label>
          <input type="text" id="login-user" placeholder="admin" value="admin">
        </div>
        <div class="form-group">
          <label>å¯†ç </label>
          <input type="password" id="login-pass" placeholder="è¾“å…¥ç®¡ç†å¯†ç " onkeydown="if(event.key==='Enter')doLogin()">
        </div>
        <button class="btn" onclick="doLogin()" style="width:100%">ç™»å½•</button>
        <div id="login-msg" style="margin-top:8px"></div>
      </div>
    </div>

    <!-- ç®¡ç†é¢æ¿ï¼ˆç™»å½•åæ˜¾ç¤ºï¼‰ -->
    <div id="admin-panel" style="display:none">

      <!-- æ•°æ®æ¦‚è§ˆ -->
      <div class="admin-section" id="stats-panel">
        <h3>ğŸ“Š æ•°æ®æ¦‚è§ˆ</h3>
        <div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(140px,1fr));gap:12px" id="stats-grid">
          <div style="text-align:center;padding:16px;background:var(--bg);border-radius:var(--radius)">
            <div style="font-size:28px;font-weight:700;color:var(--accent)" id="stat-books">-</div>
            <div style="font-size:13px;color:var(--text-light)">ä¹¦ç±</div>
          </div>
          <div style="text-align:center;padding:16px;background:var(--bg);border-radius:var(--radius)">
            <div style="font-size:28px;font-weight:700;color:var(--accent)" id="stat-chapters">-</div>
            <div style="font-size:13px;color:var(--text-light)">ç« èŠ‚</div>
          </div>
          <div style="text-align:center;padding:16px;background:var(--bg);border-radius:var(--radius)">
            <div style="font-size:28px;font-weight:700;color:var(--accent)" id="stat-words">-</div>
            <div style="font-size:13px;color:var(--text-light)">æ€»å­—æ•°</div>
          </div>
        </div>
      </div>

      <!-- è´¦å·ç®¡ç† -->
      <div class="admin-section">
        <h3>ğŸ‘¤ è´¦å·ç®¡ç†</h3>
        <div style="display:flex;align-items:center;gap:12px;margin-bottom:12px">
          <span>å½“å‰ç”¨æˆ·ï¼š<strong id="current-user"></strong></span>
          <a href="#" onclick="showChangePassword();return false" style="font-size:13px">ä¿®æ”¹å¯†ç </a>
          <a href="#" onclick="doLogout();return false" style="font-size:13px;color:var(--danger,#e74c3c)">é€€å‡ºç™»å½•</a>
        </div>
        <div id="pwd-form" style="display:none">
          <div class="form-group">
            <label>æ—§å¯†ç </label>
            <input type="password" id="old-pwd" placeholder="è¾“å…¥å½“å‰å¯†ç ">
          </div>
          <div class="form-group">
            <label>æ–°å¯†ç ï¼ˆè‡³å°‘8ä½ï¼Œéœ€åŒ…å«å­—æ¯å’Œæ•°å­—ï¼‰</label>
            <input type="password" id="new-pwd" placeholder="è¾“å…¥æ–°å¯†ç ">
          </div>
          <div class="form-group">
            <label>ç¡®è®¤æ–°å¯†ç </label>
            <input type="password" id="new-pwd2" placeholder="å†æ¬¡è¾“å…¥æ–°å¯†ç ">
          </div>
          <button class="btn" onclick="doChangePassword()">ç¡®è®¤ä¿®æ”¹</button>
          <button class="btn btn-sm" onclick="document.getElementById('pwd-form').style.display='none'" style="margin-left:8px">å–æ¶ˆ</button>
          <div id="pwd-msg" style="margin-top:8px"></div>
        </div>
      </div>

      <!-- ç«™ç‚¹è®¾ç½® -->
      <div class="admin-section">
        <h3>âš™ï¸ ç«™ç‚¹è®¾ç½®</h3>
        <div class="form-group">
          <label>ç«™ç‚¹åç§°</label>
          <input type="text" id="set-site-name" placeholder="å¦‚ï¼šxingzihaiçš„ä¹¦æ¶" maxlength="100">
        </div>
        <div class="form-group">
          <label>ç«™ç‚¹æè¿°</label>
          <input type="text" id="set-site-desc" placeholder="ä¸€å¥è¯ä»‹ç»ä½ çš„å°è¯´ç«™" maxlength="200">
        </div>
        <div class="form-group">
          <label>é¡µè„šæ–‡å­—</label>
          <input type="text" id="set-footer" placeholder="å¦‚ï¼šPowered by Cloudflare" maxlength="200">
        </div>
        <button class="btn" onclick="saveSettings()">ä¿å­˜è®¾ç½®</button>
        <div id="settings-msg"></div>
      </div>

      <!-- TXTå¯¼å…¥ -->
      <div class="admin-section">
        <h3>ğŸ“¥ TXT å¯¼å…¥</h3>
        <div class="form-group">
          <label>é€‰æ‹©ç›®æ ‡ä¹¦ç± *ï¼ˆæˆ–å…ˆåˆ›å»ºæ–°ä¹¦ï¼‰</label>
          <select id="import-book"><option value="">åŠ è½½ä¸­...</option></select>
        </div>
        <div class="form-group">
          <label>é€‰æ‹© TXT æ–‡ä»¶ï¼ˆæ”¯æŒ UTF-8 / GBK ç¼–ç ï¼Œæœ€å¤§ 50MBï¼‰</label>
          <input type="file" id="import-file" accept=".txt,.text" style="padding:8px 0">
        </div>
        <div id="import-preview" style="display:none">
          <div class="form-group">
            <label>ç« èŠ‚åˆ†å‰²é¢„è§ˆï¼ˆå¯å–æ¶ˆå‹¾é€‰ä¸éœ€è¦çš„ç« èŠ‚ï¼‰</label>
            <div id="import-chapters" class="admin-list" style="max-height:300px;overflow-y:auto"></div>
            <div style="font-size:13px;color:var(--text-light);margin-top:6px">
              å…± <span id="import-total">0</span> ç« ï¼Œ<span id="import-words">0</span> å­—
            </div>
          </div>
          <div class="import-progress" style="display:none">
            <div style="background:var(--bg-secondary);border-radius:10px;overflow:hidden;height:20px;margin:12px 0">
              <div id="import-bar" style="height:100%;background:var(--primary);border-radius:10px;transition:width 0.3s;width:0%"></div>
            </div>
            <div id="import-status" style="font-size:13px;color:var(--text-light)"></div>
          </div>
          <button class="btn" onclick="startImport()">å¼€å§‹å¯¼å…¥</button>
          <button class="btn btn-sm" onclick="cancelImport()" style="margin-left:8px">å–æ¶ˆ</button>
        </div>
        <div id="import-msg"></div>
      </div>

      <!-- åˆ›å»ºä¹¦ç± -->
      <div class="admin-section">
        <h3>ğŸ“– åˆ›å»ºæ–°ä¹¦</h3>
        <div class="form-group">
          <label>ä¹¦å *</label>
          <input type="text" id="book-title" placeholder="è¾“å…¥ä¹¦å" maxlength="200">
        </div>
        <div class="form-group">
          <label>ä½œè€…</label>
          <input type="text" id="book-author" placeholder="è¾“å…¥ä½œè€…å" maxlength="100">
        </div>
        <div class="form-group">
          <label>ç®€ä»‹</label>
          <textarea id="book-desc" placeholder="è¾“å…¥ä¹¦ç±ç®€ä»‹" style="min-height:80px" maxlength="2000"></textarea>
        </div>
        <button class="btn" onclick="createBook()">åˆ›å»ºä¹¦ç±</button>
        <div id="book-msg"></div>
      </div>

      <!-- ä¹¦ç±ç®¡ç† -->
      <div class="admin-section">
        <h3>ğŸ“š ä¹¦ç±ç®¡ç†</h3>
        <ul class="admin-list" id="book-list"><li class="loading">åŠ è½½ä¸­...</li></ul>
      </div>

      <!-- æ·»åŠ ç« èŠ‚ -->
      <div class="admin-section">
        <h3>ğŸ“ æ·»åŠ ç« èŠ‚</h3>
        <div class="form-group">
          <label>é€‰æ‹©ä¹¦ç± *</label>
          <select id="chapter-book"><option value="">åŠ è½½ä¸­...</option></select>
        </div>
        <div class="form-group">
          <label>ç« èŠ‚æ ‡é¢˜ *</label>
          <input type="text" id="chapter-title" placeholder="å¦‚ï¼šç¬¬ä¸€ç«  åˆå…¥æ±Ÿæ¹–" maxlength="200">
        </div>
        <div class="form-group">
          <label>ç« èŠ‚å†…å®¹ *</label>
          <textarea id="chapter-content" placeholder="åœ¨æ­¤è¾“å…¥ç« èŠ‚æ­£æ–‡..."></textarea>
          <div style="font-size:12px;color:var(--text-light);margin-top:4px">å­—æ•°ï¼š<span id="word-count">0</span></div>
        </div>
        <button class="btn" onclick="createChapter()">å‘å¸ƒç« èŠ‚</button>
        <div id="chapter-msg"></div>
      </div>

      <!-- ç« èŠ‚ç®¡ç† -->
      <div class="admin-section">
        <h3>ğŸ“„ ç« èŠ‚ç®¡ç†</h3>
        <div class="form-group">
          <label>é€‰æ‹©ä¹¦ç±</label>
          <select id="manage-book" onchange="loadChapters()"><option value="">é€‰æ‹©ä¹¦ç±...</option></select>
        </div>
        <div id="batch-bar" style="display:none;margin-bottom:12px;padding:10px;background:var(--bg);border:1px solid var(--border);border-radius:var(--radius);display:flex;align-items:center;gap:12px">
          <label style="font-size:13px;display:flex;align-items:center;gap:4px"><input type="checkbox" id="select-all" onchange="toggleSelectAll(this.checked)">å…¨é€‰</label>
          <span style="font-size:13px;color:var(--text-light)" id="selected-count">å·²é€‰ 0 ç« </span>
          <button class="btn btn-danger btn-sm" onclick="batchDelete()">æ‰¹é‡åˆ é™¤</button>
        </div>
        <ul class="admin-list" id="chapter-list"></ul>
        <div style="margin-top:8px" id="export-area"></div>
        <div id="manage-msg"></div>
      </div>

      <!-- æ•°æ®å¤‡ä»½ä¸æ¢å¤ -->
      <div class="admin-section">
        <h3>ğŸ’¾ æ•°æ®å¤‡ä»½ä¸æ¢å¤</h3>
        <p style="font-size:13px;color:var(--text-light);margin-bottom:12px">å¯¼å‡ºå…¨ç«™æ•°æ®ï¼ˆä¹¦ç±+ç« èŠ‚æ­£æ–‡+è®¾ç½®ï¼‰ä¸º JSON æ–‡ä»¶ï¼Œæˆ–ä»å¤‡ä»½æ–‡ä»¶æ¢å¤ã€‚</p>
        <button class="btn" id="backup-btn" onclick="exportBackup()">å¯¼å‡ºå¤‡ä»½</button>
        <label class="btn" style="cursor:pointer;background:var(--accent-dark)">
          å¯¼å…¥æ¢å¤
          <input type="file" id="restore-file" accept=".json" style="display:none">
        </label>
        <div id="backup-progress" style="display:none;margin-top:12px">
          <div style="background:var(--border);border-radius:10px;overflow:hidden;height:20px">
            <div id="backup-bar" style="height:100%;background:var(--accent);border-radius:10px;transition:width 0.3s;width:0%"></div>
          </div>
          <div id="backup-status" style="font-size:13px;color:var(--text-light);margin-top:4px"></div>
        </div>
        <div id="backup-msg"></div>
      </div>

    </div><!-- /admin-panel -->
  </div>

  <script>
    // ===== ä¸»é¢˜ =====
    const THEMES = ['light','dark','green','sepia','blue'];
    const THEME_ICONS = {'light':'ğŸŒ™','dark':'â˜€ï¸','green':'ğŸƒ','sepia':'ğŸ“œ','blue':'ğŸ’§'};
    const savedTheme = localStorage.getItem('theme') || 'light';
    document.documentElement.setAttribute('data-theme', savedTheme);
    updateThemeBtn();
    function toggleTheme() {
      const current = document.documentElement.getAttribute('data-theme');
      const idx = THEMES.indexOf(current);
      const next = THEMES[(idx + 1) % THEMES.length];
      document.documentElement.setAttribute('data-theme', next);
      localStorage.setItem('theme', next);
      updateThemeBtn();
    }
    function updateThemeBtn() {
      const btn = document.querySelector('.theme-toggle');
      const t = document.documentElement.getAttribute('data-theme');
      btn.textContent = THEME_ICONS[t] || 'ğŸŒ™';
    }

    // ===== è®¤è¯ =====
    let authToken = sessionStorage.getItem('auth_token') || '';

    function getToken() { return authToken; }

    async function doLogin() {
      const username = document.getElementById('login-user').value.trim();
      const password = document.getElementById('login-pass').value;
      if (!username || !password) return showMsg('login-msg','è¯·è¾“å…¥ç”¨æˆ·åå’Œå¯†ç ','error');
      try {
        const res = await fetch('/api/auth?action=login', {
          method:'POST', headers:{'Content-Type':'application/json'},
          body: JSON.stringify({username, password})
        });
        const data = await res.json();
        if (!res.ok) throw new Error(data.error);
        authToken = data.token;
        sessionStorage.setItem('auth_token', authToken);
        showAdminPanel(data.username);
      } catch(e) { showMsg('login-msg', e.message, 'error'); }
    }

    async function checkSession() {
      if (!authToken) return false;
      try {
        const res = await fetch('/api/auth?action=me', {
          headers:{'Authorization':'Bearer '+authToken}
        });
        if (!res.ok) { authToken=''; sessionStorage.removeItem('auth_token'); return false; }
        const data = await res.json();
        if (data.authenticated) { showAdminPanel(data.username); return true; }
      } catch {}
      authToken=''; sessionStorage.removeItem('auth_token');
      return false;
    }

    function showAdminPanel(username) {
      document.getElementById('login-panel').style.display = 'none';
      document.getElementById('admin-panel').style.display = 'block';
      document.getElementById('current-user').textContent = username;
      document.getElementById('user-info').textContent = username;
      document.getElementById('user-info').style.display = 'inline';
      loadBookList(); loadBookSelects(); loadSettings(); loadStats();
    }

    async function doLogout() {
      try { await fetch('/api/auth?action=logout',{method:'POST',headers:{'Authorization':'Bearer '+authToken}}); } catch{}
      authToken = '';
      sessionStorage.removeItem('auth_token');
      document.getElementById('login-panel').style.display = 'block';
      document.getElementById('admin-panel').style.display = 'none';
      document.getElementById('user-info').style.display = 'none';
      document.getElementById('login-pass').value = '';
    }

    function showChangePassword() { document.getElementById('pwd-form').style.display = 'block'; }

    async function doChangePassword() {
      const oldPwd = document.getElementById('old-pwd').value;
      const newPwd = document.getElementById('new-pwd').value;
      const newPwd2 = document.getElementById('new-pwd2').value;
      if (!oldPwd || !newPwd) return showMsg('pwd-msg','è¯·å¡«å†™æ‰€æœ‰å­—æ®µ','error');
      if (newPwd !== newPwd2) return showMsg('pwd-msg','ä¸¤æ¬¡è¾“å…¥çš„æ–°å¯†ç ä¸ä¸€è‡´','error');
      if (newPwd.length < 8) return showMsg('pwd-msg','æ–°å¯†ç è‡³å°‘8ä½','error');
      if (!/[a-zA-Z]/.test(newPwd)||!/\d/.test(newPwd)) return showMsg('pwd-msg','æ–°å¯†ç éœ€åŒ…å«å­—æ¯å’Œæ•°å­—','error');
      try {
        const res = await api('POST','/api/auth?action=password',{oldPassword:oldPwd,newPassword:newPwd});
        const data = await res.json();
        if (!res.ok) throw new Error(data.error);
        showMsg('pwd-msg','å¯†ç å·²ä¿®æ”¹ï¼Œè¯·é‡æ–°ç™»å½•','success');
        setTimeout(()=>doLogout(), 2000);
      } catch(e) { showMsg('pwd-msg',e.message,'error'); }
    }

    // é¡µé¢åŠ è½½æ—¶æ£€æŸ¥session
    checkSession();

    // ===== ç«™ç‚¹è®¾ç½® =====
    async function loadSettings() {
      try {
        const res = await fetch('/api/settings');
        const data = await res.json();
        const s = data.settings || {};
        document.getElementById('set-site-name').value = s.site_name || '';
        document.getElementById('set-site-desc').value = s.site_desc || '';
        document.getElementById('set-footer').value = s.footer_text || '';
        if (s.site_name) document.querySelector('.navbar h1 a').textContent = 'ğŸ“š ' + s.site_name;
      } catch {}
    }
    async function saveSettings() {
      const settings = {
        site_name: document.getElementById('set-site-name').value.trim(),
        site_desc: document.getElementById('set-site-desc').value.trim(),
        footer_text: document.getElementById('set-footer').value.trim(),
      };
      try {
        const res = await api('PUT','/api/admin/settings',{settings});
        const data = await res.json();
        if (!res.ok) throw new Error(data.error);
        showMsg('settings-msg','è®¾ç½®å·²ä¿å­˜','success');
        document.querySelector('.navbar h1 a').textContent = 'ğŸ“š ' + (settings.site_name || 'æˆ‘çš„ä¹¦æ¶');
      } catch(e) { showMsg('settings-msg',e.message,'error'); }
    }

    // ===== TXTå¯¼å…¥ =====
    // ç« èŠ‚æ­£åˆ™v3ï¼šä¿®å¤ä¸Šä¸­ä¸‹ç¯‡è¯¯åŒ¹é…ã€Partç½—é©¬æ•°å­—è¿‡å®½ã€è¿ç»­æ ‡é¢˜ä¸¢å¼ƒã€å‰è¨€ä¸¢å¤±
    const CHAPTER_REGEX = /^[^\S\n\r]*(?:(?:æ­£æ–‡|ä¸Šå·|ä¸‹å·|[ä¸Šä¸­ä¸‹]å†Œ|å·[é›¶ã€‡ä¸€äºŒä¸‰å››äº”å…­ä¸ƒå…«ä¹åç™¾åƒ\d]+)\s+)?(?:[ã€\[ã€Œ]?ç¬¬[é›¶ã€‡ä¸€äºŒä¸‰å››äº”å…­ä¸ƒå…«ä¹åç™¾åƒä¸‡å£¹è´°åè‚†ä¼é™†æŸ’æŒç–æ‹¾ä½°ä»Ÿ\d]+[ç« èŠ‚å›å·é›†éƒ¨ç¯‡å¹•è¯][ã€‘\]ã€]?(?=[\s:ï¼š\-â€”,ï¼Œ.ã€‚!ï¼?ï¼Ÿã€ï¼‰)\]ã€‘ã€}\d~ï½Â·]|$)|(?:chapter|CHAPTER|Chapter)\s+\d+|Part\s+(?:\d+|[IVXLCDM]+|[ivxlcdm]+)|[ä¸Šä¸­ä¸‹]ç¯‡(?=[\s:ï¼š\-â€”]|$)|(?:åº[ç« è¨€å¹•]|æ¥”å­|å°¾å£°|ç•ªå¤–(?:[ç¯‡ï¼š: \dä¸€äºŒä¸‰å››äº”å…­ä¸ƒå…«ä¹å]*)|åè®°|å‰è¨€|å¼•[å­è¨€]|é™„å½•|ç»ˆç« |å¤§ç»“å±€)(?=[\s:ï¼š\-â€”]|$)(?![\u4e00-\u9fff]))[^\S\n\r]*[:ï¼š\-â€”~ï½Â·|ï½œ]*[^\S\n\r]*[^\n\r]{0,100}$/gm;
    let parsedChapters = [];

    function decodeText(buffer) {
      const bytes = new Uint8Array(buffer);
      if (bytes[0]===0xEF&&bytes[1]===0xBB&&bytes[2]===0xBF) return new TextDecoder('utf-8').decode(buffer);
      if (bytes[0]===0xFF&&bytes[1]===0xFE) return new TextDecoder('utf-16le').decode(buffer);
      if (bytes[0]===0xFE&&bytes[1]===0xFF) return new TextDecoder('utf-16be').decode(buffer);
      const utf8 = new TextDecoder('utf-8',{fatal:false}).decode(buffer);
      if (!utf8.includes('\uFFFD')) return utf8;
      try { return new TextDecoder('gbk').decode(buffer); } catch{}
      return utf8;
    }
    function splitChapters(text) {
      if (!text || text.length > 50 * 1024 * 1024) return null;
      const normalized = text.replace(/\r\n?/g, '\n');
      const lines = normalized.split('\n');
      const chapters = [];
      let curTitle = null, curContent = [], preContent = [];

      for (const line of lines) {
        const trimmed = line.replace(/^[\s\u3000]+/,'').replace(/[\s\u3000]+$/,'');
        CHAPTER_REGEX.lastIndex = 0;
        if (trimmed && CHAPTER_REGEX.test(trimmed) && trimmed.length <= 120) {
          if (curTitle !== null) {
            const content = curContent.join('\n').trim();
            chapters.push({title:curTitle, content, checked:true});
          } else if (preContent.length > 0) {
            const pre = preContent.join('\n').trim();
            if (pre) chapters.push({title:'å‰è¨€', content:pre, checked:true});
          }
          curTitle = trimmed.substring(0, 120);
          curContent = [];
        } else if (curTitle !== null) {
          curContent.push(line);
        } else {
          preContent.push(line);
        }
      }
      // æœ€åä¸€ç« ï¼ˆå³ä½¿æ— æ­£æ–‡ä¹Ÿä¿ç•™ï¼‰
      if (curTitle !== null) {
        const content = curContent.join('\n').trim();
        chapters.push({title:curTitle, content, checked:true});
      } else if (preContent.length > 0) {
        const pre = preContent.join('\n').trim();
        if (pre) chapters.push({title:'å‰è¨€', content:pre, checked:true});
      }

      return chapters.length > 0 ? chapters : null;
    }
    function splitBySize(text,size=5000) {
      const chapters=[]; const paras=text.split(/\n\s*\n/);
      let cur='',idx=1;
      for (const p of paras) {
        if (cur.length+p.length>size&&cur.length>0) {
          chapters.push({title:`ç¬¬${idx}ç« `,content:cur.trim(),checked:true});
          idx++; cur=p;
        } else { cur+=(cur?'\n\n':'')+p; }
      }
      if (cur.trim()) chapters.push({title:`ç¬¬${idx}ç« `,content:cur.trim(),checked:true});
      return chapters;
    }
    document.getElementById('import-file').addEventListener('change',async function(){
      const file=this.files[0]; if(!file) return;
      if (file.size>50*1024*1024) return showMsg('import-msg','æ–‡ä»¶è¶…è¿‡50MBé™åˆ¶','error');
      showMsg('import-msg','æ­£åœ¨è§£ææ–‡ä»¶...','');
      try {
        const buffer=await file.arrayBuffer();
        const text=decodeText(buffer);
        parsedChapters=splitChapters(text);
        if (!parsedChapters) {
          if (confirm('æœªæ£€æµ‹åˆ°ç« èŠ‚æ ‡è®°ï¼Œæ˜¯å¦æŒ‰æ¯5000å­—è‡ªåŠ¨åˆ†å‰²ï¼Ÿ')) {
            parsedChapters=splitBySize(text);
          } else {
            parsedChapters=[{title:file.name.replace(/\.txt$/i,''),content:text.trim(),checked:true}];
          }
        }
        renderImportPreview();
        showMsg('import-msg','','');
      } catch(e) { showMsg('import-msg','æ–‡ä»¶è§£æå¤±è´¥ï¼š'+e.message,'error'); }
    });
    function renderImportPreview() {
      const el=document.getElementById('import-chapters');
      const totalWords=parsedChapters.reduce((s,c)=>s+c.content.length,0);
      document.getElementById('import-total').textContent=parsedChapters.length;
      document.getElementById('import-words').textContent=totalWords.toLocaleString();
      el.innerHTML=parsedChapters.map((c,i)=>`
        <div style="padding:8px 0;border-bottom:1px solid var(--border)">
          <div style="display:flex;align-items:center;gap:8px">
            <input type="checkbox" ${c.checked?'checked':''} data-idx="${i}" class="import-check">
            <input type="text" value="${esc(c.title)}" data-idx="${i}" class="import-title-edit" style="flex:1;padding:4px 8px;border:1px solid var(--border);border-radius:4px;font-size:14px;background:var(--bg);color:var(--text)">
            <span style="font-size:12px;color:var(--text-light);white-space:nowrap">${c.content.length} å­—</span>
          </div>
          <div style="font-size:12px;color:var(--text-light);margin-top:4px;padding-left:28px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">${esc(c.content.slice(0,120))}</div>
        </div>
      `).join('');
      // äº‹ä»¶å§”æ‰˜
      el.addEventListener('change', (e) => {
        if (e.target.classList.contains('import-check')) {
          parsedChapters[e.target.dataset.idx].checked = e.target.checked;
        }
      });
      el.addEventListener('input', (e) => {
        if (e.target.classList.contains('import-title-edit')) {
          parsedChapters[e.target.dataset.idx].title = e.target.value;
        }
      });
      document.getElementById('import-preview').style.display='block';
    }
    function cancelImport() {
      parsedChapters=[];
      document.getElementById('import-preview').style.display='none';
      document.getElementById('import-file').value='';
      document.querySelector('.import-progress').style.display='none';
    }
    async function startImport() {
      const bookId=document.getElementById('import-book').value;
      if (!bookId) return showMsg('import-msg','è¯·é€‰æ‹©ç›®æ ‡ä¹¦ç±','error');
      const chapters=parsedChapters.filter(c=>c.checked);
      if (chapters.length===0) return showMsg('import-msg','æ²¡æœ‰é€‰ä¸­ä»»ä½•ç« èŠ‚','error');
      const bar=document.getElementById('import-bar');
      const status=document.getElementById('import-status');
      document.querySelector('.import-progress').style.display='block';
      let uploaded=0,errors=[];
      for (const ch of chapters) {
        try {
          const res=await api('POST','/api/admin/chapters',{book_id:Number(bookId),title:ch.title,content:ch.content});
          if (!res.ok) { const d=await res.json(); errors.push(ch.title+': '+d.error); }
        } catch(e) { errors.push(ch.title+': '+e.message); }
        uploaded++;
        const pct=Math.round(uploaded/chapters.length*100);
        bar.style.width=pct+'%';
        status.textContent=`${uploaded}/${chapters.length} ç« ï¼ˆ${pct}%ï¼‰`;
      }
      if (errors.length>0) {
        showMsg('import-msg',`å¯¼å…¥å®Œæˆï¼Œ${errors.length} ç« å¤±è´¥ï¼š${errors.slice(0,3).join('ï¼›')}`,'error');
      } else { showMsg('import-msg',`æˆåŠŸå¯¼å…¥ ${uploaded} ç« `,'success'); }
      cancelImport(); loadBookList(); loadBookSelects();
    }

    // ===== TXTå¯¼å‡º =====
    function downloadTxt(text,filename) {
      const BOM='\uFEFF';
      const blob=new Blob([BOM+text],{type:'text/plain;charset=utf-8'});
      const url=URL.createObjectURL(blob);
      const a=document.createElement('a');
      a.href=url; a.download=filename; a.click();
      URL.revokeObjectURL(url);
    }
    async function exportBook(bookId) {
      showMsg('manage-msg','æ­£åœ¨å¯¼å‡º...','');
      try {
        const res=await fetch(`/api/books/${bookId}`);
        const data=await res.json();
        const book=data.book; const chapters=data.chapters||[];
        if (chapters.length===0) return showMsg('manage-msg','æ²¡æœ‰ç« èŠ‚å¯å¯¼å‡º','error');
        const parts=[];
        for (const ch of chapters) {
          const r=await fetch(`/api/chapters/${ch.id}`);
          const d=await r.json();
          parts.push(ch.title+'\n\n'+d.content);
        }
        const sep='\n\n'+'='.repeat(40)+'\n\n';
        const header=`ã€Š${book.title}ã€‹\n${book.author?'ä½œè€…ï¼š'+book.author+'\n':''}\n`;
        downloadTxt(header+parts.join(sep),(book.title+(book.author?'_'+book.author:'')+'.txt').replace(/[<>:"/\\|?*]/g,'_'));
        showMsg('manage-msg','å¯¼å‡ºæˆåŠŸ','success');
      } catch(e) { showMsg('manage-msg','å¯¼å‡ºå¤±è´¥ï¼š'+e.message,'error'); }
    }
    async function exportChapter(chapterId,title) {
      try {
        const res=await fetch(`/api/chapters/${chapterId}`);
        const data=await res.json();
        downloadTxt(data.content,(title+'.txt').replace(/[<>:"/\\|?*]/g,'_'));
      } catch(e) { alert('å¯¼å‡ºå¤±è´¥ï¼š'+e.message); }
    }

    // ===== ä¹¦ç± =====
    // ç¼“å­˜ä¹¦ç±æ•°æ®ç”¨äºäº‹ä»¶å§”æ‰˜
    let _booksCache = [];
    let _chaptersCache = [];

    async function loadBookList() {
      const el=document.getElementById('book-list');
      try {
        const res=await fetch('/api/books');
        const data=await res.json();
        if (!data.books||data.books.length===0) {
          el.innerHTML='<li style="padding:12px 0;color:var(--text-light)">æš‚æ— ä¹¦ç±</li>'; _booksCache=[]; return;
        }
        _booksCache = data.books;
        el.innerHTML=data.books.map(b=>`
          <li data-id="${b.id}">
            <div class="item-info">
              <div class="item-title">${esc(b.title)}</div>
              <div class="item-meta">${b.author?esc(b.author)+' Â· ':''}${b.chapter_count} ç«  Â· ${b.total_words} å­—</div>
            </div>
            <div class="item-actions">
              <button class="btn btn-sm btn-edit-book">ç¼–è¾‘</button>
              <button class="btn btn-sm btn-danger btn-delete-book">åˆ é™¤</button>
            </div>
          </li>
        `).join('');
      } catch(e) { el.innerHTML=`<li class="msg msg-error">${esc(e.message)}</li>`; }
    }

    // ä¹¦ç±åˆ—è¡¨äº‹ä»¶å§”æ‰˜
    document.getElementById('book-list').addEventListener('click', function(e) {
      const li = e.target.closest('li[data-id]');
      if (!li) return;
      const id = Number(li.dataset.id);
      const book = _booksCache.find(b => b.id === id);
      if (!book) return;
      if (e.target.classList.contains('btn-edit-book')) {
        const newTitle=prompt('ä¹¦åï¼š',book.title);
        if (newTitle===null) return;
        const newAuthor=prompt('ä½œè€…ï¼š',book.author||'');
        const newDesc=prompt('ç®€ä»‹ï¼š',book.description||'');
        api('PUT',`/api/admin/books/${id}`,{title:newTitle||book.title,author:newAuthor||'',description:newDesc||''})
          .then(r=>r.json()).then(d=>{if(d.error)throw new Error(d.error);loadBookList();loadBookSelects();})
          .catch(e=>alert('ç¼–è¾‘å¤±è´¥ï¼š'+e.message));
      } else if (e.target.classList.contains('btn-delete-book')) {
        if (!confirm(`ç¡®å®šåˆ é™¤ã€Œ${book.title}ã€åŠå…¶æ‰€æœ‰ç« èŠ‚ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ï¼`)) return;
        api('DELETE',`/api/admin/books/${id}`).then(r=>r.json()).then(d=>{
          if (!d.success&&d.error) throw new Error(d.error);
          loadBookList(); loadBookSelects(); loadChapters();
        }).catch(e=>alert('åˆ é™¤å¤±è´¥ï¼š'+e.message));
      }
    });
    async function loadBookSelects() {
      try {
        const res=await fetch('/api/books');
        const data=await res.json();
        const opts=(!data.books||data.books.length===0)
          ?'<option value="">è¯·å…ˆåˆ›å»ºä¸€æœ¬ä¹¦</option>'
          :data.books.map(b=>`<option value="${b.id}">${esc(b.title)}</option>`).join('');
        document.getElementById('chapter-book').innerHTML=opts;
        document.getElementById('import-book').innerHTML=opts;
        document.getElementById('manage-book').innerHTML='<option value="">é€‰æ‹©ä¹¦ç±...</option>'+opts;
      } catch{}
    }
    async function createBook() {
      const title=document.getElementById('book-title').value.trim();
      const author=document.getElementById('book-author').value.trim();
      const description=document.getElementById('book-desc').value.trim();
      if (!title) return showMsg('book-msg','è¯·è¾“å…¥ä¹¦å','error');
      try {
        const res=await api('POST','/api/admin/books',{title,author,description});
        const data=await res.json();
        if (!res.ok) throw new Error(data.error);
        showMsg('book-msg',`åˆ›å»ºæˆåŠŸï¼š${esc(data.book.title)}`,'success');
        document.getElementById('book-title').value='';
        document.getElementById('book-author').value='';
        document.getElementById('book-desc').value='';
        loadBookList(); loadBookSelects();
      } catch(e) { showMsg('book-msg',e.message,'error'); }
    }
    function editBook(id,title,author,desc) {
      const newTitle=prompt('ä¹¦åï¼š',title);
      if (newTitle===null) return;
      const newAuthor=prompt('ä½œè€…ï¼š',author);
      const newDesc=prompt('ç®€ä»‹ï¼š',desc);
      api('PUT',`/api/admin/books/${id}`,{title:newTitle||title,author:newAuthor||'',description:newDesc||''})
        .then(r=>r.json()).then(d=>{if(d.error)throw new Error(d.error);loadBookList();loadBookSelects();})
        .catch(e=>alert('ç¼–è¾‘å¤±è´¥ï¼š'+e.message));
    }
    async function deleteBook(id,title) {
      if (!confirm(`ç¡®å®šåˆ é™¤ã€Œ${title}ã€åŠå…¶æ‰€æœ‰ç« èŠ‚ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ï¼`)) return;
      try {
        const res=await api('DELETE',`/api/admin/books/${id}`);
        const data=await res.json();
        if (!res.ok) throw new Error(data.error);
        loadBookList(); loadBookSelects(); loadChapters();
      } catch(e) { alert('åˆ é™¤å¤±è´¥ï¼š'+e.message); }
    }

    // ===== ç« èŠ‚ =====
    async function createChapter() {
      const book_id=document.getElementById('chapter-book').value;
      const title=document.getElementById('chapter-title').value.trim();
      const content=document.getElementById('chapter-content').value.trim();
      if (!book_id) return showMsg('chapter-msg','è¯·é€‰æ‹©ä¹¦ç±','error');
      if (!title) return showMsg('chapter-msg','è¯·è¾“å…¥ç« èŠ‚æ ‡é¢˜','error');
      if (!content) return showMsg('chapter-msg','è¯·è¾“å…¥ç« èŠ‚å†…å®¹','error');
      try {
        const res=await api('POST','/api/admin/chapters',{book_id:Number(book_id),title,content});
        const data=await res.json();
        if (!res.ok) throw new Error(data.error);
        showMsg('chapter-msg',`å‘å¸ƒæˆåŠŸï¼š${esc(data.chapter.title)}ï¼ˆ${data.chapter.word_count} å­—ï¼‰`,'success');
        document.getElementById('chapter-title').value='';
        document.getElementById('chapter-content').value='';
        document.getElementById('word-count').textContent='0';
        loadBookList(); if(document.getElementById('manage-book').value==book_id) loadChapters();
      } catch(e) { showMsg('chapter-msg',e.message,'error'); }
    }
    async function loadChapters() {
      const bookId=document.getElementById('manage-book').value;
      const el=document.getElementById('chapter-list');
      const exportArea=document.getElementById('export-area');
      if (!bookId) { el.innerHTML=''; exportArea.innerHTML=''; _chaptersCache=[]; document.getElementById('batch-bar').style.display='none'; return; }
      try {
        const res=await fetch(`/api/books/${bookId}`);
        const data=await res.json();
        const chapters=data.chapters||[];
        _chaptersCache = chapters;
        if (chapters.length===0) {
          el.innerHTML='<li style="padding:12px 0;color:var(--text-light)">æš‚æ— ç« èŠ‚</li>';
          exportArea.innerHTML=''; return;
        }
        el.innerHTML=chapters.map((c,i)=>`
          <li data-id="${c.id}" data-idx="${i}">
            <div style="display:flex;align-items:center;gap:8px;flex:1">
              <input type="checkbox" class="ch-select" data-id="${c.id}" onchange="updateSelectedCount()">
              <div class="item-info">
                <div class="item-title">${esc(c.title)}</div>
                <div class="item-meta">ç¬¬${c.sort_order}ç«  Â· ${c.word_count} å­—</div>
              </div>
            </div>
            <div class="item-actions">
              ${i>0?`<button class="btn btn-sm btn-move-up">â†‘</button>`:''}
              ${i<chapters.length-1?`<button class="btn btn-sm btn-move-down">â†“</button>`:''}
              <button class="btn btn-sm btn-export-ch">å¯¼å‡º</button>
              <button class="btn btn-sm btn-edit-ch">ç¼–è¾‘</button>
              <button class="btn btn-sm btn-danger btn-delete-ch">åˆ é™¤</button>
            </div>
          </li>
        `).join('');
        document.getElementById('batch-bar').style.display='flex';
        document.getElementById('select-all').checked=false;
        updateSelectedCount();
        exportArea.innerHTML=`<a href="#" id="export-book-link" style="font-size:13px;color:var(--text-light);text-decoration:none;border-bottom:1px dashed var(--text-light)">å¯¼å‡ºå…¨ä¹¦ TXT</a>`;
        document.getElementById('export-book-link').addEventListener('click',function(e){e.preventDefault();exportBook(bookId);});
      } catch(e) { el.innerHTML=`<li class="msg msg-error">${esc(e.message)}</li>`; }
    }

    // ç« èŠ‚åˆ—è¡¨äº‹ä»¶å§”æ‰˜
    document.getElementById('chapter-list').addEventListener('click', async function(e) {
      const li = e.target.closest('li[data-id]');
      if (!li) return;
      const id = Number(li.dataset.id);
      const idx = Number(li.dataset.idx);
      const ch = _chaptersCache[idx];
      if (!ch) return;

      if (e.target.classList.contains('btn-move-up') && idx > 0) {
        const prev = _chaptersCache[idx-1];
        try {
          const res=await api('POST','/api/admin/chapters/swap',{id1:id,id2:prev.id});
          const d=await res.json(); if(!res.ok) throw new Error(d.error);
          loadChapters();
        } catch(e) { showMsg('manage-msg','æ’åºå¤±è´¥ï¼š'+e.message,'error'); }
      } else if (e.target.classList.contains('btn-move-down') && idx < _chaptersCache.length-1) {
        const next = _chaptersCache[idx+1];
        try {
          const res=await api('POST','/api/admin/chapters/swap',{id1:next.id,id2:id});
          const d=await res.json(); if(!res.ok) throw new Error(d.error);
          loadChapters();
        } catch(e) { showMsg('manage-msg','æ’åºå¤±è´¥ï¼š'+e.message,'error'); }
      } else if (e.target.classList.contains('btn-export-ch')) {
        try {
          const res=await fetch(`/api/chapters/${id}`);
          const data=await res.json();
          downloadTxt(data.content,(ch.title+'.txt').replace(/[<>:"/\\|?*]/g,'_'));
        } catch(e) { alert('å¯¼å‡ºå¤±è´¥ï¼š'+e.message); }
      } else if (e.target.classList.contains('btn-edit-ch')) {
        const newTitle=prompt('ç« èŠ‚æ ‡é¢˜ï¼š');
        if (newTitle===null) return;
        const editContent=confirm('æ˜¯å¦ä¿®æ”¹æ­£æ–‡å†…å®¹ï¼Ÿ');
        let body={};
        if (newTitle) body.title=newTitle;
        if (editContent) { const c=prompt('è¾“å…¥æ–°çš„æ­£æ–‡å†…å®¹ï¼ˆä¼šå®Œå…¨æ›¿æ¢åŸå†…å®¹ï¼‰ï¼š'); if(c) body.content=c; }
        if (!body.title&&!body.content) return;
        try {
          const res=await api('PUT',`/api/admin/chapters/${id}`,body);
          const d=await res.json(); if(!res.ok) throw new Error(d.error);
          showMsg('manage-msg','ç¼–è¾‘æˆåŠŸ','success');
          loadChapters(); loadBookList();
        } catch(e) { showMsg('manage-msg','ç¼–è¾‘å¤±è´¥ï¼š'+e.message,'error'); }
      } else if (e.target.classList.contains('btn-delete-ch')) {
        if (!confirm(`ç¡®å®šåˆ é™¤ç« èŠ‚ã€Œ${ch.title}ã€ï¼Ÿ`)) return;
        try {
          const res=await api('DELETE',`/api/admin/chapters/${id}`);
          const d=await res.json(); if(!res.ok) throw new Error(d.error);
          loadChapters(); loadBookList();
        } catch(e) { showMsg('manage-msg','åˆ é™¤å¤±è´¥ï¼š'+e.message,'error'); }
      }
    });

    // ===== å·¥å…· =====
    function api(method,url,body) {
      const opts={method,headers:{'Authorization':`Bearer ${getToken()}`,'Content-Type':'application/json'}};
      if (body) opts.body=JSON.stringify(body);
      return fetch(url,opts);
    }
    function showMsg(id,text,type) {
      const el=document.getElementById(id);
      el.className=type?`msg msg-${type}`:'';
      el.textContent=text;
      if (type==='success') setTimeout(()=>{el.className='';el.textContent='';},5000);
    }
    function esc(s) { const d=document.createElement('div'); d.textContent=s||''; return d.innerHTML; }

    document.getElementById('chapter-content').addEventListener('input',function(){
      document.getElementById('word-count').textContent=this.value.trim().length;
    });

    // ===== æ•°æ®æ¦‚è§ˆ =====
    async function loadStats() {
      try {
        const res = await fetch('/api/books');
        const data = await res.json();
        const books = data.books || [];
        const totalChapters = books.reduce((s, b) => s + (b.chapter_count || 0), 0);
        const totalWords = books.reduce((s, b) => s + (b.total_words || 0), 0);
        document.getElementById('stat-books').textContent = books.length;
        document.getElementById('stat-chapters').textContent = totalChapters;
        document.getElementById('stat-words').textContent = totalWords >= 10000
          ? (totalWords / 10000).toFixed(1) + ' ä¸‡'
          : totalWords.toLocaleString();
      } catch {}
    }

    // ===== æ‰¹é‡æ“ä½œ =====
    function toggleSelectAll(checked) {
      document.querySelectorAll('.ch-select').forEach(cb => cb.checked = checked);
      updateSelectedCount();
    }
    function updateSelectedCount() {
      const count = document.querySelectorAll('.ch-select:checked').length;
      const el = document.getElementById('selected-count');
      if (el) el.textContent = `å·²é€‰ ${count} ç« `;
    }
    async function batchDelete() {
      const ids = [...document.querySelectorAll('.ch-select:checked')].map(cb => Number(cb.dataset.id));
      if (ids.length === 0) return showMsg('manage-msg', 'è¯·å…ˆå‹¾é€‰è¦åˆ é™¤çš„ç« èŠ‚', 'error');
      if (!confirm(`ç¡®å®šåˆ é™¤é€‰ä¸­çš„ ${ids.length} ä¸ªç« èŠ‚ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ï¼`)) return;
      let deleted = 0, errors = [];
      for (const id of ids) {
        try {
          const res = await api('DELETE', `/api/admin/chapters/${id}`);
          if (!res.ok) { const d = await res.json(); errors.push(d.error); }
          else deleted++;
        } catch (e) { errors.push(e.message); }
      }
      if (errors.length > 0) {
        showMsg('manage-msg', `åˆ é™¤ ${deleted} ç« ï¼Œ${errors.length} ç« å¤±è´¥`, 'error');
      } else {
        showMsg('manage-msg', `æˆåŠŸåˆ é™¤ ${deleted} ç« `, 'success');
      }
      loadChapters(); loadBookList();
    }

    // ===== æ•°æ®å¤‡ä»½ä¸æ¢å¤ =====
    async function exportBackup() {
      const btn=document.getElementById('backup-btn');
      const bar=document.getElementById('backup-bar');
      const status=document.getElementById('backup-status');
      const progress=document.getElementById('backup-progress');
      btn.disabled=true; btn.textContent='å¯¼å‡ºä¸­...';
      progress.style.display='block';
      try {
        // è·å–æ‰€æœ‰ä¹¦ç±
        const booksRes=await api('GET','/api/books');
        const booksData=await booksRes.json();
        const books=booksData.books||[];
        // è·å–è®¾ç½®
        const settingsRes=await fetch('/api/settings');
        const settingsData=await settingsRes.json();
        const backup={version:1,exportedAt:new Date().toISOString(),settings:settingsData.settings||{},books:[]};
        let done=0;
        for (const book of books) {
          const bookRes=await fetch(`/api/books/${book.id}`);
          const bookData=await bookRes.json();
          const chapters=bookData.chapters||[];
          const fullChapters=[];
          for (const ch of chapters) {
            const chRes=await fetch(`/api/chapters/${ch.id}`);
            const chData=await chRes.json();
            fullChapters.push({title:ch.title,sort_order:ch.sort_order,word_count:ch.word_count,content:chData.content||''});
          }
          backup.books.push({title:book.title,author:book.author||'',description:book.description||'',chapters:fullChapters});
          done++;
          const pct=Math.round(done/books.length*100);
          bar.style.width=pct+'%';
          status.textContent=`${done}/${books.length} æœ¬ä¹¦`;
        }
        const blob=new Blob([JSON.stringify(backup,null,2)],{type:'application/json'});
        const url=URL.createObjectURL(blob);
        const a=document.createElement('a');
        a.href=url;
        a.download=`novel-site-backup-${new Date().toISOString().slice(0,10)}.json`;
        a.click();
        URL.revokeObjectURL(url);
        showMsg('backup-msg',`å¤‡ä»½æˆåŠŸï¼š${books.length} æœ¬ä¹¦`,'success');
      } catch(e) { showMsg('backup-msg','å¤‡ä»½å¤±è´¥ï¼š'+e.message,'error'); }
      btn.disabled=false; btn.textContent='å¯¼å‡ºå¤‡ä»½';
      setTimeout(()=>{progress.style.display='none';},2000);
    }

    document.getElementById('restore-file').addEventListener('change',async(e)=>{
      const file=e.target.files[0];
      if (!file) return;
      if (!confirm('æ¢å¤å¤‡ä»½ä¼šæ·»åŠ æ•°æ®ï¼ˆä¸ä¼šåˆ é™¤ç°æœ‰æ•°æ®ï¼‰ã€‚ç¡®å®šç»§ç»­ï¼Ÿ')) { e.target.value=''; return; }
      const bar=document.getElementById('backup-bar');
      const status=document.getElementById('backup-status');
      const progress=document.getElementById('backup-progress');
      progress.style.display='block';
      try {
        const text=await file.text();
        const backup=JSON.parse(text);
        if (!backup.version || !backup.books) throw new Error('æ— æ•ˆçš„å¤‡ä»½æ–‡ä»¶');
        const books=backup.books;
        let done=0,errors=[];
        for (const book of books) {
          try {
            // åˆ›å»ºä¹¦ç±
            const res=await api('POST','/api/admin/books',{title:book.title,author:book.author,description:book.description});
            const d=await res.json();
            if (!res.ok) throw new Error(d.error);
            const bookId=d.book.id;
            // å¯¼å…¥ç« èŠ‚
            for (const ch of (book.chapters||[])) {
              await api('POST','/api/admin/chapters',{book_id:bookId,title:ch.title,content:ch.content});
            }
          } catch(err) { errors.push(book.title+': '+err.message); }
          done++;
          const pct=Math.round(done/books.length*100);
          bar.style.width=pct+'%';
          status.textContent=`${done}/${books.length} æœ¬ä¹¦`;
        }
        if (errors.length>0) {
          showMsg('backup-msg',`æ¢å¤å®Œæˆï¼Œ${errors.length} æœ¬å¤±è´¥ï¼š${errors.slice(0,3).join('ï¼›')}`,'error');
        } else { showMsg('backup-msg',`æˆåŠŸæ¢å¤ ${books.length} æœ¬ä¹¦`,'success'); }
        loadBookList(); loadBookSelects();
      } catch(err) { showMsg('backup-msg','æ¢å¤å¤±è´¥ï¼š'+err.message,'error'); }
      e.target.value='';
      setTimeout(()=>{progress.style.display='none';},2000);
    });
  </script>
</body>
</html>
