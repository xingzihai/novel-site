<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ç®¡ç†åå°</title>
  <link rel="stylesheet" href="/style.css">
  <script src="/jszip.min.js"></script>
</head>
<body>
  <div class="navbar">
    <h1><a href="/">ğŸ“š æˆ‘çš„ä¹¦æ¶</a></h1>
    <nav>
      <a href="/">è¿”å›ä¹¦æ¶</a>
      <span id="user-info" style="display:none;font-size:13px;color:var(--text-light)"></span>
      <button class="theme-toggle" onclick="toggleTheme()" title="åˆ‡æ¢ä¸»é¢˜">ğŸŒ™</button>
    </nav>
  </div>
  <div class="container">

    <!-- ç™»å½•ç•Œé¢ -->
    <div id="login-panel">
      <div class="admin-section" style="max-width:400px;margin:60px auto">
        <h3>ğŸ” ç®¡ç†å‘˜ç™»å½•</h3>
        <div class="form-group">
          <label>ç”¨æˆ·å</label>
          <input type="text" id="login-user" placeholder="admin" value="admin">
        </div>
        <div class="form-group">
          <label>å¯†ç </label>
          <input type="password" id="login-pass" placeholder="è¾“å…¥ç®¡ç†å¯†ç " onkeydown="if(event.key==='Enter')doLogin()">
        </div>
        <button class="btn" onclick="doLogin()" style="width:100%">ç™»å½•</button>
        <div id="login-msg" style="margin-top:8px"></div>
        <div style="margin-top:16px;text-align:center">
          <div id="github-login-section" style="display:none">
            <div style="color:var(--text-light);font-size:13px;margin-bottom:8px">â€” æˆ– â€”</div>
            <button class="btn" onclick="doGitHubLogin()" style="width:100%;background:#24292e;color:#fff;border:none;padding:10px;border-radius:var(--radius);cursor:pointer;font-size:14px">
              <svg style="vertical-align:middle;margin-right:6px" width="18" height="18" viewBox="0 0 16 16" fill="white"><path d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.013 8.013 0 0016 8c0-4.42-3.58-8-8-8z"/></svg>
              GitHub ç™»å½•ï¼ˆDemo ä½“éªŒï¼‰
            </button>
            <div style="font-size:12px;color:var(--text-light);margin-top:4px">é¦–æ¬¡ç™»å½•è‡ªåŠ¨æ³¨å†Œä¸ºæ¼”ç¤ºç®¡ç†å‘˜</div>
          </div>
        </div>
      </div>
    </div>

    <!-- ç®¡ç†é¢æ¿ï¼ˆç™»å½•åæ˜¾ç¤ºï¼‰ -->
    <div id="admin-panel" style="display:none">

      <!-- æ•°æ®æ¦‚è§ˆ -->
      <div class="admin-section" id="stats-panel">
        <h3>ğŸ“Š æ•°æ®æ¦‚è§ˆ</h3>
        <div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(140px,1fr));gap:12px" id="stats-grid">
          <div style="text-align:center;padding:16px;background:var(--bg);border-radius:var(--radius)">
            <div style="font-size:28px;font-weight:700;color:var(--accent)" id="stat-books">-</div>
            <div style="font-size:13px;color:var(--text-light)">ä¹¦ç±</div>
          </div>
          <div style="text-align:center;padding:16px;background:var(--bg);border-radius:var(--radius)">
            <div style="font-size:28px;font-weight:700;color:var(--accent)" id="stat-chapters">-</div>
            <div style="font-size:13px;color:var(--text-light)">ç« èŠ‚</div>
          </div>
          <div style="text-align:center;padding:16px;background:var(--bg);border-radius:var(--radius)">
            <div style="font-size:28px;font-weight:700;color:var(--accent)" id="stat-words">-</div>
            <div style="font-size:13px;color:var(--text-light)">æ€»å­—æ•°</div>
          </div>
          <div style="text-align:center;padding:16px;background:var(--bg);border-radius:var(--radius)">
            <div style="font-size:28px;font-weight:700;color:var(--accent)" id="stat-pv">-</div>
            <div style="font-size:13px;color:var(--text-light)">ä»Šæ—¥è®¿é—®</div>
          </div>
          <div style="text-align:center;padding:16px;background:var(--bg);border-radius:var(--radius)">
            <div style="font-size:28px;font-weight:700;color:var(--accent)" id="stat-uv">-</div>
            <div style="font-size:13px;color:var(--text-light)">ä»Šæ—¥è®¿å®¢</div>
          </div>
          <div style="text-align:center;padding:16px;background:var(--bg);border-radius:var(--radius)">
            <div style="font-size:28px;font-weight:700;color:var(--accent)" id="stat-total-pv">-</div>
            <div style="font-size:13px;color:var(--text-light)">ç´¯è®¡è®¿é—®</div>
          </div>
        </div>
        <!-- çƒ­é—¨ä¹¦ç± -->
        <div id="hot-books" style="margin-top:16px"></div>
      </div>

      <!-- è´¦å·ç®¡ç† -->
      <div class="admin-section">
        <h3>ğŸ‘¤ è´¦å·ç®¡ç†</h3>
        <div style="display:flex;align-items:center;gap:12px;margin-bottom:12px">
          <span>å½“å‰ç”¨æˆ·ï¼š<strong id="current-user"></strong></span>
          <a href="#" onclick="showChangePassword();return false" style="font-size:13px">ä¿®æ”¹å¯†ç </a>
          <a href="#" onclick="doLogout();return false" style="font-size:13px;color:var(--danger,#e74c3c)">é€€å‡ºç™»å½•</a>
          <a href="#" id="deactivate-account-btn" onclick="deactivateAccount();return false" style="display:none;font-size:13px;color:var(--danger,#e74c3c)">æ³¨é”€è´¦å·</a>
        </div>
        <div id="pwd-form" style="display:none">
          <div class="form-group">
            <label>æ—§å¯†ç </label>
            <input type="password" id="old-pwd" placeholder="è¾“å…¥å½“å‰å¯†ç ">
          </div>
          <div class="form-group">
            <label>æ–°å¯†ç ï¼ˆè‡³å°‘8ä½ï¼Œéœ€åŒ…å«å­—æ¯å’Œæ•°å­—ï¼‰</label>
            <input type="password" id="new-pwd" placeholder="è¾“å…¥æ–°å¯†ç ">
          </div>
          <div class="form-group">
            <label>ç¡®è®¤æ–°å¯†ç </label>
            <input type="password" id="new-pwd2" placeholder="å†æ¬¡è¾“å…¥æ–°å¯†ç ">
          </div>
          <button class="btn" onclick="doChangePassword()">ç¡®è®¤ä¿®æ”¹</button>
          <button class="btn btn-sm" onclick="document.getElementById('pwd-form').style.display='none'" style="margin-left:8px">å–æ¶ˆ</button>
          <div id="pwd-msg" style="margin-top:8px"></div>
        </div>
      </div>

      <!-- ç«™ç‚¹è®¾ç½® -->
      <div class="admin-section super-admin-only" style="display:none">
        <h3>âš™ï¸ ç«™ç‚¹è®¾ç½®</h3>
        <div class="form-group">
          <label>ç«™ç‚¹åç§°</label>
          <input type="text" id="set-site-name" placeholder="å¦‚ï¼šxingzihaiçš„ä¹¦æ¶" maxlength="100">
        </div>
        <div class="form-group">
          <label>ç«™ç‚¹æè¿°</label>
          <input type="text" id="set-site-desc" placeholder="ä¸€å¥è¯ä»‹ç»ä½ çš„å°è¯´ç«™" maxlength="200">
        </div>
        <div class="form-group">
          <label>é¡µè„šæ–‡å­—</label>
          <input type="text" id="set-footer" placeholder="å¦‚ï¼šPowered by Cloudflare" maxlength="200">
        </div>
        <button class="btn" onclick="saveSettings()">ä¿å­˜è®¾ç½®</button>
        <div id="settings-msg"></div>

        <!-- GitHub OAuth é…ç½® -->
        <div style="margin-top:24px;padding-top:16px;border-top:1px solid var(--border)">
          <h4 style="margin:0 0 12px">ğŸ™ Demo æ³¨å†Œï¼ˆGitHub ç™»å½•ï¼‰</h4>
          <div class="form-group">
            <label>
              <input type="checkbox" id="gh-oauth-enabled" onchange="toggleGitHubConfig()"> å¯ç”¨ GitHub ç™»å½•æ³¨å†Œ
            </label>
            <div style="font-size:12px;color:var(--text-light);margin-top:2px">å¼€å¯åï¼Œç™»å½•é¡µä¼šæ˜¾ç¤º"GitHub ç™»å½•"æŒ‰é’®ï¼Œæ–°ç”¨æˆ·è‡ªåŠ¨æ³¨å†Œä¸ºæ¼”ç¤ºç®¡ç†å‘˜</div>
          </div>
          <div id="gh-oauth-config" style="display:none">
            <div style="background:var(--bg);padding:10px;border-radius:var(--radius);margin-bottom:12px;font-size:13px;color:var(--text-light)">
              <strong>é…ç½®æ­¥éª¤ï¼š</strong><br>
              1. æ‰“å¼€ <a href="https://github.com/settings/developers" target="_blank" style="color:var(--primary)">GitHub Developer Settings</a><br>
              2. ç‚¹å‡» OAuth Apps â†’ New OAuth App<br>
              3. Homepage URL å¡«ï¼š<code id="gh-homepage-url"></code><br>
              4. Callback URL å¡«ï¼š<code id="gh-callback-url"></code><br>
              5. åˆ›å»ºåæŠŠ Client ID å’Œ Client Secret å¡«åˆ°ä¸‹é¢
            </div>
            <div class="form-group">
              <label>Client ID</label>
              <input type="text" id="gh-client-id" placeholder="Ov23li..." maxlength="100">
            </div>
            <div class="form-group">
              <label>Client Secret <span id="gh-secret-status" style="font-size:12px"></span></label>
              <input type="password" id="gh-client-secret" placeholder="ç•™ç©ºåˆ™ä¿æŒåŸå€¼ä¸å˜" maxlength="200">
            </div>
            <button class="btn" onclick="saveGitHubConfig()">ä¿å­˜ GitHub é…ç½®</button>
            <div id="gh-config-msg" style="margin-top:8px"></div>
          </div>
        </div>
      </div>

      <!-- TXTå¯¼å…¥ -->
      <div class="admin-section">
        <h3>ğŸ“¥ TXT å¯¼å…¥</h3>
        <div class="form-group">
          <label>é€‰æ‹©ç›®æ ‡ä¹¦ç± *ï¼ˆæˆ–å…ˆåˆ›å»ºæ–°ä¹¦ï¼‰</label>
          <select id="import-book"><option value="">åŠ è½½ä¸­...</option></select>
        </div>
        <div class="form-group">
          <label>é€‰æ‹© TXT æ–‡ä»¶ï¼ˆæ”¯æŒ UTF-8 / GBK ç¼–ç ï¼Œæœ€å¤§ 50MBï¼‰</label>
          <input type="file" id="import-file" accept=".txt,.text" style="padding:8px 0">
        </div>
        <div id="import-preview" style="display:none">
          <div class="form-group">
            <label>ç« èŠ‚åˆ†å‰²é¢„è§ˆï¼ˆå¯å–æ¶ˆå‹¾é€‰ä¸éœ€è¦çš„ç« èŠ‚ï¼‰</label>
            <div id="import-chapters" class="admin-list" style="max-height:300px;overflow-y:auto"></div>
            <div style="font-size:13px;color:var(--text-light);margin-top:6px">
              å…± <span id="import-total">0</span> ç« ï¼Œ<span id="import-words">0</span> å­—
            </div>
          </div>
          <div class="import-progress" style="display:none">
            <div style="background:var(--bg-secondary);border-radius:10px;overflow:hidden;height:20px;margin:12px 0">
              <div id="import-bar" style="height:100%;background:var(--primary);border-radius:10px;transition:width 0.3s;width:0%"></div>
            </div>
            <div id="import-status" style="font-size:13px;color:var(--text-light)"></div>
          </div>
          <button class="btn" onclick="startImport()">å¼€å§‹å¯¼å…¥</button>
          <button class="btn btn-sm" onclick="cancelImport()" style="margin-left:8px">å–æ¶ˆ</button>
        </div>
        <div id="import-msg"></div>
      </div>

      <!-- EPUBå¯¼å…¥ -->
      <div class="admin-section">
        <h3>ğŸ“– EPUB å¯¼å…¥</h3>
        <div class="form-group">
          <label>é€‰æ‹© EPUB æ–‡ä»¶ï¼ˆæœ€å¤§ 50MBï¼‰</label>
          <input type="file" id="epub-file" accept=".epub" style="padding:8px 0">
        </div>
        <div id="epub-parsing-msg" style="display:none;padding:12px;background:var(--bg);border-radius:var(--radius);color:var(--text-light);font-size:14px">
          â³ æ­£åœ¨è§£æ EPUB æ–‡ä»¶...
        </div>
        <div id="epub-preview" style="display:none">
          <div style="padding:12px;background:var(--bg);border-radius:var(--radius);margin-bottom:12px">
            <div class="form-group" style="margin-bottom:8px">
              <label>ä¹¦å</label>
              <input type="text" id="epub-book-title" placeholder="ä¹¦å" maxlength="200">
            </div>
            <div class="form-group" style="margin-bottom:8px">
              <label>ä½œè€…</label>
              <input type="text" id="epub-book-author" placeholder="ä½œè€…" maxlength="100">
            </div>
            <div class="form-group" style="margin-bottom:0">
              <label>ç®€ä»‹</label>
              <textarea id="epub-book-desc" placeholder="ç®€ä»‹" style="min-height:60px" maxlength="2000"></textarea>
            </div>
          </div>
          <div class="form-group">
            <label>ç« èŠ‚åˆ—è¡¨ï¼ˆå¯å–æ¶ˆå‹¾é€‰ä¸éœ€è¦çš„ç« èŠ‚ï¼Œå¯ç¼–è¾‘æ ‡é¢˜ï¼‰</label>
            <div id="epub-chapters" class="admin-list" style="max-height:400px;overflow-y:auto"></div>
            <div style="font-size:13px;color:var(--text-light);margin-top:6px">
              å…± <span id="epub-total">0</span> ç« ï¼Œ<span id="epub-words">0</span> å­—
            </div>
          </div>
          <div class="form-group">
            <label>å¯¼å…¥æ–¹å¼</label>
            <div style="display:flex;gap:12px;align-items:center;flex-wrap:wrap">
              <label style="display:flex;align-items:center;gap:4px;font-size:14px;cursor:pointer">
                <input type="radio" name="epub-import-mode" value="new" checked> åˆ›å»ºæ–°ä¹¦å¹¶å¯¼å…¥
              </label>
              <label style="display:flex;align-items:center;gap:4px;font-size:14px;cursor:pointer">
                <input type="radio" name="epub-import-mode" value="existing"> å¯¼å…¥åˆ°å·²æœ‰ä¹¦ç±
              </label>
            </div>
          </div>
          <div id="epub-existing-book" style="display:none" class="form-group">
            <label>é€‰æ‹©ç›®æ ‡ä¹¦ç±</label>
            <select id="epub-book-select"><option value="">åŠ è½½ä¸­...</option></select>
          </div>
          <div class="import-progress" id="epub-progress" style="display:none">
            <div style="background:var(--bg-secondary,var(--border));border-radius:10px;overflow:hidden;height:20px;margin:12px 0">
              <div id="epub-bar" style="height:100%;background:var(--primary,var(--accent));border-radius:10px;transition:width 0.3s;width:0%"></div>
            </div>
            <div id="epub-status" style="font-size:13px;color:var(--text-light)"></div>
          </div>
          <div style="display:flex;gap:8px">
            <button class="btn" onclick="startEpubImport()">å¼€å§‹å¯¼å…¥</button>
            <button class="btn btn-sm" onclick="cancelEpubImport()">å–æ¶ˆ</button>
          </div>
        </div>
        <div id="epub-msg"></div>
      </div>

      <!-- åˆ›å»ºä¹¦ç± -->
      <div class="admin-section">
        <h3>ğŸ“– åˆ›å»ºæ–°ä¹¦</h3>
        <div class="form-group">
          <label>ä¹¦å *</label>
          <input type="text" id="book-title" placeholder="è¾“å…¥ä¹¦å" maxlength="200">
        </div>
        <div class="form-group">
          <label>ä½œè€…</label>
          <input type="text" id="book-author" placeholder="è¾“å…¥ä½œè€…å" maxlength="100">
        </div>
        <div class="form-group">
          <label>ç®€ä»‹</label>
          <textarea id="book-desc" placeholder="è¾“å…¥ä¹¦ç±ç®€ä»‹" style="min-height:80px" maxlength="2000"></textarea>
        </div>
        <div class="form-group">
          <label>æ ‡ç­¾</label>
          <div id="create-book-tags" style="display:flex;gap:6px;flex-wrap:wrap"></div>
        </div>
        <button class="btn" onclick="createBook()">åˆ›å»ºä¹¦ç±</button>
        <div id="book-msg"></div>
      </div>

      <!-- ä¹¦ç±ç®¡ç† -->
      <div class="admin-section">
        <h3>ğŸ“š ä¹¦ç±ç®¡ç†</h3>
        <ul class="admin-list" id="book-list"><li class="loading">åŠ è½½ä¸­...</li></ul>
      </div>

      <!-- ä¹¦ç±ç¼–è¾‘å¼¹çª— -->
      <div class="settings-overlay" id="book-edit-overlay">
        <div class="settings-panel" style="max-width:500px;border-radius:var(--radius)">
          <h3>ç¼–è¾‘ä¹¦ç±<button class="close-btn" id="close-book-edit">âœ•</button></h3>
          <input type="hidden" id="edit-book-id">
          <div class="form-group">
            <label>ä¹¦å</label>
            <input type="text" id="edit-book-title" maxlength="200">
          </div>
          <div class="form-group">
            <label>ä½œè€…</label>
            <input type="text" id="edit-book-author" maxlength="100">
          </div>
          <div class="form-group">
            <label>ç®€ä»‹</label>
            <textarea id="edit-book-desc" style="min-height:60px" maxlength="2000"></textarea>
          </div>
          <div class="form-group">
            <label>å°é¢å›¾ç‰‡</label>
            <div style="display:flex;gap:12px;align-items:center">
              <div id="edit-cover-preview" style="width:80px;height:107px;border:1px dashed var(--border);border-radius:var(--radius);display:flex;align-items:center;justify-content:center;overflow:hidden;background:var(--bg)">
                <span style="color:var(--text-light);font-size:12px">æ— å°é¢</span>
              </div>
              <div>
                <input type="file" id="edit-cover-file" accept="image/*" style="font-size:13px;margin-bottom:6px">
                <div><button class="btn btn-sm btn-danger" id="remove-cover-btn" style="display:none">åˆ é™¤å°é¢</button></div>
              </div>
            </div>
          </div>
          <div class="form-group">
            <label>æ ‡ç­¾</label>
            <div id="edit-book-tags" style="display:flex;gap:6px;flex-wrap:wrap"></div>
            <div id="edit-tag-actions" style="margin-top:8px;display:flex;gap:6px;align-items:center;flex-wrap:wrap">
              <input type="text" id="inline-tag-name" placeholder="æ–°æ ‡ç­¾å" maxlength="30" style="width:100px;padding:4px 8px;border:1px solid var(--border);border-radius:var(--radius);background:var(--bg);color:var(--text);font-size:13px">
              <input type="color" id="inline-tag-color" value="#3498db" style="width:30px;height:26px;border:1px solid var(--border);border-radius:var(--radius);cursor:pointer;padding:1px">
              <button class="btn btn-sm" id="inline-create-tag-btn">+ æ–°æ ‡ç­¾</button>
            </div>
          </div>
          <button class="btn" id="save-book-edit-btn">ä¿å­˜</button>
        </div>
      </div>

      <!-- æ·»åŠ ç« èŠ‚ -->
      <div class="admin-section">
        <h3>ğŸ“ æ·»åŠ ç« èŠ‚</h3>
        <div class="form-group">
          <label>é€‰æ‹©ä¹¦ç± *</label>
          <select id="chapter-book"><option value="">åŠ è½½ä¸­...</option></select>
        </div>
        <div class="form-group">
          <label>ç« èŠ‚æ ‡é¢˜ *</label>
          <input type="text" id="chapter-title" placeholder="å¦‚ï¼šç¬¬ä¸€ç«  åˆå…¥æ±Ÿæ¹–" maxlength="200">
        </div>
        <div class="form-group">
          <label>ç« èŠ‚å†…å®¹ *</label>
          <textarea id="chapter-content" placeholder="åœ¨æ­¤è¾“å…¥ç« èŠ‚æ­£æ–‡..."></textarea>
          <div style="font-size:12px;color:var(--text-light);margin-top:4px">å­—æ•°ï¼š<span id="word-count">0</span></div>
        </div>
        <button class="btn" onclick="createChapter()">å‘å¸ƒç« èŠ‚</button>
        <div id="chapter-msg"></div>
      </div>

      <!-- ç« èŠ‚ç®¡ç† -->
      <div class="admin-section">
        <h3>ğŸ“„ ç« èŠ‚ç®¡ç†</h3>
        <div class="form-group">
          <label>é€‰æ‹©ä¹¦ç±</label>
          <select id="manage-book"><option value="">é€‰æ‹©ä¹¦ç±...</option></select>
        </div>
        <div id="batch-bar" style="display:none;margin-bottom:12px;padding:10px;background:var(--bg);border:1px solid var(--border);border-radius:var(--radius);display:flex;align-items:center;gap:12px">
          <label style="font-size:13px;display:flex;align-items:center;gap:4px"><input type="checkbox" id="select-all">å…¨é€‰</label>
          <span style="font-size:13px;color:var(--text-light)" id="selected-count">å·²é€‰ 0 ç« </span>
          <button class="btn btn-danger btn-sm" onclick="batchDelete()">æ‰¹é‡åˆ é™¤</button>
        </div>
        <ul class="admin-list" id="chapter-list"></ul>
        <div style="margin-top:8px" id="export-area"></div>
        <div id="manage-msg"></div>
      </div>

      <!-- è‡ªå®šä¹‰å­—ä½“ç®¡ç† -->
      <div class="admin-section super-admin-only" style="display:none">
        <h3>ğŸ”¤ è‡ªå®šä¹‰å­—ä½“</h3>
        <div class="form-group">
          <label>ä¸Šä¼  .woff2 å­—ä½“æ–‡ä»¶ï¼ˆæœ€å¤§10MBï¼‰</label>
          <div style="display:flex;gap:8px;align-items:center">
            <input type="file" id="font-file" accept=".woff2" style="padding:8px 0;flex:1">
            <button class="btn" onclick="uploadFont()">ä¸Šä¼ </button>
          </div>
        </div>
        <ul class="admin-list" id="font-list"><li style="color:var(--text-light)">åŠ è½½ä¸­...</li></ul>
        <div id="font-msg"></div>
      </div>

      <!-- æ•°æ®å¤‡ä»½ä¸æ¢å¤ -->
      <div class="admin-section super-admin-only" style="display:none">
        <h3>ğŸ’¾ æ•°æ®å¤‡ä»½ä¸æ¢å¤</h3>
        <p style="font-size:13px;color:var(--text-light);margin-bottom:12px">å¯¼å‡ºå…¨ç«™æ•°æ®ï¼ˆä¹¦ç±+ç« èŠ‚æ­£æ–‡+è®¾ç½®ï¼‰ä¸º JSON æ–‡ä»¶ï¼Œæˆ–ä»å¤‡ä»½æ–‡ä»¶æ¢å¤ã€‚</p>
        <button class="btn" id="backup-btn" onclick="exportBackup()">å¯¼å‡ºå¤‡ä»½</button>
        <label class="btn" style="cursor:pointer;background:var(--accent-dark)">
          å¯¼å…¥æ¢å¤
          <input type="file" id="restore-file" accept=".json" style="display:none">
        </label>
        <div id="backup-progress" style="display:none;margin-top:12px">
          <div style="background:var(--border);border-radius:10px;overflow:hidden;height:20px">
            <div id="backup-bar" style="height:100%;background:var(--accent);border-radius:10px;transition:width 0.3s;width:0%"></div>
          </div>
          <div id="backup-status" style="font-size:13px;color:var(--text-light);margin-top:4px"></div>
        </div>
        <div id="backup-msg"></div>
      </div>

      <!-- ç®¡ç†å‘˜ç®¡ç†ï¼ˆä»…è¶…ç®¡å¯è§ï¼‰ -->
      <div class="admin-section super-admin-only" style="display:none">
        <h3>ğŸ‘¥ ç®¡ç†å‘˜ç®¡ç†</h3>
        <div id="admin-users-list" style="margin-bottom:12px"></div>
        <details style="margin-top:8px">
          <summary style="cursor:pointer;font-size:14px;color:var(--accent)">+ æ·»åŠ ç®¡ç†å‘˜</summary>
          <div style="display:grid;grid-template-columns:1fr 1fr auto;gap:8px;margin-top:8px;align-items:end">
            <div>
              <label style="font-size:12px;color:var(--text-light)">ç”¨æˆ·å</label>
              <input type="text" id="new-admin-user" placeholder="å­—æ¯æ•°å­—ä¸‹åˆ’çº¿" style="width:100%;padding:6px 8px;border:1px solid var(--border);border-radius:var(--radius);background:var(--bg);color:var(--text)">
            </div>
            <div>
              <label style="font-size:12px;color:var(--text-light)">å¯†ç </label>
              <input type="password" id="new-admin-pass" placeholder="è‡³å°‘8ä½" style="width:100%;padding:6px 8px;border:1px solid var(--border);border-radius:var(--radius);background:var(--bg);color:var(--text)">
            </div>
            <button class="btn" onclick="createAdmin()">åˆ›å»º</button>
          </div>
          <div style="margin-top:4px">
            <label style="font-size:12px;color:var(--text-light)">è§’è‰²ï¼š</label>
            <select id="new-admin-role" style="padding:2px 6px;border:1px solid var(--border);border-radius:4px;background:var(--bg);color:var(--text);font-size:13px">
              <option value="demo">æ¼”ç¤ºç®¡ç†å‘˜</option>
              <option value="admin">ç®¡ç†å‘˜</option>
              <option value="super_admin">è¶…çº§ç®¡ç†å‘˜</option>
            </select>
          </div>
          <div style="margin-top:4px">
            <label style="font-size:12px;color:var(--text-light)">
              <input type="checkbox" id="new-admin-pwd-lock"> ç¦æ­¢ä¿®æ”¹å¯†ç 
            </label>
          </div>
          <div id="admin-user-msg"></div>
        </details>
      </div>

    </div><!-- /admin-panel -->
  </div>

  <script>
    // ===== ä¸»é¢˜ =====
    const THEMES = ['light','dark','green','sepia','blue'];
    const THEME_ICONS = {'light':'ğŸŒ™','dark':'â˜€ï¸','green':'ğŸƒ','sepia':'ğŸ“œ','blue':'ğŸ’§'};
    const savedTheme = localStorage.getItem('theme') || 'light';
    document.documentElement.setAttribute('data-theme', savedTheme);
    updateThemeBtn();
    function toggleTheme() {
      const current = document.documentElement.getAttribute('data-theme');
      const idx = THEMES.indexOf(current);
      const next = THEMES[(idx + 1) % THEMES.length];
      document.documentElement.setAttribute('data-theme', next);
      localStorage.setItem('theme', next);
      updateThemeBtn();
    }
    function updateThemeBtn() {
      const btn = document.querySelector('.theme-toggle');
      const t = document.documentElement.getAttribute('data-theme');
      btn.textContent = THEME_ICONS[t] || 'ğŸŒ™';
    }

    // ===== è®¤è¯ =====
    let authToken = sessionStorage.getItem('auth_token') || '';
    let currentRole = sessionStorage.getItem('auth_role') || '';
    let currentUserId = Number(sessionStorage.getItem('auth_uid')) || 0;
    let currentPasswordLocked = false;

    function getToken() { return authToken; }

    // ===== GitHub OAuth =====
    function doGitHubLogin() {
      // è·³è½¬åˆ°åç«¯å‘èµ· OAuthï¼ˆåç«¯è®¾ç½®ç­¾å cookie + 302 åˆ° GitHubï¼‰
      location.href = '/api/auth?action=github-login';
    }

    // é¡µé¢åŠ è½½æ—¶æ£€æŸ¥ GitHub OAuth å›è°ƒ + æ£€æŸ¥æ˜¯å¦å¯ç”¨
    (function handleGitHubCallback() {
      const hash = location.hash;
      if (hash.startsWith('#github_token=')) {
        const token = hash.slice('#github_token='.length);
        if (token) {
          authToken = token;
          sessionStorage.setItem('auth_token', token);
          history.replaceState(null, '', location.pathname);
          checkSession();
        }
      } else if (hash.startsWith('#github_error=')) {
        const error = decodeURIComponent(hash.slice('#github_error='.length));
        history.replaceState(null, '', location.pathname);
        setTimeout(() => showMsg('login-msg', 'GitHub ç™»å½•å¤±è´¥ï¼š' + error, 'error'), 100);
      }
      // æ£€æŸ¥æ˜¯å¦å¯ç”¨ GitHub ç™»å½•
      fetch('/api/settings?check=github').then(r => r.json()).then(d => {
        if (d.githubLoginEnabled) {
          const el = document.getElementById('github-login-section');
          if (el) el.style.display = '';
        }
      }).catch(() => {});
    })();

    async function doLogin() {
      const username = document.getElementById('login-user').value.trim();
      const password = document.getElementById('login-pass').value;
      if (!username || !password) return showMsg('login-msg','è¯·è¾“å…¥ç”¨æˆ·åå’Œå¯†ç ','error');
      try {
        const res = await fetch('/api/auth?action=login', {
          method:'POST', headers:{'Content-Type':'application/json'},
          body: JSON.stringify({username, password})
        });
        const data = await res.json();
        if (!res.ok) throw new Error(data.error);
        authToken = data.token;
        currentRole = data.role || 'demo';
        currentUserId = data.userId || 0;
        sessionStorage.setItem('auth_token', authToken);
        sessionStorage.setItem('auth_role', currentRole);
        sessionStorage.setItem('auth_uid', currentUserId);
        showAdminPanel(data.username, currentRole);
      } catch(e) { showMsg('login-msg', e.message, 'error'); }
    }

    async function checkSession() {
      if (!authToken) return false;
      try {
        const res = await fetch('/api/auth?action=me', {
          headers:{'Authorization':'Bearer '+authToken}
        });
        if (!res.ok) { authToken=''; currentRole=''; currentUserId=0; sessionStorage.removeItem('auth_token'); sessionStorage.removeItem('auth_role'); sessionStorage.removeItem('auth_uid'); return false; }
        const data = await res.json();
        if (data.authenticated) { currentRole = data.role || 'demo'; currentUserId = data.userId || 0; currentPasswordLocked = !!data.passwordLocked; sessionStorage.setItem('auth_role', currentRole); sessionStorage.setItem('auth_uid', currentUserId); showAdminPanel(data.username, currentRole); return true; }
      } catch {}
      authToken=''; currentRole=''; currentUserId=0; sessionStorage.removeItem('auth_token'); sessionStorage.removeItem('auth_role'); sessionStorage.removeItem('auth_uid');
      return false;
    }

    function showAdminPanel(username, role) {
      document.getElementById('login-panel').style.display = 'none';
      document.getElementById('admin-panel').style.display = 'block';
      document.getElementById('current-user').textContent = username;
      document.getElementById('user-info').textContent = username + (role === 'super_admin' ? ' (è¶…ç®¡)' : role === 'admin' ? ' (ç®¡ç†)' : ' (æ¼”ç¤º)');
      document.getElementById('user-info').style.display = 'inline';
      // å¯†ç é”å®šæˆ–demoè§’è‰²ï¼šéšè—ä¿®æ”¹å¯†ç é“¾æ¥
      const pwdLink = document.querySelector('a[onclick*="showChangePassword"]');
      if (pwdLink) pwdLink.style.display = (currentPasswordLocked || role === 'demo') ? 'none' : '';
      // super_adminä¸“å±åŠŸèƒ½
      const saEls = document.querySelectorAll('.super-admin-only');
      saEls.forEach(el => el.style.display = role === 'super_admin' ? '' : 'none');
      // demoç”¨æˆ·æ˜¾ç¤ºæ³¨é”€æŒ‰é’®
      const deactivateBtn = document.getElementById('deactivate-account-btn');
      if (deactivateBtn) deactivateBtn.style.display = role === 'demo' ? '' : 'none';
      refreshAllBooks(); loadSettings(); loadStats(); loadFontList();
      if (role === 'super_admin') { loadAdminUsers(); loadGitHubConfig(); }
    }

    async function doLogout() {
      try { await fetch('/api/auth?action=logout',{method:'POST',headers:{'Authorization':'Bearer '+authToken}}); } catch{}
      authToken = '';
      currentRole = '';
      currentUserId = 0;
      sessionStorage.removeItem('auth_token');
      sessionStorage.removeItem('auth_role');
      sessionStorage.removeItem('auth_uid');
      document.getElementById('login-panel').style.display = 'block';
      document.getElementById('admin-panel').style.display = 'none';
      document.getElementById('user-info').style.display = 'none';
      document.getElementById('login-pass').value = '';
    }

    async function deactivateAccount() {
      if (!confirm('âš ï¸ ç¡®å®šè¦æ³¨é”€è´¦å·å—ï¼Ÿ\n\nâ€¢ æ‚¨åˆ›å»ºçš„ä¹¦ç±å’Œç« èŠ‚å°†è½¬äº¤ç»™ç®¡ç†å‘˜ä¿ç®¡\nâ€¢ æ­¤æ“ä½œä¸å¯æ¢å¤ï¼')) return;
      if (!confirm('å†æ¬¡ç¡®è®¤ï¼šæ³¨é”€åæ— æ³•æ¢å¤ï¼Œç¡®å®šç»§ç»­ï¼Ÿ')) return;
      try {
        const res = await fetch('/api/admin/account', { method: 'DELETE', headers: { 'Authorization': 'Bearer ' + authToken, 'Content-Type': 'application/json' } });
        const data = await res.json();
        if (!res.ok) throw new Error(data.error);
        alert('è´¦å·å·²æ³¨é”€ã€‚æ„Ÿè°¢ä½¿ç”¨ï¼');
        doLogout();
      } catch (e) { alert('æ³¨é”€å¤±è´¥ï¼š' + e.message); }
    }

    function showChangePassword() {
      if (currentPasswordLocked) { alert('è¯¥è´¦å·ä¸å…è®¸ä¿®æ”¹å¯†ç '); return; }
      document.getElementById('pwd-form').style.display = 'block';
    }

    async function doChangePassword() {
      const oldPwd = document.getElementById('old-pwd').value;
      const newPwd = document.getElementById('new-pwd').value;
      const newPwd2 = document.getElementById('new-pwd2').value;
      if (!oldPwd || !newPwd) return showMsg('pwd-msg','è¯·å¡«å†™æ‰€æœ‰å­—æ®µ','error');
      if (newPwd !== newPwd2) return showMsg('pwd-msg','ä¸¤æ¬¡è¾“å…¥çš„æ–°å¯†ç ä¸ä¸€è‡´','error');
      if (newPwd.length < 8) return showMsg('pwd-msg','æ–°å¯†ç è‡³å°‘8ä½','error');
      if (!/[a-zA-Z]/.test(newPwd)||!/\d/.test(newPwd)) return showMsg('pwd-msg','æ–°å¯†ç éœ€åŒ…å«å­—æ¯å’Œæ•°å­—','error');
      try {
        const res = await api('POST','/api/auth?action=password',{oldPassword:oldPwd,newPassword:newPwd});
        const data = await res.json();
        if (!res.ok) throw new Error(data.error);
        showMsg('pwd-msg','å¯†ç å·²ä¿®æ”¹ï¼Œè¯·é‡æ–°ç™»å½•','success');
        setTimeout(()=>doLogout(), 2000);
      } catch(e) { showMsg('pwd-msg',e.message,'error'); }
    }

    // é¡µé¢åŠ è½½æ—¶æ£€æŸ¥session
    checkSession();

    // ===== ç«™ç‚¹è®¾ç½® =====
    async function loadSettings() {
      try {
        const res = await fetch('/api/settings');
        const data = await res.json();
        const s = data.settings || {};
        document.getElementById('set-site-name').value = s.site_name || '';
        document.getElementById('set-site-desc').value = s.site_desc || '';
        document.getElementById('set-footer').value = s.footer_text || '';
        if (s.site_name) document.querySelector('.navbar h1 a').textContent = 'ğŸ“š ' + s.site_name;
      } catch {}
    }
    async function saveSettings() {
      const settings = {
        site_name: document.getElementById('set-site-name').value.trim(),
        site_desc: document.getElementById('set-site-desc').value.trim(),
        footer_text: document.getElementById('set-footer').value.trim(),
      };
      try {
        const res = await api('PUT','/api/admin/settings',{settings});
        const data = await res.json();
        if (!res.ok) throw new Error(data.error);
        showMsg('settings-msg','è®¾ç½®å·²ä¿å­˜','success');
        document.querySelector('.navbar h1 a').textContent = 'ğŸ“š ' + (settings.site_name || 'æˆ‘çš„ä¹¦æ¶');
      } catch(e) { showMsg('settings-msg',e.message,'error'); }
    }

    // ===== GitHub OAuth é…ç½® =====
    function toggleGitHubConfig() {
      document.getElementById('gh-oauth-config').style.display =
        document.getElementById('gh-oauth-enabled').checked ? '' : 'none';
    }

    async function loadGitHubConfig() {
      // å¡«å…… URL æç¤º
      document.getElementById('gh-homepage-url').textContent = location.origin;
      document.getElementById('gh-callback-url').textContent = location.origin + '/api/auth/github/callback';
      try {
        const res = await api('GET', '/api/admin/settings?section=github');
        const data = await res.json();
        if (!res.ok) return;
        document.getElementById('gh-oauth-enabled').checked = data.enabled;
        document.getElementById('gh-client-id').value = data.clientId || '';
        document.getElementById('gh-secret-status').textContent = data.hasSecret ? 'ï¼ˆå·²é…ç½® âœ…ï¼‰' : 'ï¼ˆæœªé…ç½®ï¼‰';
        toggleGitHubConfig();
      } catch {}
    }

    async function saveGitHubConfig() {
      const enabled = document.getElementById('gh-oauth-enabled').checked;
      const clientId = document.getElementById('gh-client-id').value.trim();
      const clientSecret = document.getElementById('gh-client-secret').value.trim();

      if (enabled && !clientId) {
        return showMsg('gh-config-msg', 'è¯·å¡«å†™ Client ID', 'error');
      }

      try {
        const res = await api('POST', '/api/admin/settings?section=github', {
          enabled, clientId, clientSecret: clientSecret || undefined
        });
        const data = await res.json();
        if (!res.ok) throw new Error(data.error);
        showMsg('gh-config-msg', 'é…ç½®å·²ä¿å­˜', 'success');
        document.getElementById('gh-client-secret').value = '';
        loadGitHubConfig();
      } catch(e) { showMsg('gh-config-msg', e.message, 'error'); }
    }

    // ===== TXTå¯¼å…¥ =====
    // ç« èŠ‚æ­£åˆ™v3ï¼šä¿®å¤ä¸Šä¸­ä¸‹ç¯‡è¯¯åŒ¹é…ã€Partç½—é©¬æ•°å­—è¿‡å®½ã€è¿ç»­æ ‡é¢˜ä¸¢å¼ƒã€å‰è¨€ä¸¢å¤±
    const CHAPTER_REGEX = /^[^\S\n\r]*(?:(?:æ­£æ–‡|ä¸Šå·|ä¸‹å·|[ä¸Šä¸­ä¸‹]å†Œ|å·[é›¶ã€‡ä¸€äºŒä¸‰å››äº”å…­ä¸ƒå…«ä¹åç™¾åƒ\d]+)\s+)?(?:[ã€\[ã€Œ]?ç¬¬[é›¶ã€‡ä¸€äºŒä¸‰å››äº”å…­ä¸ƒå…«ä¹åç™¾åƒä¸‡å£¹è´°åè‚†ä¼é™†æŸ’æŒç–æ‹¾ä½°ä»Ÿ\d]+[ç« èŠ‚å›å·é›†éƒ¨ç¯‡å¹•è¯][ã€‘\]ã€]?(?=[\s:ï¼š\-â€”,ï¼Œ.ã€‚!ï¼?ï¼Ÿã€ï¼‰)\]ã€‘ã€}\d~ï½Â·]|$)|(?:chapter|CHAPTER|Chapter)\s+\d+|Part\s+(?:\d+|[IVXLCDM]+|[ivxlcdm]+)|[ä¸Šä¸­ä¸‹]ç¯‡(?=[\s:ï¼š\-â€”]|$)|(?:åº[ç« è¨€å¹•]|æ¥”å­|å°¾å£°|ç•ªå¤–(?:[ç¯‡ï¼š: \dä¸€äºŒä¸‰å››äº”å…­ä¸ƒå…«ä¹å]*)|åè®°|å‰è¨€|å¼•[å­è¨€]|é™„å½•|ç»ˆç« |å¤§ç»“å±€)(?=[\s:ï¼š\-â€”]|$)(?![\u4e00-\u9fff]))[^\S\n\r]*[:ï¼š\-â€”~ï½Â·|ï½œ]*[^\S\n\r]*[^\n\r]{0,100}$/gm;
    let parsedChapters = [];

    function decodeText(buffer) {
      const bytes = new Uint8Array(buffer);
      if (bytes[0]===0xEF&&bytes[1]===0xBB&&bytes[2]===0xBF) return new TextDecoder('utf-8').decode(buffer);
      if (bytes[0]===0xFF&&bytes[1]===0xFE) return new TextDecoder('utf-16le').decode(buffer);
      if (bytes[0]===0xFE&&bytes[1]===0xFF) return new TextDecoder('utf-16be').decode(buffer);
      const utf8 = new TextDecoder('utf-8',{fatal:false}).decode(buffer);
      if (!utf8.includes('\uFFFD')) return utf8;
      try { return new TextDecoder('gbk').decode(buffer); } catch{}
      return utf8;
    }
    function splitChapters(text) {
      if (!text || text.length > 50 * 1024 * 1024) return null;
      const normalized = text.replace(/\r\n?/g, '\n');
      const lines = normalized.split('\n');
      const chapters = [];
      let curTitle = null, curContent = [], preContent = [];

      for (const line of lines) {
        const trimmed = line.replace(/^[\s\u3000]+/,'').replace(/[\s\u3000]+$/,'');
        CHAPTER_REGEX.lastIndex = 0;
        if (trimmed && CHAPTER_REGEX.test(trimmed) && trimmed.length <= 120) {
          if (curTitle !== null) {
            const content = curContent.join('\n').trim();
            chapters.push({title:curTitle, content, checked:true});
          } else if (preContent.length > 0) {
            const pre = preContent.join('\n').trim();
            if (pre) chapters.push({title:'å‰è¨€', content:pre, checked:true});
          }
          curTitle = trimmed.substring(0, 120);
          curContent = [];
        } else if (curTitle !== null) {
          curContent.push(line);
        } else {
          preContent.push(line);
        }
      }
      // æœ€åä¸€ç« ï¼ˆå³ä½¿æ— æ­£æ–‡ä¹Ÿä¿ç•™ï¼‰
      if (curTitle !== null) {
        const content = curContent.join('\n').trim();
        chapters.push({title:curTitle, content, checked:true});
      } else if (preContent.length > 0) {
        const pre = preContent.join('\n').trim();
        if (pre) chapters.push({title:'å‰è¨€', content:pre, checked:true});
      }

      return chapters.length > 0 ? chapters : null;
    }
    function splitBySize(text,size=5000) {
      const chapters=[]; const paras=text.split(/\n\s*\n/);
      let cur='',idx=1;
      for (const p of paras) {
        if (cur.length+p.length>size&&cur.length>0) {
          chapters.push({title:`ç¬¬${idx}ç« `,content:cur.trim(),checked:true});
          idx++; cur=p;
        } else { cur+=(cur?'\n\n':'')+p; }
      }
      if (cur.trim()) chapters.push({title:`ç¬¬${idx}ç« `,content:cur.trim(),checked:true});
      return chapters;
    }
    document.getElementById('import-file').addEventListener('change',async function(){
      const file=this.files[0]; if(!file) return;
      if (file.size>50*1024*1024) return showMsg('import-msg','æ–‡ä»¶è¶…è¿‡50MBé™åˆ¶','error');
      showMsg('import-msg','æ­£åœ¨è§£ææ–‡ä»¶...','');
      try {
        const buffer=await file.arrayBuffer();
        const text=decodeText(buffer);
        parsedChapters=splitChapters(text);
        if (!parsedChapters) {
          if (confirm('æœªæ£€æµ‹åˆ°ç« èŠ‚æ ‡è®°ï¼Œæ˜¯å¦æŒ‰æ¯5000å­—è‡ªåŠ¨åˆ†å‰²ï¼Ÿ')) {
            parsedChapters=splitBySize(text);
          } else {
            parsedChapters=[{title:file.name.replace(/\.txt$/i,''),content:text.trim(),checked:true}];
          }
        }
        renderImportPreview();
        showMsg('import-msg','','');
      } catch(e) { showMsg('import-msg','æ–‡ä»¶è§£æå¤±è´¥ï¼š'+e.message,'error'); }
    });
    function renderImportPreview() {
      const el=document.getElementById('import-chapters');
      const totalWords=parsedChapters.reduce((s,c)=>s+c.content.length,0);
      document.getElementById('import-total').textContent=parsedChapters.length;
      document.getElementById('import-words').textContent=totalWords.toLocaleString();
      el.innerHTML=parsedChapters.map((c,i)=>`
        <div style="padding:8px 0;border-bottom:1px solid var(--border)">
          <div style="display:flex;align-items:center;gap:8px">
            <input type="checkbox" ${c.checked?'checked':''} data-idx="${i}" class="import-check">
            <input type="text" value="${esc(c.title)}" data-idx="${i}" class="import-title-edit" style="flex:1;padding:4px 8px;border:1px solid var(--border);border-radius:4px;font-size:14px;background:var(--bg);color:var(--text)">
            <span style="font-size:12px;color:var(--text-light);white-space:nowrap">${c.content.length} å­—</span>
          </div>
          <div style="font-size:12px;color:var(--text-light);margin-top:4px;padding-left:28px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">${esc(c.content.slice(0,120))}</div>
        </div>
      `).join('');
      // äº‹ä»¶å§”æ‰˜
      el.addEventListener('change', (e) => {
        if (e.target.classList.contains('import-check')) {
          parsedChapters[e.target.dataset.idx].checked = e.target.checked;
        }
      });
      el.addEventListener('input', (e) => {
        if (e.target.classList.contains('import-title-edit')) {
          parsedChapters[e.target.dataset.idx].title = e.target.value;
        }
      });
      document.getElementById('import-preview').style.display='block';
    }
    function cancelImport() {
      parsedChapters=[];
      document.getElementById('import-preview').style.display='none';
      document.getElementById('import-file').value='';
      document.querySelector('.import-progress').style.display='none';
    }
    async function startImport() {
      const bookId=document.getElementById('import-book').value;
      if (!bookId) return showMsg('import-msg','è¯·é€‰æ‹©ç›®æ ‡ä¹¦ç±','error');
      const chapters=parsedChapters.filter(c=>c.checked);
      if (chapters.length===0) return showMsg('import-msg','æ²¡æœ‰é€‰ä¸­ä»»ä½•ç« èŠ‚','error');
      const bar=document.getElementById('import-bar');
      const status=document.getElementById('import-status');
      document.querySelector('.import-progress').style.display='block';
      // è·å–å·²æœ‰ç« èŠ‚çš„æœ€å¤§sort_orderä½œä¸ºåŸºå‡†
      let baseOrder = 0;
      try {
        const bRes = await fetch(`/api/books/${bookId}`);
        const bData = await bRes.json();
        const chs = bData.chapters || [];
        if (chs.length > 0) baseOrder = Math.max(...chs.map(c => c.sort_order || 0));
      } catch {}
      let uploaded=0,errors=[];
      const tasks = chapters.map((ch, idx) => async () => {
        let lastErr;
        for (let retry = 0; retry < 3; retry++) {
          try {
            const res = await api('POST','/api/admin/chapters',{book_id:Number(bookId),title:ch.title,content:ch.content,sort_order:baseOrder+idx+1});
            if (res.ok) return;
            const d = await res.json();
            if (res.status >= 400 && res.status < 500) { errors.push(ch.title+': '+d.error); return; }
            lastErr = d.error;
          } catch(e) { lastErr = e.message; }
          if (retry < 2) await new Promise(r => setTimeout(r, 1000 * (retry + 1)));
        }
        errors.push(ch.title+': '+lastErr);
      });
      // è¿›åº¦è¿½è¸ªåŒ…è£…
      const tracked = tasks.map(fn => async () => { try { await fn(); } finally { uploaded++; const pct=Math.round(uploaded/chapters.length*100); bar.style.width=pct+'%'; status.textContent=`${uploaded}/${chapters.length} ç« ï¼ˆ${pct}%ï¼‰`; } });
      await concurrentUpload(tracked, 3);
      if (errors.length>0) {
        showMsg('import-msg',`å¯¼å…¥å®Œæˆï¼Œ${errors.length} ç« å¤±è´¥ï¼š${errors.slice(0,3).join('ï¼›')}`,'error');
      } else { showMsg('import-msg',`æˆåŠŸå¯¼å…¥ ${uploaded} ç« `,'success'); }
      cancelImport(); refreshAllBooks();
    }

    // ===== TXTå¯¼å‡º =====
    function downloadTxt(text,filename) {
      const BOM='\uFEFF';
      const blob=new Blob([BOM+text],{type:'text/plain;charset=utf-8'});
      const url=URL.createObjectURL(blob);
      const a=document.createElement('a');
      a.href=url; a.download=filename; a.click();
      URL.revokeObjectURL(url);
    }
    async function exportBook(bookId) {
      showMsg('manage-msg','æ­£åœ¨å¯¼å‡º...','');
      try {
        const res=await fetch(`/api/books/${bookId}`);
        const data=await res.json();
        const book=data.book; const chapters=data.chapters||[];
        if (chapters.length===0) return showMsg('manage-msg','æ²¡æœ‰ç« èŠ‚å¯å¯¼å‡º','error');
        const parts=[];
        for (const ch of chapters) {
          const r=await fetch(`/api/chapters/${ch.id}`);
          const d=await r.json();
          parts.push(ch.title+'\n\n'+d.content);
        }
        const sep='\n\n'+'='.repeat(40)+'\n\n';
        const header=`ã€Š${book.title}ã€‹\n${book.author?'ä½œè€…ï¼š'+book.author+'\n':''}\n`;
        downloadTxt(header+parts.join(sep),(book.title+(book.author?'_'+book.author:'')+'.txt').replace(/[<>:"/\\|?*]/g,'_'));
        showMsg('manage-msg','å¯¼å‡ºæˆåŠŸ','success');
      } catch(e) { showMsg('manage-msg','å¯¼å‡ºå¤±è´¥ï¼š'+e.message,'error'); }
    }
    async function exportChapter(chapterId,title) {
      try {
        const res=await fetch(`/api/chapters/${chapterId}`);
        const data=await res.json();
        downloadTxt(data.content,(title+'.txt').replace(/[<>:"/\\|?*]/g,'_'));
      } catch(e) { alert('å¯¼å‡ºå¤±è´¥ï¼š'+e.message); }
    }

    // ===== ä¹¦ç± =====
    // ç¼“å­˜ä¹¦ç±æ•°æ®ç”¨äºäº‹ä»¶å§”æ‰˜
    let _booksCache = [];
    let _chaptersCache = [];

    // å…±äº« fetchBooksï¼šåˆå¹¶ loadBookList å’Œ loadBookSelects çš„ API è°ƒç”¨
    // å¿…é¡»å¸¦ Authorization headerï¼Œå¦åˆ™åç«¯ä¸è¿”å› created_byï¼Œdemo æ— æ³•åˆ¤æ–­æ‰€æœ‰æƒ
    let _booksPromise = null;
    function fetchBooks() {
      if (!_booksPromise) {
        _booksPromise = api('GET', '/api/books').then(r => r.json()).then(d => {
          _booksPromise = null;
          return d;
        }).catch(e => { _booksPromise = null; throw e; });
      }
      return _booksPromise;
    }

    // ç»Ÿä¸€åˆ·æ–°ä¹¦ç±åˆ—è¡¨+ä¸‹æ‹‰æ¡†ï¼ˆåªå‘ä¸€æ¬¡è¯·æ±‚ï¼‰
    async function refreshAllBooks() {
      const data = await fetchBooks();
      renderBookList(data);
      renderBookSelects(data);
    }

    async function loadBookList() {
      const data = await fetchBooks();
      renderBookList(data);
    }

    function renderBookList(data) {
      const el=document.getElementById('book-list');
      try {
        if (!data.books||data.books.length===0) {
          el.innerHTML='<li style="padding:12px 0;color:var(--text-light)">æš‚æ— ä¹¦ç±</li>'; _booksCache=[]; return;
        }
        _booksCache = data.books;
        el.innerHTML=data.books.map(b=>{
          const isOwner = currentRole !== 'demo' || b.created_by === currentUserId;
          const canDelete = currentRole !== 'demo' || b.created_by === currentUserId;
          return `
          <li data-id="${b.id}">
            <div class="item-info">
              <div class="item-title">${esc(b.title)}${currentRole === 'demo' && !isOwner ? ' <span style="font-size:11px;color:var(--text-light)">(ä»–äºº)</span>' : ''}</div>
              <div class="item-meta">${b.author?esc(b.author)+' Â· ':''}${b.chapter_count} ç«  Â· ${b.total_words} å­—</div>
            </div>
            <div class="item-actions">
              ${isOwner ? '<button class="btn btn-sm btn-edit-book">ç¼–è¾‘</button>' : ''}
              ${canDelete ? '<button class="btn btn-sm btn-danger btn-delete-book">åˆ é™¤</button>' : ''}
            </div>
          </li>
        `}).join('');
      } catch(e) {
        const el=document.getElementById('book-list');
        el.innerHTML=`<li class="msg msg-error">${esc(e.message)}</li>`;
      }
    }

    // ä¹¦ç±åˆ—è¡¨äº‹ä»¶å§”æ‰˜
    document.getElementById('book-list').addEventListener('click', function(e) {
      const li = e.target.closest('li[data-id]');
      if (!li) return;
      const id = Number(li.dataset.id);
      const book = _booksCache.find(b => b.id === id);
      if (!book) return;
      if (e.target.classList.contains('btn-edit-book')) {
        openBookEditOverlay(book);
      } else if (e.target.classList.contains('btn-delete-book')) {
        const btn = e.target;
        if (!confirm(`ç¡®å®šåˆ é™¤ã€Œ${book.title}ã€åŠå…¶æ‰€æœ‰ç« èŠ‚ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ï¼`)) return;
        btn.disabled = true;
        btn.textContent = 'åˆ é™¤ä¸­...';
        btn.style.opacity = '0.6';
        api('DELETE',`/api/admin/books/${id}`).then(r=>r.json()).then(d=>{
          if (!d.success&&d.error) throw new Error(d.error);
          refreshAllBooks(); loadChapters();
        }).catch(err=>{
          alert('åˆ é™¤å¤±è´¥ï¼š'+err.message);
          btn.disabled = false;
          btn.textContent = 'åˆ é™¤';
          btn.style.opacity = '';
        });
      }
    });
    async function loadBookSelects() {
      const data = await fetchBooks();
      renderBookSelects(data);
    }

    function renderBookSelects(data) {
      try {
        const allBooks = data.books || [];
        // demoç”¨æˆ·åªèƒ½åœ¨æ·»åŠ ç« èŠ‚/ç« èŠ‚ç®¡ç†/å¯¼å…¥ä¸­é€‰è‡ªå·±çš„ä¹¦
        const myBooks = currentRole === 'demo' ? allBooks.filter(b => b.created_by === currentUserId) : allBooks;
        const opts = myBooks.length === 0
          ? '<option value="">è¯·å…ˆåˆ›å»ºä¸€æœ¬ä¹¦</option>'
          : myBooks.map(b => `<option value="${b.id}">${esc(b.title)}</option>`).join('');
        document.getElementById('chapter-book').innerHTML=opts;
        document.getElementById('import-book').innerHTML=opts;
        document.getElementById('manage-book').innerHTML='<option value="">é€‰æ‹©ä¹¦ç±...</option>'+opts;
      } catch{}
    }
    async function createBook() {
      const title=document.getElementById('book-title').value.trim();
      const author=document.getElementById('book-author').value.trim();
      const description=document.getElementById('book-desc').value.trim();
      if (!title) return showMsg('book-msg','è¯·è¾“å…¥ä¹¦å','error');
      try {
        const res=await api('POST','/api/admin/books',{title,author,description});
        const data=await res.json();
        if (!res.ok) throw new Error(data.error);
        // ä¿å­˜æ ‡ç­¾
        if (_createBookTags.length > 0 && data.book && data.book.id) {
          await api('PUT', '/api/admin/book-tags', { book_id: data.book.id, tag_ids: _createBookTags }).catch(() => {});
        }
        showMsg('book-msg',`åˆ›å»ºæˆåŠŸï¼š${esc(data.book.title)}`,'success');
        document.getElementById('book-title').value='';
        document.getElementById('book-author').value='';
        document.getElementById('book-desc').value='';
        _createBookTags = [];
        renderCreateBookTags();
        refreshAllBooks();
      } catch(e) { showMsg('book-msg',e.message,'error'); }
    }
    function editBook(id,title,author,desc) {
      const newTitle=prompt('ä¹¦åï¼š',title);
      if (newTitle===null) return;
      const newAuthor=prompt('ä½œè€…ï¼š',author);
      const newDesc=prompt('ç®€ä»‹ï¼š',desc);
      api('PUT',`/api/admin/books/${id}`,{title:newTitle||title,author:newAuthor||'',description:newDesc||''})
        .then(r=>r.json()).then(d=>{if(d.error)throw new Error(d.error);refreshAllBooks();})
        .catch(e=>alert('ç¼–è¾‘å¤±è´¥ï¼š'+e.message));
    }
    // ===== ç« èŠ‚ =====
    async function createChapter() {
      const book_id=document.getElementById('chapter-book').value;
      const title=document.getElementById('chapter-title').value.trim();
      const content=document.getElementById('chapter-content').value.trim();
      if (!book_id) return showMsg('chapter-msg','è¯·é€‰æ‹©ä¹¦ç±','error');
      if (!title) return showMsg('chapter-msg','è¯·è¾“å…¥ç« èŠ‚æ ‡é¢˜','error');
      if (!content) return showMsg('chapter-msg','è¯·è¾“å…¥ç« èŠ‚å†…å®¹','error');
      try {
        const res=await api('POST','/api/admin/chapters',{book_id:Number(book_id),title,content});
        const data=await res.json();
        if (!res.ok) throw new Error(data.error);
        showMsg('chapter-msg',`å‘å¸ƒæˆåŠŸï¼š${esc(data.chapter.title)}ï¼ˆ${data.chapter.word_count} å­—ï¼‰`,'success');
        document.getElementById('chapter-title').value='';
        document.getElementById('chapter-content').value='';
        document.getElementById('word-count').textContent='0';
        refreshAllBooks(); if(document.getElementById('manage-book').value==book_id) loadChapters();
      } catch(e) { showMsg('chapter-msg',e.message,'error'); }
    }
    async function loadChapters() {
      const bookId=document.getElementById('manage-book').value;
      const el=document.getElementById('chapter-list');
      const exportArea=document.getElementById('export-area');
      if (!bookId) { el.innerHTML=''; exportArea.innerHTML=''; _chaptersCache=[]; document.getElementById('batch-bar').style.display='none'; return; }
      try {
        const res=await fetch(`/api/books/${bookId}`);
        const data=await res.json();
        const chapters=data.chapters||[];
        _chaptersCache = chapters;
        if (chapters.length===0) {
          el.innerHTML='<li style="padding:12px 0;color:var(--text-light)">æš‚æ— ç« èŠ‚</li>';
          exportArea.innerHTML=''; return;
        }
        el.innerHTML=chapters.map((c,i)=>`
          <li data-id="${c.id}" data-idx="${i}">
            <div style="display:flex;align-items:center;gap:8px;flex:1">
              <input type="checkbox" class="ch-select" data-id="${c.id}">
              <div class="item-info">
                <div class="item-title">${esc(c.title)}</div>
                <div class="item-meta">ç¬¬${c.sort_order}ç«  Â· ${c.word_count} å­—</div>
              </div>
            </div>
            <div class="item-actions">
              ${i>0?`<button class="btn btn-sm btn-move-up">â†‘</button>`:''}
              ${i<chapters.length-1?`<button class="btn btn-sm btn-move-down">â†“</button>`:''}
              <button class="btn btn-sm btn-export-ch">å¯¼å‡º</button>
              <button class="btn btn-sm btn-edit-ch">ç¼–è¾‘</button>
              <button class="btn btn-sm btn-danger btn-delete-ch">åˆ é™¤</button>
            </div>
          </li>
        `).join('');
        document.getElementById('batch-bar').style.display='flex';
        document.getElementById('select-all').checked=false;
        updateSelectedCount();
        exportArea.innerHTML=`<a href="#" id="export-book-link" style="font-size:13px;color:var(--text-light);text-decoration:none;border-bottom:1px dashed var(--text-light)">å¯¼å‡ºå…¨ä¹¦ TXT</a>`;
        document.getElementById('export-book-link').addEventListener('click',function(e){e.preventDefault();exportBook(bookId);});
      } catch(e) { el.innerHTML=`<li class="msg msg-error">${esc(e.message)}</li>`; }
    }

    // manage-book / select-all / ch-select äº‹ä»¶ç»‘å®šï¼ˆæ›¿ä»£å†…è” onchangeï¼‰
    document.getElementById('manage-book').addEventListener('change', loadChapters);
    document.getElementById('select-all').addEventListener('change', function() {
      toggleSelectAll(this.checked);
    });
    document.getElementById('chapter-list').addEventListener('change', function(e) {
      if (e.target.classList.contains('ch-select')) updateSelectedCount();
    });

    // ç« èŠ‚åˆ—è¡¨äº‹ä»¶å§”æ‰˜
    document.getElementById('chapter-list').addEventListener('click', async function(e) {
      const li = e.target.closest('li[data-id]');
      if (!li) return;
      const id = Number(li.dataset.id);
      const idx = Number(li.dataset.idx);
      const ch = _chaptersCache[idx];
      if (!ch) return;

      if (e.target.classList.contains('btn-move-up') && idx > 0) {
        const prev = _chaptersCache[idx-1];
        try {
          const res=await api('POST','/api/admin/chapters/swap',{id1:id,id2:prev.id});
          const d=await res.json(); if(!res.ok) throw new Error(d.error);
          loadChapters();
        } catch(e) { showMsg('manage-msg','æ’åºå¤±è´¥ï¼š'+e.message,'error'); }
      } else if (e.target.classList.contains('btn-move-down') && idx < _chaptersCache.length-1) {
        const next = _chaptersCache[idx+1];
        try {
          const res=await api('POST','/api/admin/chapters/swap',{id1:next.id,id2:id});
          const d=await res.json(); if(!res.ok) throw new Error(d.error);
          loadChapters();
        } catch(e) { showMsg('manage-msg','æ’åºå¤±è´¥ï¼š'+e.message,'error'); }
      } else if (e.target.classList.contains('btn-export-ch')) {
        try {
          const res=await fetch(`/api/chapters/${id}`);
          const data=await res.json();
          downloadTxt(data.content,(ch.title+'.txt').replace(/[<>:"/\\|?*]/g,'_'));
        } catch(e) { alert('å¯¼å‡ºå¤±è´¥ï¼š'+e.message); }
      } else if (e.target.classList.contains('btn-edit-ch')) {
        const newTitle=prompt('ç« èŠ‚æ ‡é¢˜ï¼š');
        if (newTitle===null) return;
        const editContent=confirm('æ˜¯å¦ä¿®æ”¹æ­£æ–‡å†…å®¹ï¼Ÿ');
        let body={};
        if (newTitle) body.title=newTitle;
        if (editContent) { const c=prompt('è¾“å…¥æ–°çš„æ­£æ–‡å†…å®¹ï¼ˆä¼šå®Œå…¨æ›¿æ¢åŸå†…å®¹ï¼‰ï¼š'); if(c) body.content=c; }
        if (!body.title&&!body.content) return;
        try {
          const res=await api('PUT',`/api/admin/chapters/${id}`,body);
          const d=await res.json(); if(!res.ok) throw new Error(d.error);
          showMsg('manage-msg','ç¼–è¾‘æˆåŠŸ','success');
          loadChapters(); refreshAllBooks();
        } catch(e) { showMsg('manage-msg','ç¼–è¾‘å¤±è´¥ï¼š'+e.message,'error'); }
      } else if (e.target.classList.contains('btn-delete-ch')) {
        if (!confirm(`ç¡®å®šåˆ é™¤ç« èŠ‚ã€Œ${ch.title}ã€ï¼Ÿ`)) return;
        try {
          const res=await api('DELETE',`/api/admin/chapters/${id}`);
          const d=await res.json(); if(!res.ok) throw new Error(d.error);
          loadChapters(); refreshAllBooks();
        } catch(e) { showMsg('manage-msg','åˆ é™¤å¤±è´¥ï¼š'+e.message,'error'); }
      }
    });

    // ===== å·¥å…· =====
    function api(method,url,body) {
      const opts={method,headers:{'Authorization':`Bearer ${getToken()}`,'Content-Type':'application/json'}};
      if (body) opts.body=JSON.stringify(body);
      return fetch(url,opts);
    }

    // å¹¶å‘ä¸Šä¼ æ§åˆ¶å™¨
    async function concurrentUpload(tasks, concurrency = 3) {
      let idx = 0;
      const results = [];
      async function worker() {
        while (idx < tasks.length) {
          const i = idx++;
          try { results[i] = await tasks[i](); } catch (e) { results[i] = e; }
        }
      }
      await Promise.all(Array.from({ length: Math.min(concurrency, tasks.length) }, worker));
      return results;
    }
    function showMsg(id,text,type) {
      const el=document.getElementById(id);
      el.className=type?`msg msg-${type}`:'';
      el.textContent=text;
      if (type==='success') setTimeout(()=>{el.className='';el.textContent='';},5000);
    }
    function esc(s) { const d=document.createElement('div'); d.textContent=s||''; return d.innerHTML.replace(/"/g,'&quot;').replace(/'/g,'&#39;'); }

    document.getElementById('chapter-content').addEventListener('input',function(){
      document.getElementById('word-count').textContent=this.value.trim().length;
    });

    // ===== æ•°æ®æ¦‚è§ˆ =====
    async function loadStats() {
      try {
        const res = await api('GET', '/api/books');
        const data = await res.json();
        const books = data.books || [];
        const totalChapters = books.reduce((s, b) => s + (b.chapter_count || 0), 0);
        const totalWords = books.reduce((s, b) => s + (b.total_words || 0), 0);
        document.getElementById('stat-books').textContent = books.length;
        document.getElementById('stat-chapters').textContent = totalChapters;
        document.getElementById('stat-words').textContent = totalWords >= 10000
          ? (totalWords / 10000).toFixed(1) + ' ä¸‡'
          : totalWords.toLocaleString();
      } catch {}
      // åŠ è½½è®¿é—®ç»Ÿè®¡
      try {
        const res = await api('GET', '/api/admin/stats');
        const data = await res.json();
        document.getElementById('stat-pv').textContent = (data.today?.pv || 0).toLocaleString();
        document.getElementById('stat-uv').textContent = (data.today?.uv || 0).toLocaleString();
        const totalPv = data.totals?.total_pv || 0;
        document.getElementById('stat-total-pv').textContent = totalPv >= 10000
          ? (totalPv / 10000).toFixed(1) + ' ä¸‡' : totalPv.toLocaleString();
        // çƒ­é—¨ä¹¦ç±
        const el = document.getElementById('hot-books');
        if (data.hotBooks && data.hotBooks.length > 0) {
          el.innerHTML = '<h4 style="margin:0 0 8px;font-size:14px;color:var(--text-light)">ğŸ“ˆ è¿‘30å¤©çƒ­é—¨ä¹¦ç±</h4>' +
            '<ul style="list-style:none;padding:0;margin:0">' +
            data.hotBooks.map((b, i) => `<li style="display:flex;justify-content:space-between;padding:6px 0;border-bottom:1px solid var(--border);font-size:14px"><span>${i+1}. ${esc(b.title)}</span><span style="color:var(--text-light)">${b.total_views} æ¬¡</span></li>`).join('') +
            '</ul>';
        } else {
          el.innerHTML = '';
        }
      } catch {}
    }

    // ===== ç®¡ç†å‘˜ç®¡ç† =====
    let _adminsCache = [];
    async function loadAdminUsers() {
      try {
        const res = await api('GET', '/api/admin/users');
        const data = await res.json();
        const admins = data.admins || [];
        _adminsCache = admins;
        const el = document.getElementById('admin-users-list');
        if (admins.length === 0) { el.innerHTML = '<p style="color:var(--text-light);font-size:13px">æš‚æ— ç®¡ç†å‘˜</p>'; return; }
        el.innerHTML = '<table style="width:100%;font-size:14px;border-collapse:collapse"><thead><tr style="border-bottom:2px solid var(--border)"><th style="text-align:left;padding:6px">ç”¨æˆ·å</th><th style="text-align:left;padding:6px">è§’è‰²</th><th style="text-align:left;padding:6px">æ¥æº</th><th style="text-align:left;padding:6px">å¯†ç </th><th style="text-align:left;padding:6px">åˆ›å»ºæ—¶é—´</th><th style="text-align:right;padding:6px">æ“ä½œ</th></tr></thead><tbody>' +
          admins.map(a => {
            const isGH = !!a.github_id;
            const ghInfo = isGH ? `<span title="GitHub: ${esc(a.github_login || '')}">${a.avatar_url ? '<img src="'+esc(a.avatar_url)+'" style="width:16px;height:16px;border-radius:50%;vertical-align:middle;margin-right:3px">' : ''}ğŸ™ ${esc(a.github_login || '')}</span>` : '<span style="color:var(--text-light)">æœ¬åœ°</span>';
            return `<tr data-id="${a.id}" data-name="${esc(a.username)}" data-lock="${a.password_locked ? 1 : 0}" style="border-bottom:1px solid var(--border)"><td style="padding:6px">${esc(a.username)}</td><td style="padding:6px"><select class="admin-role-select" data-id="${a.id}" style="padding:2px 4px;border:1px solid var(--border);border-radius:4px;background:var(--bg);color:var(--text);font-size:13px"><option value="super_admin"${a.role==='super_admin'?' selected':''}>è¶…çº§ç®¡ç†å‘˜</option><option value="admin"${a.role==='admin'?' selected':''}>ç®¡ç†å‘˜</option><option value="demo"${a.role==='demo'?' selected':''}>æ¼”ç¤º</option></select></td><td style="padding:6px;font-size:12px">${ghInfo}</td><td style="padding:6px"><span title="${a.password_locked ? 'å¯†ç å·²é”å®š' : 'å¯†ç å¯ä¿®æ”¹'}">${a.password_locked ? 'ğŸ”’' : 'ğŸ”“'}</span> <button class="btn btn-sm btn-toggle-pwd-lock" data-action="toggle-pwd-lock" style="font-size:11px;padding:1px 6px">${a.password_locked ? 'è§£é”' : 'é”å®š'}</button></td><td style="padding:6px;color:var(--text-light);font-size:12px">${a.created_at ? a.created_at.slice(0,10) : '-'}</td><td style="padding:6px;text-align:right"><button class="btn btn-sm btn-danger btn-delete-admin" data-action="delete-admin">åˆ é™¤</button></td></tr>`;
          }).join('') +
          '</tbody></table>';
      } catch {}
    }

    // ç®¡ç†å‘˜åˆ—è¡¨äº‹ä»¶å§”æ‰˜ï¼šclick + change
    document.getElementById('admin-users-list').addEventListener('click', function(e) {
      const tr = e.target.closest('tr[data-id]');
      if (!tr) return;
      const id = Number(tr.dataset.id);
      const name = tr.dataset.name;
      const lock = Number(tr.dataset.lock);
      if (e.target.classList.contains('btn-toggle-pwd-lock')) {
        togglePwdLock(id, lock ? 0 : 1);
      } else if (e.target.classList.contains('btn-delete-admin')) {
        deleteAdmin(id, name);
      }
    });
    document.getElementById('admin-users-list').addEventListener('change', function(e) {
      if (e.target.classList.contains('admin-role-select')) {
        const id = Number(e.target.dataset.id);
        changeRole(id, e.target.value);
      }
    });

    async function createAdmin() {
      const username = document.getElementById('new-admin-user').value.trim();
      const password = document.getElementById('new-admin-pass').value;
      const role = document.getElementById('new-admin-role').value;
      const pwdLock = document.getElementById('new-admin-pwd-lock').checked;
      if (!username || !password) return showMsg('admin-user-msg', 'è¯·å¡«å†™ç”¨æˆ·åå’Œå¯†ç ', 'error');
      try {
        const res = await api('POST', '/api/admin/users', { username, password, role, password_locked: pwdLock ? 1 : 0 });
        const data = await res.json();
        if (!res.ok) throw new Error(data.error);
        showMsg('admin-user-msg', data.message, 'success');
        document.getElementById('new-admin-user').value = '';
        document.getElementById('new-admin-pass').value = '';
        document.getElementById('new-admin-super').checked = false;
        document.getElementById('new-admin-pwd-lock').checked = false;
        loadAdminUsers();
      } catch(e) { showMsg('admin-user-msg', e.message, 'error'); }
    }

    async function deleteAdmin(id, username) {
      if (!confirm(`ç¡®å®šåˆ é™¤ç®¡ç†å‘˜ ${username}ï¼Ÿ`)) return;
      try {
        const res = await api('DELETE', '/api/admin/users', { id });
        const data = await res.json();
        if (!res.ok) throw new Error(data.error);
        loadAdminUsers();
      } catch(e) { alert(e.message); }
    }

    async function changeRole(id, role) {
      try {
        const res = await api('PUT', '/api/admin/users', { id, role });
        const data = await res.json();
        if (!res.ok) throw new Error(data.error);
        loadAdminUsers();
      } catch(e) { alert(e.message); loadAdminUsers(); }
    }

    async function togglePwdLock(id, newValue) {
      try {
        const res = await api('PUT', '/api/admin/users', { id, password_locked: newValue });
        const data = await res.json();
        if (!res.ok) throw new Error(data.error);
        loadAdminUsers();
      } catch(e) { alert(e.message); loadAdminUsers(); }
    }

    // ===== æ‰¹é‡æ“ä½œ =====
    function toggleSelectAll(checked) {
      document.querySelectorAll('.ch-select').forEach(cb => cb.checked = checked);
      updateSelectedCount();
    }
    function updateSelectedCount() {
      const count = document.querySelectorAll('.ch-select:checked').length;
      const el = document.getElementById('selected-count');
      if (el) el.textContent = `å·²é€‰ ${count} ç« `;
    }
    async function batchDelete() {
      const ids = [...document.querySelectorAll('.ch-select:checked')].map(cb => Number(cb.dataset.id));
      if (ids.length === 0) return showMsg('manage-msg', 'è¯·å…ˆå‹¾é€‰è¦åˆ é™¤çš„ç« èŠ‚', 'error');
      if (!confirm(`ç¡®å®šåˆ é™¤é€‰ä¸­çš„ ${ids.length} ä¸ªç« èŠ‚ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ï¼`)) return;
      let deleted = 0, errors = [];
      showMsg('manage-msg', `æ­£åœ¨åˆ é™¤ 0/${ids.length} ...`, '');
      for (const id of ids) {
        try {
          const res = await api('DELETE', `/api/admin/chapters/${id}`);
          if (!res.ok) { const d = await res.json(); errors.push(d.error); }
          else deleted++;
        } catch (e) { errors.push(e.message); }
        showMsg('manage-msg', `æ­£åœ¨åˆ é™¤ ${deleted + errors.length}/${ids.length} ...`, '');
      }
      if (errors.length > 0) {
        showMsg('manage-msg', `åˆ é™¤ ${deleted} ç« ï¼Œ${errors.length} ç« å¤±è´¥`, 'error');
      } else {
        showMsg('manage-msg', `æˆåŠŸåˆ é™¤ ${deleted} ç« `, 'success');
      }
      loadChapters(); refreshAllBooks();
    }

    // ===== æ•°æ®å¤‡ä»½ä¸æ¢å¤ =====
    async function exportBackup() {
      const btn=document.getElementById('backup-btn');
      const bar=document.getElementById('backup-bar');
      const status=document.getElementById('backup-status');
      const progress=document.getElementById('backup-progress');
      btn.disabled=true; btn.textContent='å¯¼å‡ºä¸­...';
      progress.style.display='block';
      try {
        // è·å–æ‰€æœ‰ä¹¦ç±
        const booksRes=await api('GET','/api/books');
        const booksData=await booksRes.json();
        const books=booksData.books||[];
        // è·å–è®¾ç½®
        const settingsRes=await fetch('/api/settings');
        const settingsData=await settingsRes.json();
        const backup={version:1,exportedAt:new Date().toISOString(),settings:settingsData.settings||{},books:[]};
        let done=0;
        for (const book of books) {
          const bookRes=await fetch(`/api/books/${book.id}`);
          const bookData=await bookRes.json();
          const chapters=bookData.chapters||[];
          const fullChapters=[];
          for (const ch of chapters) {
            const chRes=await fetch(`/api/chapters/${ch.id}`);
            const chData=await chRes.json();
            fullChapters.push({title:ch.title,sort_order:ch.sort_order,word_count:ch.word_count,content:chData.content||''});
          }
          backup.books.push({title:book.title,author:book.author||'',description:book.description||'',chapters:fullChapters});
          done++;
          const pct=Math.round(done/books.length*100);
          bar.style.width=pct+'%';
          status.textContent=`${done}/${books.length} æœ¬ä¹¦`;
        }
        const blob=new Blob([JSON.stringify(backup,null,2)],{type:'application/json'});
        const url=URL.createObjectURL(blob);
        const a=document.createElement('a');
        a.href=url;
        a.download=`novel-site-backup-${new Date().toISOString().slice(0,10)}.json`;
        a.click();
        URL.revokeObjectURL(url);
        showMsg('backup-msg',`å¤‡ä»½æˆåŠŸï¼š${books.length} æœ¬ä¹¦`,'success');
      } catch(e) { showMsg('backup-msg','å¤‡ä»½å¤±è´¥ï¼š'+e.message,'error'); }
      btn.disabled=false; btn.textContent='å¯¼å‡ºå¤‡ä»½';
      setTimeout(()=>{progress.style.display='none';},2000);
    }

    // ===== è‡ªå®šä¹‰å­—ä½“ç®¡ç† =====
    async function loadFontList() {
      const el = document.getElementById('font-list');
      try {
        const res = await fetch('/api/fonts');
        const data = await res.json();
        const fonts = data.fonts || [];
        if (fonts.length === 0) {
          el.innerHTML = '<li style="color:var(--text-light)">æš‚æ— è‡ªå®šä¹‰å­—ä½“</li>';
          return;
        }
        el.innerHTML = fonts.map(f => `
          <li data-font="${esc(f)}">
            <span style="font-size:14px">${esc(f)}</span>
            <button class="btn btn-sm btn-danger btn-delete-font">åˆ é™¤</button>
          </li>
        `).join('');
      } catch {
        el.innerHTML = '<li style="color:var(--text-light)">åŠ è½½å¤±è´¥</li>';
      }
    }
    // å­—ä½“åˆ—è¡¨äº‹ä»¶å§”æ‰˜
    document.getElementById('font-list').addEventListener('click', function(e) {
      if (e.target.classList.contains('btn-delete-font')) {
        const li = e.target.closest('li[data-font]');
        if (li) deleteFont(li.dataset.font);
      }
    });
    async function uploadFont() {
      const fileInput = document.getElementById('font-file');
      const file = fileInput.files[0];
      if (!file) return showMsg('font-msg', 'è¯·é€‰æ‹©å­—ä½“æ–‡ä»¶', 'error');
      if (!/\.woff2$/i.test(file.name)) return showMsg('font-msg', 'åªæ”¯æŒ .woff2 æ ¼å¼', 'error');
      if (file.size > 10 * 1024 * 1024) return showMsg('font-msg', 'æ–‡ä»¶ä¸èƒ½è¶…è¿‡10MB', 'error');
      showMsg('font-msg', 'ä¸Šä¼ ä¸­...', '');
      try {
        const formData = new FormData();
        formData.append('file', file);
        const res = await fetch('/api/admin/fonts', {
          method: 'POST',
          headers: { 'Authorization': `Bearer ${getToken()}` },
          body: formData
        });
        const data = await res.json();
        if (!res.ok) throw new Error(data.error);
        showMsg('font-msg', 'ä¸Šä¼ æˆåŠŸ', 'success');
        fileInput.value = '';
        loadFontList();
      } catch (e) {
        showMsg('font-msg', e.message, 'error');
      }
    }
    async function deleteFont(filename) {
      if (!confirm(`ç¡®å®šåˆ é™¤å­—ä½“ã€Œ${filename}ã€ï¼Ÿ`)) return;
      try {
        const res = await api('DELETE', '/api/admin/fonts', { filename });
        const data = await res.json();
        if (!res.ok) throw new Error(data.error);
        loadFontList();
      } catch (e) {
        alert('åˆ é™¤å¤±è´¥ï¼š' + e.message);
      }
    }

    document.getElementById('restore-file').addEventListener('change',async(e)=>{
      const file=e.target.files[0];
      if (!file) return;
      if (!confirm('æ¢å¤å¤‡ä»½ä¼šæ·»åŠ æ•°æ®ï¼ˆä¸ä¼šåˆ é™¤ç°æœ‰æ•°æ®ï¼‰ã€‚ç¡®å®šç»§ç»­ï¼Ÿ')) { e.target.value=''; return; }
      const bar=document.getElementById('backup-bar');
      const status=document.getElementById('backup-status');
      const progress=document.getElementById('backup-progress');
      progress.style.display='block';
      try {
        const text=await file.text();
        const backup=JSON.parse(text);
        if (!backup.version || !backup.books) throw new Error('æ— æ•ˆçš„å¤‡ä»½æ–‡ä»¶');
        const books=backup.books;
        let done=0,errors=[];
        for (const book of books) {
          try {
            // åˆ›å»ºä¹¦ç±
            const res=await api('POST','/api/admin/books',{title:book.title,author:book.author,description:book.description});
            const d=await res.json();
            if (!res.ok) throw new Error(d.error);
            const bookId=d.book.id;
            // å¯¼å…¥ç« èŠ‚
            for (const ch of (book.chapters||[])) {
              await api('POST','/api/admin/chapters',{book_id:bookId,title:ch.title,content:ch.content});
            }
          } catch(err) { errors.push(book.title+': '+err.message); }
          done++;
          const pct=Math.round(done/books.length*100);
          bar.style.width=pct+'%';
          status.textContent=`${done}/${books.length} æœ¬ä¹¦`;
        }
        if (errors.length>0) {
          showMsg('backup-msg',`æ¢å¤å®Œæˆï¼Œ${errors.length} æœ¬å¤±è´¥ï¼š${errors.slice(0,3).join('ï¼›')}`,'error');
        } else { showMsg('backup-msg',`æˆåŠŸæ¢å¤ ${books.length} æœ¬ä¹¦`,'success'); }
        refreshAllBooks();
      } catch(err) { showMsg('backup-msg','æ¢å¤å¤±è´¥ï¼š'+err.message,'error'); }
      e.target.value='';
      setTimeout(()=>{progress.style.display='none';},2000);
    });

    // ===== EPUBå¯¼å…¥ =====
    let epubChapters = [];

    // å¯¼å…¥æ–¹å¼åˆ‡æ¢
    document.querySelectorAll('input[name="epub-import-mode"]').forEach(radio => {
      radio.addEventListener('change', function() {
        document.getElementById('epub-existing-book').style.display = this.value === 'existing' ? '' : 'none';
        if (this.value === 'existing') refreshEpubBookSelect();
      });
    });

    async function refreshEpubBookSelect() {
      try {
        const res = await api('GET', '/api/books');
        const data = await res.json();
        const sel = document.getElementById('epub-book-select');
        const allBooks = data.books || [];
        const myBooks = currentRole === 'demo' ? allBooks.filter(b => b.created_by === currentUserId) : allBooks;
        if (myBooks.length === 0) {
          sel.innerHTML = '<option value="">è¯·å…ˆåˆ›å»ºä¸€æœ¬ä¹¦</option>';
        } else {
          sel.innerHTML = myBooks.map(b => `<option value="${b.id}">${esc(b.title)}</option>`).join('');
        }
      } catch {}
    }

    document.getElementById('epub-file').addEventListener('change', async function() {
      const file = this.files[0];
      if (!file) return;
      if (file.size > 50 * 1024 * 1024) return showMsg('epub-msg', 'æ–‡ä»¶è¶…è¿‡ 50MB é™åˆ¶', 'error');
      if (!file.name.toLowerCase().endsWith('.epub')) return showMsg('epub-msg', 'è¯·é€‰æ‹© .epub æ–‡ä»¶', 'error');

      document.getElementById('epub-preview').style.display = 'none';
      document.getElementById('epub-parsing-msg').style.display = '';
      showMsg('epub-msg', '', '');

      try {
        if (typeof JSZip === 'undefined') throw new Error('JSZip åº“åŠ è½½å¤±è´¥ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•');
        const arrayBuffer = await file.arrayBuffer();
        const zip = await JSZip.loadAsync(arrayBuffer);

        // 1. è¯»å– container.xml æ‰¾åˆ° OPF è·¯å¾„
        const containerXml = await zip.file('META-INF/container.xml')?.async('text');
        if (!containerXml) throw new Error('æ— æ•ˆçš„ EPUB æ–‡ä»¶ï¼šç¼ºå°‘ META-INF/container.xml');

        // ğŸŸ¢-3: DRM åŠ å¯†æ£€æµ‹
        const encryptionXml = await zip.file('META-INF/encryption.xml')?.async('text');
        if (encryptionXml) {
          const encDoc = new DOMParser().parseFromString(encryptionXml, 'application/xml');
          if (encDoc.querySelectorAll('EncryptedData').length > 0) {
            throw new Error('æ­¤ EPUB æ–‡ä»¶åŒ…å« DRM åŠ å¯†ï¼Œæ— æ³•å¯¼å…¥ã€‚è¯·ä½¿ç”¨æœªåŠ å¯†çš„ EPUB æ–‡ä»¶ã€‚');
          }
        }

        const containerDoc = new DOMParser().parseFromString(containerXml, 'application/xml');
        const rootfileEl = containerDoc.querySelector('rootfile[full-path]');
        if (!rootfileEl) throw new Error('æ— æ•ˆçš„ EPUB æ–‡ä»¶ï¼šæ‰¾ä¸åˆ° OPF è·¯å¾„');
        const opfPath = rootfileEl.getAttribute('full-path');
        const opfDir = opfPath.includes('/') ? opfPath.substring(0, opfPath.lastIndexOf('/') + 1) : '';

        // 2. è§£æ OPF æ–‡ä»¶
        const opfXml = await zip.file(opfPath)?.async('text');
        if (!opfXml) throw new Error('æ— æ•ˆçš„ EPUB æ–‡ä»¶ï¼šæ‰¾ä¸åˆ° OPF æ–‡ä»¶ ' + opfPath);
        const opfDoc = new DOMParser().parseFromString(opfXml, 'application/xml');

        // æå– metadataï¼ˆğŸŸ¡-5 ä¿®å¤ï¼šä¼˜å…ˆç”¨ getElementsByTagNameNSï¼Œé¿å… CSS é€‰æ‹©å™¨å‘½åç©ºé—´é—®é¢˜ï¼‰
        const getMeta = (localName) => {
          const el = opfDoc.getElementsByTagNameNS('http://purl.org/dc/elements/1.1/', localName)[0]
            || opfDoc.querySelector('metadata ' + localName);
          return el ? el.textContent.trim() : '';
        };
        const bookTitle = getMeta('title') || file.name.replace(/\.epub$/i, '');
        const bookAuthor = getMeta('creator') || '';
        const bookDesc = getMeta('description') || '';

        // æ„å»º manifest æ˜ å°„: id -> href
        const manifest = {};
        opfDoc.querySelectorAll('manifest item').forEach(item => {
          manifest[item.getAttribute('id')] = {
            href: item.getAttribute('href'),
            mediaType: item.getAttribute('media-type') || ''
          };
        });

        // è·å– spine é¡ºåº
        const spineRefs = [];
        opfDoc.querySelectorAll('spine itemref').forEach(ref => {
          spineRefs.push(ref.getAttribute('idref'));
        });

        if (spineRefs.length === 0) throw new Error('EPUB æ–‡ä»¶ä¸­æ²¡æœ‰æ‰¾åˆ°ç« èŠ‚ï¼ˆspine ä¸ºç©ºï¼‰');

        // 3. æŒ‰ spine é¡ºåºè¯»å–ç« èŠ‚
        const chapters = [];
        let totalExtracted = 0;
        const MAX_EXTRACTED = 50 * 1024 * 1024; // 50MBï¼ˆå­—èŠ‚æ•°ï¼Œéå­—ç¬¦æ•°ï¼‰
        for (const idref of spineRefs) {
          const item = manifest[idref];
          if (!item) continue;
          // åªå¤„ç† XHTML/HTML ç±»å‹
          if (!item.mediaType.includes('html') && !item.mediaType.includes('xml')) continue;

          // ğŸ”´-2 ä¿®å¤ï¼šå°è¯•åŸå§‹è·¯å¾„ã€è§£ç è·¯å¾„ã€ç¼–ç è·¯å¾„ï¼ˆå…¼å®¹ä¸­æ–‡æ–‡ä»¶åEPUBï¼‰
          // ğŸŸ¡-6 ä¿®å¤ï¼šè§„èŒƒåŒ–è·¯å¾„ï¼Œç§»é™¤ ../ é˜²æ­¢è·¯å¾„éå†
          const normalizePath = (p) => p.split('/').reduce((acc, part) => {
            if (part === '..') acc.pop(); else if (part !== '.' && part !== '') acc.push(part); return acc;
          }, []).join('/');
          const rawPath = normalizePath(opfDir + item.href);
          let zipEntry = zip.file(rawPath);
          if (!zipEntry) { try { zipEntry = zip.file(decodeURIComponent(rawPath)); } catch {} }
          if (!zipEntry) { try { zipEntry = zip.file(opfDir + encodeURI(item.href)); } catch {} }
          const content = await zipEntry?.async('text');
          if (!content) continue;

          // ğŸ”´-4 ä¿®å¤ï¼šzip bomb é˜²æŠ¤ç”¨å­—èŠ‚æ•°è€Œéå­—ç¬¦æ•°
          totalExtracted += new TextEncoder().encode(content).byteLength;
          if (totalExtracted > MAX_EXTRACTED) throw new Error('EPUB è§£å‹åå†…å®¹è¿‡å¤§ï¼ˆè¶…è¿‡50MBï¼‰ï¼Œå¯èƒ½æ˜¯å¼‚å¸¸æ–‡ä»¶');

          // ğŸŸ¡-1 ä¿®å¤ï¼šç›´æ¥ç”¨ text/html è§£æï¼ˆæ›´å®½å®¹ï¼Œçº¯æ–‡æœ¬æå–ä¸éœ€è¦XHTMLä¸¥æ ¼æ€§ï¼‰
          const docToUse = new DOMParser().parseFromString(content, 'text/html');

          // æå–ç« èŠ‚æ ‡é¢˜ï¼šä¼˜å…ˆ h1 > h2 > h3 > title > æ–‡ä»¶å
          let title = '';
          const h1 = docToUse.querySelector('h1');
          const h2 = docToUse.querySelector('h2');
          const h3 = docToUse.querySelector('h3');
          const titleEl = docToUse.querySelector('title');
          if (h1 && h1.textContent.trim()) title = h1.textContent.trim();
          else if (h2 && h2.textContent.trim()) title = h2.textContent.trim();
          else if (h3 && h3.textContent.trim()) title = h3.textContent.trim();
          else if (titleEl && titleEl.textContent.trim()) title = titleEl.textContent.trim();
          else {
            // ç”¨æ–‡ä»¶å
            const fname = item.href.split('/').pop().replace(/\.\w+$/, '');
            title = decodeURIComponent(fname);
          }
          title = title.substring(0, 200);

          // æå–çº¯æ–‡æœ¬å†…å®¹ï¼Œä¿ç•™æ®µè½æ¢è¡Œ
          const body = docToUse.body || docToUse.documentElement;
          let textContent = '';
          const blocks = body.querySelectorAll('p, div, h1, h2, h3, h4, h5, h6, li, blockquote, pre, br');
          if (blocks.length > 0) {
            const parts = [];
            const walker = docToUse.createTreeWalker(body, NodeFilter.SHOW_ELEMENT | NodeFilter.SHOW_TEXT, null);
            let node;
            const blockTags = new Set(['P','DIV','H1','H2','H3','H4','H5','H6','LI','BLOCKQUOTE','PRE','BR','TR','DT','DD','SECTION','ARTICLE','ASIDE','HEADER','FOOTER','NAV','FIGURE','FIGCAPTION']);
            let lastWasBlock = false;
            while (node = walker.nextNode()) {
              if (node.nodeType === Node.TEXT_NODE) {
                const t = node.textContent;
                if (t.trim()) {
                  parts.push(t);
                  lastWasBlock = false;
                }
              } else if (node.nodeType === Node.ELEMENT_NODE) {
                // ğŸŸ¢-2: BR ç‰¹æ®Šå¤„ç†ï¼Œå§‹ç»ˆæ’å…¥æ¢è¡Œï¼ˆå…è®¸è¿ç»­ BR äº§ç”Ÿç©ºè¡Œï¼‰
                if (node.tagName === 'BR') {
                  parts.push('\n');
                } else if (blockTags.has(node.tagName)) {
                  if (!lastWasBlock && parts.length > 0) {
                    parts.push('\n');
                    lastWasBlock = true;
                  }
                }
              }
            }
            textContent = parts.join('').replace(/\n{3,}/g, '\n\n').trim();
          } else {
            // å›é€€ï¼šç›´æ¥å– textContent
            textContent = (body.textContent || '').replace(/[ \t]+/g, ' ').replace(/\n\s*\n/g, '\n\n').trim();
          }

          // è¿‡æ»¤ç©ºç« èŠ‚
          if (!textContent.replace(/\s/g, '')) continue;

          // å¤§ç« èŠ‚äºŒæ¬¡åˆ†å‰²ï¼šå•ä¸ªXHTMLå†…å®¹è¿‡é•¿æ—¶ï¼Œå°è¯•ç”¨ç« èŠ‚æ­£åˆ™æ‹†åˆ†
          // ğŸŸ¡-2 ä¿®å¤ï¼šè¦æ±‚è‡³å°‘åˆ†å‡º3ä¸ªå­ç« èŠ‚æ‰é‡‡ç”¨ï¼Œé¿å…è¯¯åŒ¹é…å¯¼è‡´æ ‡é¢˜é”™ä¹±
          if (textContent.length > 20000) {
            const subChapters = splitChapters(textContent);
            if (subChapters && subChapters.length >= 3) {
              for (const sc of subChapters) {
                if (sc.content && sc.content.trim()) {
                  chapters.push({ title: sc.title, content: sc.content, checked: true });
                  if (chapters.length > 5000) throw new Error('ç« èŠ‚æ•°é‡è¿‡å¤šï¼ˆè¶…è¿‡5000ç« ï¼‰ï¼Œè¯·åˆ†æ‰¹å¯¼å…¥');
                }
              }
              continue;
            }
          }

          chapters.push({ title, content: textContent, checked: true });
          if (chapters.length > 5000) throw new Error('ç« èŠ‚æ•°é‡è¿‡å¤šï¼ˆè¶…è¿‡5000ç« ï¼‰ï¼Œè¯·åˆ†æ‰¹å¯¼å…¥');
        }

        if (chapters.length === 0) throw new Error('EPUB ä¸­æ²¡æœ‰æ‰¾åˆ°æœ‰æ•ˆç« èŠ‚å†…å®¹');

        epubChapters = chapters;

        // å¡«å……é¢„è§ˆ
        document.getElementById('epub-book-title').value = bookTitle;
        document.getElementById('epub-book-author').value = bookAuthor;
        document.getElementById('epub-book-desc').value = bookDesc;
        renderEpubPreview();
        document.getElementById('epub-parsing-msg').style.display = 'none';
        document.getElementById('epub-preview').style.display = '';

      } catch (e) {
        document.getElementById('epub-parsing-msg').style.display = 'none';
        showMsg('epub-msg', 'è§£æå¤±è´¥ï¼š' + e.message, 'error');
      }
    });

    function renderEpubPreview() {
      const el = document.getElementById('epub-chapters');
      const checked = epubChapters.filter(c => c.checked);
      const totalWords = checked.reduce((s, c) => s + c.content.length, 0);
      document.getElementById('epub-total').textContent = checked.length;
      document.getElementById('epub-words').textContent = totalWords.toLocaleString();
      el.innerHTML = epubChapters.map((c, i) => `
        <div style="padding:8px 0;border-bottom:1px solid var(--border)">
          <div style="display:flex;align-items:center;gap:8px">
            <input type="checkbox" ${c.checked ? 'checked' : ''} data-idx="${i}" class="epub-check">
            <input type="text" value="${esc(c.title)}" data-idx="${i}" class="epub-title-edit" style="flex:1;padding:4px 8px;border:1px solid var(--border);border-radius:4px;font-size:14px;background:var(--bg);color:var(--text)">
            <span style="font-size:12px;color:var(--text-light);white-space:nowrap">${c.content.length} å­—</span>
          </div>
          <div style="font-size:12px;color:var(--text-light);margin-top:4px;padding-left:28px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">${esc(c.content.slice(0, 120))}</div>
        </div>
      `).join('');
    }

    // äº‹ä»¶å§”æ‰˜ï¼šç« èŠ‚å‹¾é€‰å’Œæ ‡é¢˜ç¼–è¾‘
    document.getElementById('epub-chapters').addEventListener('change', function(e) {
      if (e.target.classList.contains('epub-check')) {
        epubChapters[e.target.dataset.idx].checked = e.target.checked;
        // æ›´æ–°ç»Ÿè®¡
        const checked = epubChapters.filter(c => c.checked);
        document.getElementById('epub-total').textContent = checked.length;
        document.getElementById('epub-words').textContent = checked.reduce((s, c) => s + c.content.length, 0).toLocaleString();
      }
    });
    document.getElementById('epub-chapters').addEventListener('input', function(e) {
      if (e.target.classList.contains('epub-title-edit')) {
        epubChapters[e.target.dataset.idx].title = e.target.value;
      }
    });

    function cancelEpubImport() {
      epubChapters = [];
      document.getElementById('epub-preview').style.display = 'none';
      document.getElementById('epub-file').value = '';
      document.getElementById('epub-progress').style.display = 'none';
      document.getElementById('epub-parsing-msg').style.display = 'none';
      showMsg('epub-msg', '', '');
    }

    // ===== æ ‡ç­¾ç³»ç»Ÿï¼ˆèåˆåˆ°ä¹¦ç±åˆ›å»º/ç¼–è¾‘æµç¨‹ï¼‰ =====
    let _allTags = [];
    let _createBookTags = []; // åˆ›å»ºä¹¦ç±æ—¶é€‰ä¸­çš„æ ‡ç­¾ID

    async function loadTagList() {
      try {
        const res = await api('GET', '/api/admin/tags');
        const data = await res.json();
        _allTags = data.tags || [];
      } catch { _allTags = []; }
    }

    // é€šç”¨æ ‡ç­¾é€‰æ‹©å™¨æ¸²æŸ“ï¼ˆç”¨äºåˆ›å»ºå’Œç¼–è¾‘ä¹¦ç±ï¼‰
    function renderTagSelector(containerId, selectedIds, onToggle) {
      const container = document.getElementById(containerId);
      if (!container) return;
      if (_allTags.length === 0) {
        container.innerHTML = '';
        // éšè—çˆ¶çº§ form-group
        const parent = container.closest('.form-group');
        if (parent) parent.style.display = 'none';
        return;
      }
      const parent = container.closest('.form-group');
      if (parent) parent.style.display = '';
      container.innerHTML = _allTags.map(t => {
        const checked = selectedIds.includes(t.id);
        return `<label data-tag-id="${t.id}" style="display:inline-flex;align-items:center;gap:4px;cursor:pointer;padding:4px 10px;border:1px solid ${checked ? t.color : 'var(--border)'};border-radius:12px;font-size:13px;background:${checked ? t.color + '22' : 'transparent'};color:${checked ? t.color : 'var(--text-light)'};transition:all .15s;user-select:none">
          ${esc(t.name)}${currentRole !== 'demo' ? `<span class="tag-delete-x" data-tag-id="${t.id}" style="margin-left:2px;font-size:11px;opacity:0.5;cursor:pointer" title="åˆ é™¤æ ‡ç­¾">âœ•</span>` : ''}
        </label>`;
      }).join('');
      // ç‚¹å‡»åˆ‡æ¢é€‰ä¸­
      container.querySelectorAll('label[data-tag-id]').forEach(label => {
        label.addEventListener('click', (e) => {
          if (e.target.classList.contains('tag-delete-x')) return; // åˆ é™¤æŒ‰é’®å•ç‹¬å¤„ç†
          const tagId = Number(label.dataset.tagId);
          onToggle(tagId);
        });
      });
      // åˆ é™¤æ ‡ç­¾ï¼ˆadminä»¥ä¸Šï¼‰
      container.querySelectorAll('.tag-delete-x').forEach(x => {
        x.addEventListener('click', async (e) => {
          e.stopPropagation();
          const tagId = Number(x.dataset.tagId);
          const tag = _allTags.find(t => t.id === tagId);
          if (!tag) return;
          if (!confirm(`åˆ é™¤æ ‡ç­¾ã€Œ${tag.name}ã€ï¼Ÿæ‰€æœ‰ä¹¦ç±ä¸Šçš„æ­¤æ ‡ç­¾ä¹Ÿä¼šç§»é™¤ã€‚`)) return;
          try {
            const res = await api('DELETE', '/api/admin/tags', { id: tagId });
            const data = await res.json();
            if (!res.ok) throw new Error(data.error);
            await loadTagList();
            // ä»é€‰ä¸­åˆ—è¡¨ä¸­ç§»é™¤
            _createBookTags = _createBookTags.filter(id => id !== tagId);
            _editBookTags = _editBookTags.filter(id => id !== tagId);
            renderCreateBookTags();
            renderEditBookTags();
          } catch (e) { alert('åˆ é™¤å¤±è´¥ï¼š' + e.message); }
        });
      });
    }

    // åˆ›å»ºä¹¦ç±çš„æ ‡ç­¾é€‰æ‹©
    function renderCreateBookTags() {
      renderTagSelector('create-book-tags', _createBookTags, (tagId) => {
        if (_createBookTags.includes(tagId)) _createBookTags = _createBookTags.filter(id => id !== tagId);
        else _createBookTags.push(tagId);
        renderCreateBookTags();
      });
    }

    // ===== ä¹¦ç±ç¼–è¾‘å¼¹çª— =====
    const bookEditOverlay = document.getElementById('book-edit-overlay');
    let _editBookId = null;
    let _editBookTags = [];

    document.getElementById('close-book-edit').addEventListener('click', () => bookEditOverlay.classList.remove('active'));
    bookEditOverlay.addEventListener('click', (e) => { if (e.target === bookEditOverlay) bookEditOverlay.classList.remove('active'); });

    async function openBookEditOverlay(book) {
      _editBookId = book.id;
      document.getElementById('edit-book-id').value = book.id;
      document.getElementById('edit-book-title').value = book.title || '';
      document.getElementById('edit-book-author').value = book.author || '';
      document.getElementById('edit-book-desc').value = book.description || '';

      // å°é¢é¢„è§ˆ
      const preview = document.getElementById('edit-cover-preview');
      const removeBtn = document.getElementById('remove-cover-btn');
      if (book.cover_key) {
        preview.innerHTML = `<img src="/api/covers/${book.id}" style="width:100%;height:100%;object-fit:cover">`;
        removeBtn.style.display = '';
      } else {
        preview.innerHTML = '<span style="color:var(--text-light);font-size:12px">æ— å°é¢</span>';
        removeBtn.style.display = 'none';
      }
      document.getElementById('edit-cover-file').value = '';

      // åŠ è½½æ ‡ç­¾
      if (_allTags.length === 0) await loadTagList();
      // è·å–å½“å‰ä¹¦ç±æ ‡ç­¾
      try {
        const res = await fetch(`/api/books/${book.id}`);
        const data = await res.json();
        _editBookTags = (data.book.tags || []).map(t => t.id);
      } catch { _editBookTags = []; }
      renderEditBookTags();

      bookEditOverlay.classList.add('active');
    }

    function renderEditBookTags() {
      renderTagSelector('edit-book-tags', _editBookTags, (tagId) => {
        if (_editBookTags.includes(tagId)) _editBookTags = _editBookTags.filter(id => id !== tagId);
        else _editBookTags.push(tagId);
        renderEditBookTags();
      });
      // demoç”¨æˆ·éšè—å†…è”åˆ›å»ºæ ‡ç­¾
      const actions = document.getElementById('edit-tag-actions');
      if (actions) actions.style.display = currentRole === 'demo' ? 'none' : '';
    }

    // å†…è”åˆ›å»ºæ ‡ç­¾ï¼ˆç¼–è¾‘å¼¹çª—å†…ï¼‰
    document.getElementById('inline-create-tag-btn').addEventListener('click', async () => {
      const nameInput = document.getElementById('inline-tag-name');
      const colorInput = document.getElementById('inline-tag-color');
      const name = nameInput.value.trim();
      const color = colorInput.value;
      if (!name) return;
      try {
        const res = await api('POST', '/api/admin/tags', { name, color });
        const data = await res.json();
        if (!res.ok) throw new Error(data.error);
        nameInput.value = '';
        await loadTagList();
        // è‡ªåŠ¨é€‰ä¸­æ–°åˆ›å»ºçš„æ ‡ç­¾
        if (data.tag && data.tag.id) {
          _editBookTags.push(data.tag.id);
        }
        renderEditBookTags();
        renderCreateBookTags();
      } catch (e) { alert('åˆ›å»ºå¤±è´¥ï¼š' + e.message); }
    });

    // å°é¢ä¸Šä¼ å‹ç¼©
    async function compressCoverImage(file) {
      return new Promise((resolve) => {
        const img = new Image();
        img.onload = () => {
          const canvas = document.createElement('canvas');
          const maxW = 400;
          let w = img.width, h = img.height;
          if (w > maxW) { h = Math.round(h * maxW / w); w = maxW; }
          canvas.width = w; canvas.height = h;
          canvas.getContext('2d').drawImage(img, 0, 0, w, h);
          canvas.toBlob(resolve, 'image/jpeg', 0.8);
        };
        img.src = URL.createObjectURL(file);
      });
    }

    document.getElementById('remove-cover-btn').addEventListener('click', async () => {
      if (!_editBookId) return;
      try {
        await api('DELETE', `/api/admin/covers?book_id=${_editBookId}`);
        document.getElementById('edit-cover-preview').innerHTML = '<span style="color:var(--text-light);font-size:12px">æ— å°é¢</span>';
        document.getElementById('remove-cover-btn').style.display = 'none';
      } catch (e) { alert('åˆ é™¤å°é¢å¤±è´¥ï¼š' + e.message); }
    });

    document.getElementById('edit-cover-file').addEventListener('change', async function() {
      const file = this.files[0];
      if (!file) return;
      const preview = document.getElementById('edit-cover-preview');
      const url = URL.createObjectURL(file);
      preview.innerHTML = `<img src="${url}" style="width:100%;height:100%;object-fit:cover">`;
    });

    document.getElementById('save-book-edit-btn').addEventListener('click', async () => {
      if (!_editBookId) return;
      const title = document.getElementById('edit-book-title').value.trim();
      const author = document.getElementById('edit-book-author').value.trim();
      const description = document.getElementById('edit-book-desc').value.trim();
      if (!title) return alert('ä¹¦åä¸èƒ½ä¸ºç©º');

      try {
        // ä¿å­˜åŸºæœ¬ä¿¡æ¯
        const res = await api('PUT', `/api/admin/books/${_editBookId}`, { title, author, description });
        const data = await res.json();
        if (!res.ok) throw new Error(data.error);

        // ä¸Šä¼ å°é¢
        const coverFile = document.getElementById('edit-cover-file').files[0];
        if (coverFile) {
          const compressed = await compressCoverImage(coverFile);
          const formData = new FormData();
          formData.append('file', compressed, 'cover.jpg');
          await fetch(`/api/admin/covers?book_id=${_editBookId}`, {
            method: 'POST',
            headers: { 'Authorization': `Bearer ${getToken()}` },
            body: formData
          });
        }

        // ä¿å­˜æ ‡ç­¾
        await api('PUT', '/api/admin/book-tags', { book_id: _editBookId, tag_ids: _editBookTags });

        bookEditOverlay.classList.remove('active');
        refreshAllBooks();
      } catch (e) { alert('ä¿å­˜å¤±è´¥ï¼š' + e.message); }
    });

    // åœ¨ showAdminPanel ä¸­ä¹ŸåŠ è½½æ ‡ç­¾å¹¶æ¸²æŸ“åˆ›å»ºä¹¦ç±çš„æ ‡ç­¾é€‰æ‹©å™¨
    const _origShowAdminPanel = showAdminPanel;
    showAdminPanel = async function(username, role) {
      _origShowAdminPanel(username, role);
      await loadTagList();
      _createBookTags = [];
      renderCreateBookTags();
    };

    async function startEpubImport() {
      const chapters = epubChapters.filter(c => c.checked);
      if (chapters.length === 0) return showMsg('epub-msg', 'æ²¡æœ‰é€‰ä¸­ä»»ä½•ç« èŠ‚', 'error');

      const mode = document.querySelector('input[name="epub-import-mode"]:checked').value;
      let bookId;

      if (mode === 'new') {
        const title = document.getElementById('epub-book-title').value.trim();
        if (!title) return showMsg('epub-msg', 'è¯·è¾“å…¥ä¹¦å', 'error');
        const author = document.getElementById('epub-book-author').value.trim();
        const description = document.getElementById('epub-book-desc').value.trim();
        try {
          const res = await api('POST', '/api/admin/books', { title, author, description });
          const data = await res.json();
          if (!res.ok) throw new Error(data.error);
          bookId = data.book.id;
        } catch (e) {
          return showMsg('epub-msg', 'åˆ›å»ºä¹¦ç±å¤±è´¥ï¼š' + e.message, 'error');
        }
      } else {
        bookId = document.getElementById('epub-book-select').value;
        if (!bookId) return showMsg('epub-msg', 'è¯·é€‰æ‹©ç›®æ ‡ä¹¦ç±', 'error');
        bookId = Number(bookId);
      }

      // è·å–å·²æœ‰ç« èŠ‚çš„æœ€å¤§sort_orderä½œä¸ºåŸºå‡†ï¼ˆå¯¼å…¥åˆ°å·²æœ‰ä¹¦ç±æ—¶ï¼‰
      let baseOrder = 0;
      if (mode === 'existing') {
        try {
          const bRes = await fetch(`/api/books/${bookId}`);
          const bData = await bRes.json();
          const chs = bData.chapters || [];
          if (chs.length > 0) baseOrder = Math.max(...chs.map(c => c.sort_order || 0));
        } catch {}
      }

      // å¼€å§‹å¯¼å…¥ç« èŠ‚
      const bar = document.getElementById('epub-bar');
      const status = document.getElementById('epub-status');
      document.getElementById('epub-progress').style.display = '';
      bar.style.width = '0%';
      let uploaded = 0, errors = [];

      const tasks = chapters.map((ch, idx) => async () => {
        let lastErr;
        for (let retry = 0; retry < 3; retry++) {
          try {
            const res = await api('POST', '/api/admin/chapters', { book_id: Number(bookId), title: ch.title, content: ch.content, sort_order: baseOrder + idx + 1 });
            if (res.ok) return;
            const d = await res.json();
            if (res.status >= 400 && res.status < 500) { errors.push(ch.title + ': ' + d.error); return; }
            lastErr = d.error;
          } catch (e) { lastErr = e.message; }
          if (retry < 2) await new Promise(r => setTimeout(r, 1000 * (retry + 1)));
        }
        errors.push(ch.title + ': ' + lastErr);
      });
      const tracked = tasks.map(fn => async () => { try { await fn(); } finally { uploaded++; const pct = Math.round(uploaded / chapters.length * 100); bar.style.width = pct + '%'; status.textContent = `${uploaded}/${chapters.length} ç« ï¼ˆ${pct}%ï¼‰`; } });
      await concurrentUpload(tracked, 3);

      if (errors.length > 0) {
        // å¦‚æœæ˜¯æ–°å»ºä¹¦ä¸”å…¨éƒ¨ç« èŠ‚éƒ½å¤±è´¥ï¼Œè‡ªåŠ¨åˆ é™¤ç©ºä¹¦
        if (mode === 'new' && errors.length === chapters.length) {
          try { await api('DELETE', '/api/admin/books/' + bookId); } catch {}
          showMsg('epub-msg', `å¯¼å…¥å…¨éƒ¨å¤±è´¥ï¼Œå·²è‡ªåŠ¨åˆ é™¤ç©ºä¹¦ã€‚å¤±è´¥åŸå› ï¼š\n${errors.join('\n')}`, 'error');
        } else {
          showMsg('epub-msg', `å¯¼å…¥å®Œæˆï¼Œ${errors.length} ç« å¤±è´¥ï¼š\n${errors.join('\n')}`, 'error');
        }
      } else {
        showMsg('epub-msg', `æˆåŠŸå¯¼å…¥ ${uploaded} ç« `, 'success');
      }
      cancelEpubImport();
      refreshAllBooks();
    }
  </script>
</body>
</html>
