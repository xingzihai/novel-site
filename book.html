<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ä½œå“è¯¦æƒ…</title>
  <meta name="description" content="">
  <link rel="stylesheet" href="/style.css">
  <link rel="manifest" href="/manifest.json">
  <meta name="theme-color" content="#d4a574">
</head>
<body>
  <div class="navbar">
    <h1><a href="/">ğŸ“š æˆ‘çš„ä¹¦æ¶</a></h1>
    <nav>
      <a href="https://github.com/xingzihai/novel-site" target="_blank" rel="noopener" title="GitHub">GitHub</a>
      <a href="/admin.html">ç®¡ç†</a>
      <button class="theme-toggle" onclick="toggleTheme()" title="åˆ‡æ¢ä¸»é¢˜">ğŸŒ™</button>
    </nav>
  </div>
  <div class="container">
    <div class="breadcrumb"><a href="/">ä¹¦æ¶</a><span>â€º</span><span id="bc-title">åŠ è½½ä¸­...</span></div>
    <div id="content" class="loading">åŠ è½½ä¸­...</div>
  </div>
  <script>
    const THEMES = ['light','dark','green','sepia','blue'];
    const THEME_ICONS = {'light':'ğŸŒ™','dark':'â˜€ï¸','green':'ğŸƒ','sepia':'ğŸ“œ','blue':'ğŸ’§'};
    const savedTheme = localStorage.getItem('theme') || 'light';
    document.documentElement.setAttribute('data-theme', savedTheme);
    updateThemeBtn();
    function toggleTheme() {
      const current = document.documentElement.getAttribute('data-theme');
      const idx = THEMES.indexOf(current);
      const next = THEMES[(idx + 1) % THEMES.length];
      document.documentElement.setAttribute('data-theme', next);
      localStorage.setItem('theme', next);
      updateThemeBtn();
    }
    function updateThemeBtn() {
      const btn = document.querySelector('.theme-toggle');
      const t = document.documentElement.getAttribute('data-theme');
      btn.textContent = THEME_ICONS[t] || 'ğŸŒ™';
    }

    const bookId = new URLSearchParams(location.search).get('id');
    let allChapters = [];
    if (!bookId || !/^\d+$/.test(bookId)) {
      document.getElementById('content').innerHTML = '<div class="msg msg-error">æ— æ•ˆçš„ä¹¦ç±ID</div>';
    } else {
      loadBook();
    }

    // åŠ è½½ç«™ç‚¹è®¾ç½®
    fetch('/api/settings').then(r => r.json()).then(d => {
      const s = d.settings || {};
      if (s.site_name) document.querySelector('.navbar h1 a').textContent = 'ğŸ“š ' + s.site_name;
    }).catch(() => {});

    // PWA Service Worker
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('/sw.js').catch(() => {});
    }

    async function loadBook() {
      const el = document.getElementById('content');
      try {
        const res = await fetch(`/api/books/${bookId}`);
        if (!res.ok) throw new Error(res.status === 404 ? 'ä¹¦ç±ä¸å­˜åœ¨' : 'åŠ è½½å¤±è´¥');
        const data = await res.json();
        const b = data.book;
        const chapters = data.chapters || [];
        allChapters = chapters;

        document.title = esc(b.title) + ' - æˆ‘çš„ä¹¦æ¶';
        document.querySelector('meta[name="description"]').content = b.description || b.title;
        document.getElementById('bc-title').textContent = b.title;

        const tagsHtml = (b.tags || []).map(t => `<span class="tag-pill" style="background:${esc(t.color)}22;color:${esc(t.color)}">${esc(t.name)}</span>`).join('');
        const tagsBlock = tagsHtml ? `<div class="book-tags">${tagsHtml}</div>` : '';

        let html;
        if (b.cover_key) {
          html = `
            <div class="book-header">
              <div class="book-header-with-cover">
                <img class="book-cover-img" src="/api/covers/${b.id}" alt="${esc(b.title)}">
                <div class="book-info">
                  <h2>${esc(b.title)}</h2>
                  ${b.author ? `<div class="author">ä½œè€…ï¼š${esc(b.author)}</div>` : ''}
                  ${b.description ? `<div class="desc">${esc(b.description)}</div>` : ''}
                  ${tagsBlock}
                </div>
              </div>
            </div>
          `;
        } else {
          html = `
            <div class="book-header">
              <h2>${esc(b.title)}</h2>
              ${b.author ? `<div class="author">ä½œè€…ï¼š${esc(b.author)}</div>` : ''}
              ${b.description ? `<div class="desc">${esc(b.description)}</div>` : ''}
              ${tagsBlock}
            </div>
          `;
        }
        if (chapters.length > 0) {
          html += `<div class="search-bar" style="margin-top:16px;margin-bottom:0"><input type="text" id="chapter-search" placeholder="æœç´¢ç« èŠ‚æ ‡é¢˜..." autocomplete="off"><button onclick="filterChapters()">æœç´¢</button></div>`;
        }
        if (chapters.length === 0) {
          html += '<div class="empty"><p>æš‚æ— ç« èŠ‚</p></div>';
        } else {
          html += '<ul class="chapter-list">' + chapters.map(c => `
            <li>
              <a href="/read.html?id=${c.id}">
                <span class="chapter-title">${esc(c.title)}</span>
                <span class="chapter-meta">${c.word_count} å­—</span>
              </a>
            </li>
          `).join('') + '</ul>';
          html += `<div style="margin-top:20px;text-align:center"><a href="#" id="export-link" style="font-size:13px;color:var(--text-light);text-decoration:none;border-bottom:1px dashed var(--text-light);padding-bottom:1px">å¯¼å‡ºå…¨ä¹¦ TXT</a></div>`;
        }

        // ä¹¦ç­¾åˆ—è¡¨
        const bookmarks = getBookmarks(bookId);
        if (bookmarks.length > 0) {
          html += `<div style="margin-top:24px"><h3 style="font-size:16px;margin-bottom:12px;color:var(--text)">ğŸ”– æˆ‘çš„ä¹¦ç­¾ï¼ˆ${bookmarks.length}ï¼‰</h3>`;
          html += '<ul class="chapter-list">' + bookmarks.sort((a,b) => b.time - a.time).map(bm => `
            <li>
              <a href="/read.html?id=${bm.chapterId}">
                <span class="chapter-title">${esc(bm.chapterTitle)}</span>
                <span class="chapter-meta">${formatTimeAgo(bm.time)}</span>
              </a>
            </li>
          `).join('') + '</ul></div>';
        }

        el.innerHTML = html;

        // å®‰å…¨ç»‘å®šå¯¼å‡ºäº‹ä»¶ï¼ˆé¿å…onclickä¸­æ‹¼æ¥å­—ç¬¦ä¸²ï¼‰
        const exportLink = document.getElementById('export-link');
        if (exportLink) {
          exportLink.addEventListener('click', (e) => { e.preventDefault(); exportBook(b.id, b.title, b.author); });
        }
      } catch (e) {
        el.innerHTML = `<div class="msg msg-error">${esc(e.message)}</div>`;
      }
    }
    function esc(s) { const d = document.createElement('div'); d.textContent = s || ''; return d.innerHTML; }

    function getBookmarks(bookId) {
      try { return JSON.parse(localStorage.getItem(`bookmarks_${bookId}`)) || []; }
      catch { return []; }
    }
    function formatTimeAgo(ts) {
      const diff = Date.now() - ts;
      const min = Math.floor(diff / 60000);
      if (min < 1) return 'åˆšåˆš';
      if (min < 60) return min + 'åˆ†é’Ÿå‰';
      const hr = Math.floor(min / 60);
      if (hr < 24) return hr + 'å°æ—¶å‰';
      return Math.floor(hr / 24) + 'å¤©å‰';
    }

    function filterChapters() {
      const input = document.getElementById('chapter-search');
      if (!input) return;
      const q = input.value.trim().toLowerCase();
      const listEl = document.querySelector('.chapter-list');
      if (!listEl) return;
      const filtered = q ? allChapters.filter(c => c.title.toLowerCase().includes(q)) : allChapters;
      if (filtered.length === 0) {
        listEl.innerHTML = '<li style="padding:16px;text-align:center;color:var(--text-light)">æ²¡æœ‰åŒ¹é…çš„ç« èŠ‚</li>';
      } else {
        listEl.innerHTML = filtered.map(c => `
          <li><a href="/read.html?id=${c.id}">
            <span class="chapter-title">${highlightMatch(esc(c.title), q)}</span>
            <span class="chapter-meta">${c.word_count} å­—</span>
          </a></li>
        `).join('');
      }
    }
    function highlightMatch(text, q) {
      if (!q) return text;
      const re = new RegExp(`(${q.replace(/[.*+?^${}()|[\]\\]/g,'\\$&')})`, 'gi');
      return text.replace(re, '<mark>$1</mark>');
    }
    // ç»‘å®šæœç´¢äº‹ä»¶ï¼ˆå»¶è¿Ÿç»‘å®šï¼Œç­‰DOMæ¸²æŸ“å®Œï¼‰
    setTimeout(() => {
      const searchInput = document.getElementById('chapter-search');
      if (searchInput) {
        searchInput.addEventListener('keydown', (e) => { if (e.key === 'Enter') filterChapters(); });
        searchInput.addEventListener('input', (e) => { if (!e.target.value.trim()) filterChapters(); });
      }
    }, 500);

    async function exportBook(bookId, title, author) {
      try {
        const res = await fetch(`/api/books/${bookId}`);
        const data = await res.json();
        const chapters = data.chapters || [];
        if (chapters.length === 0) return alert('æ²¡æœ‰ç« èŠ‚å¯å¯¼å‡º');
        const parts = [];
        for (const ch of chapters) {
          const r = await fetch(`/api/chapters/${ch.id}`);
          const d = await r.json();
          parts.push(ch.title + '\n\n' + d.content);
        }
        const sep = '\n\n' + '='.repeat(40) + '\n\n';
        const header = `ã€Š${title}ã€‹\n${author ? 'ä½œè€…ï¼š'+author+'\n' : ''}\n`;
        const BOM = '\uFEFF';
        const blob = new Blob([BOM + header + parts.join(sep)], {type:'text/plain;charset=utf-8'});
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = (title + (author ? '_'+author : '') + '.txt').replace(/[<>:"/\\|?*]/g,'_');
        a.click();
        URL.revokeObjectURL(url);
      } catch (e) { alert('å¯¼å‡ºå¤±è´¥ï¼š'+e.message); }
    }
  </script>
</body>
</html>
