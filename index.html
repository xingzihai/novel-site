<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>æˆ‘çš„ä¹¦æ¶</title>
  <meta name="description" content="æˆ‘çš„ç§äººå°è¯´ç«™ï¼Œé›¶æˆæœ¬æ­å»ºåœ¨ Cloudflare ä¸Š">
  <meta property="og:title" content="æˆ‘çš„ä¹¦æ¶">
  <meta property="og:description" content="ç§äººå°è¯´ç«™ï¼Œé›¶æˆæœ¬æ­å»ºåœ¨ Cloudflare ä¸Š">
  <link rel="stylesheet" href="/style.css">
</head>
<body>
  <div class="navbar">
    <h1><a href="/">ğŸ“š æˆ‘çš„ä¹¦æ¶</a></h1>
    <nav>
      <a href="https://github.com/xingzihai/novel-site" target="_blank" rel="noopener" title="GitHub">GitHub</a>
      <a href="/admin.html">ç®¡ç†</a>
      <button class="theme-toggle" onclick="toggleTheme()" title="åˆ‡æ¢ä¸»é¢˜">ğŸŒ™</button>
    </nav>
  </div>
  <div class="container">
    <div id="content" class="loading">åŠ è½½ä¸­...</div>
  </div>
  <script>
    // ä¸»é¢˜
    const savedTheme = localStorage.getItem('theme') || 'light';
    document.documentElement.setAttribute('data-theme', savedTheme);
    updateThemeBtn();
    function toggleTheme() {
      const current = document.documentElement.getAttribute('data-theme');
      const next = current === 'dark' ? 'light' : 'dark';
      document.documentElement.setAttribute('data-theme', next);
      localStorage.setItem('theme', next);
      updateThemeBtn();
    }
    function updateThemeBtn() {
      const btn = document.querySelector('.theme-toggle');
      btn.textContent = document.documentElement.getAttribute('data-theme') === 'dark' ? 'â˜€ï¸' : 'ğŸŒ™';
    }

    async function loadBooks() {
      const el = document.getElementById('content');
      try {
        const res = await fetch('/api/books');
        if (!res.ok) throw new Error('åŠ è½½å¤±è´¥');
        const data = await res.json();
        if (!data.books || data.books.length === 0) {
          el.innerHTML = '<div class="empty"><p>ğŸ“– ä¹¦æ¶ç©ºç©ºå¦‚ä¹Ÿ</p><p>å»<a href="/admin.html">ç®¡ç†åå°</a>æ·»åŠ ç¬¬ä¸€æœ¬ä¹¦å§</p></div>';
          return;
        }
        el.className = 'book-grid';
        el.innerHTML = data.books.map(b => `
          <a class="book-card" href="/book.html?id=${b.id}">
            <h3>${esc(b.title)}</h3>
            <div class="meta">
              ${b.author ? esc(b.author) + ' Â· ' : ''}${b.chapter_count} ç«  Â· ${formatWords(b.total_words)}
            </div>
            ${b.description ? `<div class="desc">${esc(b.description)}</div>` : ''}
          </a>
        `).join('');
      } catch (e) {
        el.innerHTML = `<div class="msg msg-error">åŠ è½½å¤±è´¥ï¼š${esc(e.message)}</div>`;
      }
    }
    function esc(s) { const d = document.createElement('div'); d.textContent = s || ''; return d.innerHTML; }
    function formatWords(n) {
      if (n >= 10000) return (n / 10000).toFixed(1) + ' ä¸‡å­—';
      return n + ' å­—';
    }
    loadBooks();

    // åŠ è½½ç«™ç‚¹è®¾ç½®
    fetch('/api/settings').then(r => r.json()).then(d => {
      const s = d.settings || {};
      if (s.site_name) {
        document.title = s.site_name;
        document.querySelector('.navbar h1 a').textContent = 'ğŸ“š ' + s.site_name;
        document.querySelector('meta[property="og:title"]').content = s.site_name;
      }
      if (s.site_desc) {
        document.querySelector('meta[name="description"]').content = s.site_desc;
        document.querySelector('meta[property="og:description"]').content = s.site_desc;
      }
    }).catch(() => {});
  </script>
</body>
</html>
