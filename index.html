<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>æˆ‘çš„ä¹¦æ¶</title>
  <meta name="description" content="æˆ‘çš„ç§äººå°è¯´ç«™ï¼Œé›¶æˆæœ¬æ­å»ºåœ¨ Cloudflare ä¸Š">
  <meta property="og:title" content="æˆ‘çš„ä¹¦æ¶">
  <meta property="og:description" content="ç§äººå°è¯´ç«™ï¼Œé›¶æˆæœ¬æ­å»ºåœ¨ Cloudflare ä¸Š">
  <link rel="stylesheet" href="/style.css">
</head>
<body>
  <div class="navbar">
    <h1><a href="/">ğŸ“š æˆ‘çš„ä¹¦æ¶</a></h1>
    <nav>
      <a href="https://github.com/xingzihai/novel-site" target="_blank" rel="noopener" title="GitHub">GitHub</a>
      <a href="/admin.html">ç®¡ç†</a>
      <button class="theme-toggle" onclick="toggleTheme()" title="åˆ‡æ¢ä¸»é¢˜">ğŸŒ™</button>
    </nav>
  </div>
  <div class="container">
    <div id="continue-reading"></div>
    <div class="search-bar">
      <input type="text" id="search-input" placeholder="æœç´¢ä¹¦åæˆ–ä½œè€…..." autocomplete="off">
      <button onclick="doSearch()">æœç´¢</button>
    </div>
    <div id="search-results" class="search-results" style="display:none"></div>
    <div id="content" class="loading">åŠ è½½ä¸­...</div>
  </div>
  <script>
    // ä¸»é¢˜
    const THEMES = ['light','dark','green','sepia','blue'];
    const THEME_ICONS = {'light':'ğŸŒ™','dark':'â˜€ï¸','green':'ğŸƒ','sepia':'ğŸ“œ','blue':'ğŸ’§'};
    const savedTheme = localStorage.getItem('theme') || 'light';
    document.documentElement.setAttribute('data-theme', savedTheme);
    updateThemeBtn();
    function toggleTheme() {
      const current = document.documentElement.getAttribute('data-theme');
      const idx = THEMES.indexOf(current);
      const next = THEMES[(idx + 1) % THEMES.length];
      document.documentElement.setAttribute('data-theme', next);
      localStorage.setItem('theme', next);
      updateThemeBtn();
    }
    function updateThemeBtn() {
      const btn = document.querySelector('.theme-toggle');
      const t = document.documentElement.getAttribute('data-theme');
      btn.textContent = THEME_ICONS[t] || 'ğŸŒ™';
    }

    // ç»§ç»­é˜…è¯»
    function renderContinueReading() {
      const container = document.getElementById('continue-reading');
      const entries = [];
      for (let i = 0; i < localStorage.length; i++) {
        const key = localStorage.key(i);
        if (!key.startsWith('reading_')) continue;
        try {
          const data = JSON.parse(localStorage.getItem(key));
          if (data && data.chapterId && data.time) entries.push(data);
        } catch {}
      }
      if (entries.length === 0) { container.innerHTML = ''; return; }
      entries.sort((a, b) => b.time - a.time);
      const latest = entries[0];
      const timeAgo = formatTimeAgo(latest.time);
      container.innerHTML = `
        <a class="continue-reading" href="/read.html?id=${latest.chapterId}">
          <div class="continue-info">
            <div class="continue-label">ç»§ç»­é˜…è¯»</div>
            <div class="continue-title">${esc(latest.bookTitle || 'æœªçŸ¥ä¹¦ç±')}</div>
            <div class="continue-chapter">${esc(latest.chapterTitle || '')} Â· ${timeAgo}</div>
          </div>
          <div class="continue-arrow">â†’</div>
        </a>
      `;
    }
    function formatTimeAgo(ts) {
      const diff = Date.now() - ts;
      const min = Math.floor(diff / 60000);
      if (min < 1) return 'åˆšåˆš';
      if (min < 60) return min + 'åˆ†é’Ÿå‰';
      const hr = Math.floor(min / 60);
      if (hr < 24) return hr + 'å°æ—¶å‰';
      const day = Math.floor(hr / 24);
      return day + 'å¤©å‰';
    }

    // æœç´¢
    let allBooks = [];
    function doSearch() {
      const q = document.getElementById('search-input').value.trim().toLowerCase();
      const resultsEl = document.getElementById('search-results');
      const contentEl = document.getElementById('content');
      if (!q) {
        resultsEl.style.display = 'none';
        contentEl.style.display = '';
        return;
      }
      const matched = allBooks.filter(b =>
        (b.title || '').toLowerCase().includes(q) ||
        (b.author || '').toLowerCase().includes(q)
      );
      if (matched.length === 0) {
        resultsEl.innerHTML = '<div style="padding:16px;color:var(--text-light);text-align:center">æ²¡æœ‰æ‰¾åˆ°åŒ¹é…çš„ä¹¦ç±</div>';
      } else {
        resultsEl.innerHTML = matched.map(b => `
          <a class="result-item" href="/book.html?id=${b.id}">
            <div class="result-title">${highlightMatch(esc(b.title), q)}</div>
            <div class="result-book">${b.author ? highlightMatch(esc(b.author), q) + ' Â· ' : ''}${b.chapter_count}ç«  Â· ${formatWords(b.total_words)}</div>
          </a>
        `).join('');
      }
      resultsEl.style.display = '';
      contentEl.style.display = 'none';
    }
    function highlightMatch(text, q) {
      if (!q) return text;
      const re = new RegExp(`(${q.replace(/[.*+?^${}()|[\]\\]/g,'\\$&')})`, 'gi');
      return text.replace(re, '<mark>$1</mark>');
    }
    document.getElementById('search-input').addEventListener('keydown', (e) => {
      if (e.key === 'Enter') doSearch();
    });
    document.getElementById('search-input').addEventListener('input', (e) => {
      if (!e.target.value.trim()) {
        document.getElementById('search-results').style.display = 'none';
        document.getElementById('content').style.display = '';
      }
    });

    async function loadBooks() {
      const el = document.getElementById('content');
      try {
        const res = await fetch('/api/books');
        if (!res.ok) throw new Error('åŠ è½½å¤±è´¥');
        const data = await res.json();
        allBooks = data.books || [];
        renderContinueReading();
        if (allBooks.length === 0) {
          el.innerHTML = '<div class="empty"><p>ğŸ“– ä¹¦æ¶ç©ºç©ºå¦‚ä¹Ÿ</p><p>å»<a href="/admin.html">ç®¡ç†åå°</a>æ·»åŠ ç¬¬ä¸€æœ¬ä¹¦å§</p></div>';
          return;
        }
        el.className = 'book-grid';
        el.innerHTML = allBooks.map(b => `
          <a class="book-card" href="/book.html?id=${b.id}">
            <h3>${esc(b.title)}</h3>
            <div class="meta">
              ${b.author ? esc(b.author) + ' Â· ' : ''}${b.chapter_count} ç«  Â· ${formatWords(b.total_words)}
            </div>
            ${b.description ? `<div class="desc">${esc(b.description)}</div>` : ''}
          </a>
        `).join('');
      } catch (e) {
        el.innerHTML = `<div class="msg msg-error">åŠ è½½å¤±è´¥ï¼š${esc(e.message)}</div>`;
      }
    }
    function esc(s) { const d = document.createElement('div'); d.textContent = s || ''; return d.innerHTML; }
    function formatWords(n) {
      if (n >= 10000) return (n / 10000).toFixed(1) + ' ä¸‡å­—';
      return n + ' å­—';
    }
    loadBooks();

    // åŠ è½½ç«™ç‚¹è®¾ç½®
    fetch('/api/settings').then(r => r.json()).then(d => {
      const s = d.settings || {};
      if (s.site_name) {
        document.title = s.site_name;
        document.querySelector('.navbar h1 a').textContent = 'ğŸ“š ' + s.site_name;
        document.querySelector('meta[property="og:title"]').content = s.site_name;
      }
      if (s.site_desc) {
        document.querySelector('meta[name="description"]').content = s.site_desc;
        document.querySelector('meta[property="og:description"]').content = s.site_desc;
      }
    }).catch(() => {});
  </script>
</body>
</html>
