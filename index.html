<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>æˆ‘çš„ä¹¦æ¶</title>
  <meta name="description" content="æˆ‘çš„ç§äººå°è¯´ç«™ï¼Œé›¶æˆæœ¬æ­å»ºåœ¨ Cloudflare ä¸Š">
  <meta property="og:title" content="æˆ‘çš„ä¹¦æ¶">
  <meta property="og:description" content="ç§äººå°è¯´ç«™ï¼Œé›¶æˆæœ¬æ­å»ºåœ¨ Cloudflare ä¸Š">
  <link rel="stylesheet" href="/style.css">
  <link rel="manifest" href="/manifest.json">
  <meta name="theme-color" content="#d4a574">
</head>
<body>
  <div class="navbar">
    <h1><a href="/">ğŸ“š æˆ‘çš„ä¹¦æ¶</a></h1>
    <nav>
      <a href="https://github.com/xingzihai/novel-site" target="_blank" rel="noopener" title="GitHub">GitHub</a>
      <a href="/admin.html" id="nav-admin">ç®¡ç†</a>
      <button class="theme-toggle" onclick="toggleTheme()" title="åˆ‡æ¢ä¸»é¢˜">ğŸŒ™</button>
    </nav>
  </div>
  <div class="container">
    <div id="continue-reading"></div>
    <div id="reading-stats"></div>
    <div id="tag-filter"></div>
    <div class="search-bar">
      <input type="text" id="search-input" placeholder="æœç´¢ä¹¦åæˆ–ä½œè€…..." autocomplete="off">
      <button onclick="doSearch()">æœç´¢</button>
    </div>
    <div id="search-results" class="search-results" style="display:none"></div>
    <div id="content" class="loading">åŠ è½½ä¸­...</div>
  </div>
  <script>
    // ä¸»é¢˜
    const THEMES = ['light','dark','green','sepia','blue'];
    const THEME_ICONS = {'light':'ğŸŒ™','dark':'â˜€ï¸','green':'ğŸƒ','sepia':'ğŸ“œ','blue':'ğŸ’§'};
    const savedTheme = localStorage.getItem('theme') || 'light';
    document.documentElement.setAttribute('data-theme', savedTheme);
    updateThemeBtn();
    function toggleTheme() {
      const current = document.documentElement.getAttribute('data-theme');
      const idx = THEMES.indexOf(current);
      const next = THEMES[(idx + 1) % THEMES.length];
      document.documentElement.setAttribute('data-theme', next);
      localStorage.setItem('theme', next);
      updateThemeBtn();
    }
    function updateThemeBtn() {
      const btn = document.querySelector('.theme-toggle');
      const t = document.documentElement.getAttribute('data-theme');
      btn.textContent = THEME_ICONS[t] || 'ğŸŒ™';
    }

    // ç”¨æˆ·çŠ¶æ€ï¼šç™»å½•åæ›¿æ¢"ç®¡ç†"ä¸ºè§’è‰²+ç”¨æˆ·å
    (async function renderUserStatus() {
      const adminLink = document.getElementById('nav-admin');
      try {
        const res = await fetch('/api/me', { credentials: 'same-origin' });
        if (res.ok) {
          const user = await res.json();
          const roleMap = {
            'super_admin': { label: 'è¶…ç®¡', cls: 'super' },
            'admin': { label: 'ç®¡ç†', cls: 'admin' },
            'demo': { label: 'ç”¨æˆ·', cls: 'demo' }
          };
          const r = roleMap[user.role] || { label: 'ç”¨æˆ·', cls: 'demo' };
          adminLink.innerHTML = `<span class="role-badge ${r.cls}">${r.label}</span> ${user.username || ''} <a href="#" onclick="doLogout();return false" style="font-size:12px;color:#e74c3c;margin-left:6px">é€€å‡º</a>`;
        }
      } catch {}
    })();

    async function doLogout() {
      try { await fetch('/api/auth/logout', { method: 'POST', credentials: 'same-origin' }); } catch {}
      location.reload();
    }

    // ç»§ç»­é˜…è¯»
    function renderContinueReading() {
      const container = document.getElementById('continue-reading');
      const entries = [];
      for (let i = 0; i < localStorage.length; i++) {
        const key = localStorage.key(i);
        if (!key.startsWith('reading_')) continue;
        try {
          const data = JSON.parse(localStorage.getItem(key));
          if (data && data.chapterId && data.time) entries.push(data);
        } catch {}
      }
      if (entries.length === 0) { container.innerHTML = ''; return; }
      entries.sort((a, b) => b.time - a.time);
      const latest = entries[0];
      const timeAgo = formatTimeAgo(latest.time);
      container.innerHTML = `
        <a class="continue-reading" href="/read.html?id=${latest.chapterId}">
          <div class="continue-info">
            <div class="continue-label">ç»§ç»­é˜…è¯»</div>
            <div class="continue-title">${esc(latest.bookTitle || 'æœªçŸ¥ä¹¦ç±')}</div>
            <div class="continue-chapter">${esc(latest.chapterTitle || '')} Â· ${timeAgo}</div>
          </div>
          <div class="continue-arrow">â†’</div>
        </a>
      `;
    }
    function renderReadingStats() {
      const container = document.getElementById('reading-stats');
      try {
        const stats = JSON.parse(localStorage.getItem('readingStats'));
        if (!stats || (stats.totalSeconds === 0 && stats.totalChars === 0)) {
          container.innerHTML = '';
          return;
        }
        const hours = (stats.totalSeconds / 3600).toFixed(1);
        const wanChars = (stats.totalChars / 10000).toFixed(1);
        const days = (stats.days || []).length;
        container.innerHTML = `<div style="text-align:center;padding:8px 0;font-size:13px;color:var(--text-light)">å·²è¯» ${hours} å°æ—¶ Â· ${wanChars} ä¸‡å­— Â· ç´¯è®¡ ${days} å¤©</div>`;
      } catch {
        container.innerHTML = '';
      }
    }
    function formatTimeAgo(ts) {
      const diff = Date.now() - ts;
      const min = Math.floor(diff / 60000);
      if (min < 1) return 'åˆšåˆš';
      if (min < 60) return min + 'åˆ†é’Ÿå‰';
      const hr = Math.floor(min / 60);
      if (hr < 24) return hr + 'å°æ—¶å‰';
      const day = Math.floor(hr / 24);
      return day + 'å¤©å‰';
    }

    // æœç´¢
    let allBooks = [];
    let allTags = [];
    let activeTagId = null;

    function doSearch() {
      const q = document.getElementById('search-input').value.trim().toLowerCase();
      const resultsEl = document.getElementById('search-results');
      const contentEl = document.getElementById('content');
      if (!q) {
        resultsEl.style.display = 'none';
        contentEl.style.display = '';
        return;
      }
      const matched = allBooks.filter(b =>
        (b.title || '').toLowerCase().includes(q) ||
        (b.author || '').toLowerCase().includes(q)
      );
      if (matched.length === 0) {
        resultsEl.innerHTML = '<div style="padding:16px;color:var(--text-light);text-align:center">æ²¡æœ‰æ‰¾åˆ°åŒ¹é…çš„ä¹¦ç±</div>';
      } else {
        resultsEl.innerHTML = matched.map(b => `
          <a class="result-item" href="/book.html?id=${b.id}">
            <div class="result-title">${highlightMatch(esc(b.title), q)}</div>
            <div class="result-book">${b.author ? highlightMatch(esc(b.author), q) + ' Â· ' : ''}${b.chapter_count}ç«  Â· ${formatWords(b.total_words)}</div>
          </a>
        `).join('');
      }
      resultsEl.style.display = '';
      contentEl.style.display = 'none';
    }
    function highlightMatch(text, q) {
      if (!q) return text;
      const re = new RegExp(`(${q.replace(/[.*+?^${}()|[\]\\]/g,'\\$&')})`, 'gi');
      return text.replace(re, '<mark>$1</mark>');
    }
    document.getElementById('search-input').addEventListener('keydown', (e) => {
      if (e.key === 'Enter') doSearch();
    });
    document.getElementById('search-input').addEventListener('input', (e) => {
      if (!e.target.value.trim()) {
        document.getElementById('search-results').style.display = 'none';
        document.getElementById('content').style.display = '';
      }
    });

    async function loadBooks() {
      const el = document.getElementById('content');
      try {
        const [booksRes, tagsRes] = await Promise.all([
          fetch('/api/books'),
          fetch('/api/tags').catch(() => ({ json: () => ({ tags: [] }) }))
        ]);
        const booksData = await booksRes.json();
        if (!booksRes.ok) throw new Error('åŠ è½½å¤±è´¥');
        allBooks = booksData.books || [];

        try { allTags = (await tagsRes.json()).tags || []; } catch { allTags = []; }
        renderTagFilter();

        renderContinueReading();
        renderReadingStats();
        renderBooks(allBooks);
      } catch (e) {
        el.innerHTML = `<div class="msg msg-error">åŠ è½½å¤±è´¥ï¼š${esc(e.message)}</div>`;
      }
    }

    function renderTagFilter() {
      const container = document.getElementById('tag-filter');
      if (allTags.length === 0) { container.innerHTML = ''; return; }
      container.innerHTML = '<div class="tag-filter-bar" id="tag-bar"></div>';
      const bar = document.getElementById('tag-bar');
      const allPill = document.createElement('span');
      allPill.className = 'tag-pill' + (activeTagId === null ? ' active' : '');
      allPill.textContent = 'å…¨éƒ¨';
      allPill.style.background = 'var(--bg)'; allPill.style.color = 'var(--text)';
      allPill.style.border = '1px solid var(--border)';
      bar.appendChild(allPill);
      for (const tag of allTags) {
        const pill = document.createElement('span');
        pill.className = 'tag-pill' + (activeTagId === tag.id ? ' active' : '');
        pill.textContent = tag.name;
        pill.style.background = tag.color + '22'; pill.style.color = tag.color;
        pill.dataset.tagId = tag.id;
        bar.appendChild(pill);
      }
      bar.addEventListener('click', (e) => {
        const pill = e.target.closest('.tag-pill');
        if (!pill) return;
        const tagId = pill.dataset.tagId ? Number(pill.dataset.tagId) : null;
        activeTagId = tagId;
        renderTagFilter();
        filterAndRenderBooks();
      });
    }

    function filterAndRenderBooks() {
      let filtered = allBooks;
      if (activeTagId !== null) {
        filtered = allBooks.filter(b => (b.tags || []).some(t => t.id === activeTagId));
      }
      renderBooks(filtered);
    }

    // å°é¢é¢œè‰²ç”Ÿæˆ
    const COVER_COLORS = ['#e74c3c','#e67e22','#f1c40f','#2ecc71','#1abc9c','#3498db','#9b59b6','#e91e63','#00bcd4','#ff5722'];
    function coverColor(title) { let h = 0; for (let i = 0; i < (title||'').length; i++) h = ((h << 5) - h + title.charCodeAt(i)) | 0; return COVER_COLORS[Math.abs(h) % COVER_COLORS.length]; }

    function renderBooks(books) {
      const el = document.getElementById('content');
      if (books.length === 0) {
        if (allBooks.length === 0) {
          el.className = '';
          el.innerHTML = '<div class="empty"><p>ğŸ“– ä¹¦æ¶ç©ºç©ºå¦‚ä¹Ÿ</p><p>å»<a href="/admin.html">ç®¡ç†åå°</a>æ·»åŠ ç¬¬ä¸€æœ¬ä¹¦å§</p></div>';
        } else {
          el.className = '';
          el.innerHTML = '<div class="empty"><p>æ²¡æœ‰åŒ¹é…çš„ä¹¦ç±</p></div>';
        }
        return;
      }
      el.className = 'book-grid-cover';
      el.innerHTML = books.map(b => {
        const tagsHtml = (b.tags || []).map(t => `<span class="tag-pill" style="background:${esc(t.color)}22;color:${esc(t.color)}">${esc(t.name)}</span>`).join('');
        if (b.cover_key) {
          return `<a class="book-card-cover" href="/book.html?id=${b.id}">
            <img class="cover-img" src="/api/covers/${b.id}" alt="${esc(b.title)}" loading="lazy">
            <div class="card-body">
              <h3>${esc(b.title)}</h3>
              <div class="meta">${b.author ? esc(b.author) + ' Â· ' : ''}${b.chapter_count}ç« </div>
              ${tagsHtml ? '<div class="card-tags">' + tagsHtml + '</div>' : ''}
            </div>
          </a>`;
        } else {
          const color = coverColor(b.title);
          const firstChar = (b.title || '?')[0];
          return `<a class="book-card-cover" href="/book.html?id=${b.id}">
            <div class="cover-placeholder" style="background:${color}">${esc(firstChar)}</div>
            <div class="card-body">
              <h3>${esc(b.title)}</h3>
              <div class="meta">${b.author ? esc(b.author) + ' Â· ' : ''}${b.chapter_count}ç« </div>
              ${tagsHtml ? '<div class="card-tags">' + tagsHtml + '</div>' : ''}
            </div>
          </a>`;
        }
      }).join('');
    }
    function esc(s) { const d = document.createElement('div'); d.textContent = s || ''; return d.innerHTML; }
    function formatWords(n) {
      if (n >= 10000) return (n / 10000).toFixed(1) + ' ä¸‡å­—';
      return n + ' å­—';
    }
    loadBooks();

    // PWA Service Worker
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('/sw.js').catch(() => {});
    }

    // åŠ è½½ç«™ç‚¹è®¾ç½®
    fetch('/api/settings').then(r => r.json()).then(d => {
      const s = d.settings || {};
      if (s.site_name) {
        document.title = s.site_name;
        document.querySelector('.navbar h1 a').textContent = 'ğŸ“š ' + s.site_name;
        document.querySelector('meta[property="og:title"]').content = s.site_name;
      }
      if (s.site_desc) {
        document.querySelector('meta[name="description"]').content = s.site_desc;
        document.querySelector('meta[property="og:description"]').content = s.site_desc;
      }
    }).catch(() => {});
  </script>
</body>
</html>
